
<!-- saved from url=(0036)http://test.xapient.net/phaser/attm/ -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"></head><body><div class="line-gutter-backdrop"></div><table><tbody><tr><td class="line-number" value="1"></td><td class="line-content"><span class="html-tag">&lt;doctype <span class="html-attribute-name">html</span>&gt;</span></td></tr><tr><td class="line-number" value="2"></td><td class="line-content">    <span class="html-tag">&lt;html&gt;</span></td></tr><tr><td class="line-number" value="3"></td><td class="line-content">    <span class="html-tag">&lt;head&gt;</span></td></tr><tr><td class="line-number" value="4"></td><td class="line-content">        <span class="html-tag">&lt;meta <span class="html-attribute-name">charset</span>="<span class="html-attribute-value">utf-8</span>"&gt;</span></td></tr><tr><td class="line-number" value="5"></td><td class="line-content">        <span class="html-tag">&lt;meta <span class="html-attribute-name">http-equiv</span>="<span class="html-attribute-value">X-UA-Compatible</span>" <span class="html-attribute-name">content</span>="<span class="html-attribute-value">chrome=1, IE=9</span>"&gt;</span></td></tr><tr><td class="line-number" value="6"></td><td class="line-content">        <span class="html-tag">&lt;meta <span class="html-attribute-name">name</span>="<span class="html-attribute-value">viewport</span>" <span class="html-attribute-name">content</span>="<span class="html-attribute-value">initial-scale=1 maximum-scale=1 user-scalable=0</span>" /&gt;</span></td></tr><tr><td class="line-number" value="7"></td><td class="line-content">        <span class="html-tag">&lt;meta <span class="html-attribute-name">name</span>="<span class="html-attribute-value">format-detection</span>" <span class="html-attribute-name">content</span>="<span class="html-attribute-value">telephone=no</span>"&gt;</span></td></tr><tr><td class="line-number" value="8"></td><td class="line-content">        <span class="html-tag">&lt;meta <span class="html-attribute-name">name</span>="<span class="html-attribute-value">HandheldFriendly</span>" <span class="html-attribute-name">content</span>="<span class="html-attribute-value">true</span>" /&gt;</span></td></tr><tr><td class="line-number" value="9"></td><td class="line-content">        <span class="html-tag">&lt;meta <span class="html-attribute-name">name</span>="<span class="html-attribute-value">robots</span>" <span class="html-attribute-name">content</span>="<span class="html-attribute-value">noindex,nofollow</span>" /&gt;</span></td></tr><tr><td class="line-number" value="10"></td><td class="line-content">        <span class="html-tag">&lt;meta <span class="html-attribute-name">name</span>="<span class="html-attribute-value">apple-mobile-web-app-capable</span>" <span class="html-attribute-name">content</span>="<span class="html-attribute-value">yes</span>" /&gt;</span></td></tr><tr><td class="line-number" value="11"></td><td class="line-content">        <span class="html-tag">&lt;meta <span class="html-attribute-name">name</span>="<span class="html-attribute-value">apple-mobile-web-app-status-bar-style</span>" <span class="html-attribute-name">content</span>="<span class="html-attribute-value">black</span>" /&gt;</span></td></tr><tr><td class="line-number" value="12"></td><td class="line-content">        <span class="html-tag">&lt;meta <span class="html-attribute-name">name</span>="<span class="html-attribute-value">apple-mobile-web-app-title</span>" <span class="html-attribute-name">content</span>="<span class="html-attribute-value">Phaser App</span>"&gt;</span></td></tr><tr><td class="line-number" value="13"></td><td class="line-content">        <span class="html-tag">&lt;title&gt;</span>A tribute to Mario<span class="html-tag">&lt;/title&gt;</span></td></tr><tr><td class="line-number" value="14"></td><td class="line-content">        <span class="html-tag">&lt;style&gt;</span></td></tr><tr><td class="line-number" value="15"></td><td class="line-content">            body {</td></tr><tr><td class="line-number" value="16"></td><td class="line-content">                margin: 0px 0px 1px 0px; /* the extra 1px allows the iOS inner/outer check to work */</td></tr><tr><td class="line-number" value="17"></td><td class="line-content">                background-color:#333;</td></tr><tr><td class="line-number" value="18"></td><td class="line-content">            }</td></tr><tr><td class="line-number" value="19"></td><td class="line-content">        <span class="html-tag">&lt;/style&gt;</span></td></tr><tr><td class="line-number" value="20"></td><td class="line-content">        <span class="html-tag">&lt;script <span class="html-attribute-name">src</span>="<a class="html-attribute-value html-resource-link" target="_blank" href="http://test.xapient.net/phaser/attm/phaser.js">phaser.js</a>"&gt;</span><span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="21"></td><td class="line-content">    <span class="html-tag">&lt;/head&gt;</span></td></tr><tr><td class="line-number" value="22"></td><td class="line-content"><span class="html-tag">&lt;body&gt;</span></td></tr><tr><td class="line-number" value="23"></td><td class="line-content"><span class="html-tag">&lt;div <span class="html-attribute-name">id</span>=<span class="html-attribute-value">gamediv</span>&gt;</span><span class="html-tag">&lt;/div&gt;</span></td></tr><tr><td class="line-number" value="24"></td><td class="line-content"><span class="html-tag">&lt;script <span class="html-attribute-name">type</span>="<span class="html-attribute-value">text/javascript</span>"&gt;</span></td></tr><tr><td class="line-number" value="25"></td><td class="line-content"></td></tr><tr><td class="line-number" value="26"></td><td class="line-content">//some variables</td></tr><tr><td class="line-number" value="27"></td><td class="line-content">var level = 0;  //change this to start in a different level</td></tr><tr><td class="line-number" value="28"></td><td class="line-content">var levels = 7;  // 0, 1, 2 ,3, 4 ,5, 6  Don't forget to change this! (and add the state)</td></tr><tr><td class="line-number" value="29"></td><td class="line-content">var player_health=1;  //lowest level is 1  - don't set to 3 without a gun (fireflower)</td></tr><tr><td class="line-number" value="30"></td><td class="line-content">var weapon_selected = 'sword';  //fireflower, sword</td></tr><tr><td class="line-number" value="31"></td><td class="line-content">//var weapon_selected = 'fireflower';  //fireflower, sword</td></tr><tr><td class="line-number" value="32"></td><td class="line-content">var player_chain=false; </td></tr><tr><td class="line-number" value="33"></td><td class="line-content">var player_lives=3;</td></tr><tr><td class="line-number" value="34"></td><td class="line-content">var player_lives_reset=3;</td></tr><tr><td class="line-number" value="35"></td><td class="line-content">var player_speed=300;</td></tr><tr><td class="line-number" value="36"></td><td class="line-content">var air_friction=300;</td></tr><tr><td class="line-number" value="37"></td><td class="line-content">var score=0;</td></tr><tr><td class="line-number" value="38"></td><td class="line-content">var fireRate = 200;</td></tr><tr><td class="line-number" value="39"></td><td class="line-content">var gamestate='running';</td></tr><tr><td class="line-number" value="40"></td><td class="line-content">var playerstate='idle';</td></tr><tr><td class="line-number" value="41"></td><td class="line-content">var savepointX = 0;</td></tr><tr><td class="line-number" value="42"></td><td class="line-content">var savepointY = 0;</td></tr><tr><td class="line-number" value="43"></td><td class="line-content">var saved = false;</td></tr><tr><td class="line-number" value="44"></td><td class="line-content"></td></tr><tr><td class="line-number" value="45"></td><td class="line-content"></td></tr><tr><td class="line-number" value="46"></td><td class="line-content">var worldwidth=800;</td></tr><tr><td class="line-number" value="47"></td><td class="line-content">var worldheight=480;</td></tr><tr><td class="line-number" value="48"></td><td class="line-content"></td></tr><tr><td class="line-number" value="49"></td><td class="line-content">var music;</td></tr><tr><td class="line-number" value="50"></td><td class="line-content">var map;</td></tr><tr><td class="line-number" value="51"></td><td class="line-content">var sword;</td></tr><tr><td class="line-number" value="52"></td><td class="line-content">var gun1;</td></tr><tr><td class="line-number" value="53"></td><td class="line-content">var weaponangle;</td></tr><tr><td class="line-number" value="54"></td><td class="line-content">var bullet;</td></tr><tr><td class="line-number" value="55"></td><td class="line-content">var tileset;</td></tr><tr><td class="line-number" value="56"></td><td class="line-content">var finishline;</td></tr><tr><td class="line-number" value="57"></td><td class="line-content">var cursors;</td></tr><tr><td class="line-number" value="58"></td><td class="line-content">var player=null;</td></tr><tr><td class="line-number" value="59"></td><td class="line-content">var playershape;</td></tr><tr><td class="line-number" value="60"></td><td class="line-content">var fireballs;</td></tr><tr><td class="line-number" value="61"></td><td class="line-content">var enemies;</td></tr><tr><td class="line-number" value="62"></td><td class="line-content">var nextFire = 0;</td></tr><tr><td class="line-number" value="63"></td><td class="line-content">var jumptimer = 0;</td></tr><tr><td class="line-number" value="64"></td><td class="line-content">var jumpHeightCounter = 0;</td></tr><tr><td class="line-number" value="65"></td><td class="line-content">var jumpspeedx = 0;  // this is for jumping of a chain</td></tr><tr><td class="line-number" value="66"></td><td class="line-content">var timer=0;</td></tr><tr><td class="line-number" value="67"></td><td class="line-content">var invincibleTimer = 0;</td></tr><tr><td class="line-number" value="68"></td><td class="line-content"></td></tr><tr><td class="line-number" value="69"></td><td class="line-content">var buttongroup;</td></tr><tr><td class="line-number" value="70"></td><td class="line-content">var left=false;</td></tr><tr><td class="line-number" value="71"></td><td class="line-content">var right=false;</td></tr><tr><td class="line-number" value="72"></td><td class="line-content">var fire=false;</td></tr><tr><td class="line-number" value="73"></td><td class="line-content">var anchorfire=false;</td></tr><tr><td class="line-number" value="74"></td><td class="line-content">var jump=false;   </td></tr><tr><td class="line-number" value="75"></td><td class="line-content">var duck=false;</td></tr><tr><td class="line-number" value="76"></td><td class="line-content">var climb=false;</td></tr><tr><td class="line-number" value="77"></td><td class="line-content"></td></tr><tr><td class="line-number" value="78"></td><td class="line-content">var hitboxchanged = false;</td></tr><tr><td class="line-number" value="79"></td><td class="line-content">var climbing=false;</td></tr><tr><td class="line-number" value="80"></td><td class="line-content">var hanging=false;</td></tr><tr><td class="line-number" value="81"></td><td class="line-content">var onAir = false;  //stores if player is on ground or in the air</td></tr><tr><td class="line-number" value="82"></td><td class="line-content"></td></tr><tr><td class="line-number" value="83"></td><td class="line-content">var hangTimer=0;</td></tr><tr><td class="line-number" value="84"></td><td class="line-content">var chainElement;</td></tr><tr><td class="line-number" value="85"></td><td class="line-content">var timerEvents=[];</td></tr><tr><td class="line-number" value="86"></td><td class="line-content"></td></tr><tr><td class="line-number" value="87"></td><td class="line-content">// anchor vars</td></tr><tr><td class="line-number" value="88"></td><td class="line-content"></td></tr><tr><td class="line-number" value="89"></td><td class="line-content">var chainAnchor;</td></tr><tr><td class="line-number" value="90"></td><td class="line-content">var wallAnchor;</td></tr><tr><td class="line-number" value="91"></td><td class="line-content">var lastElement;</td></tr><tr><td class="line-number" value="92"></td><td class="line-content">var anchorgroup;</td></tr><tr><td class="line-number" value="93"></td><td class="line-content"></td></tr><tr><td class="line-number" value="94"></td><td class="line-content">var gameobjects;</td></tr><tr><td class="line-number" value="95"></td><td class="line-content">var textobjects;</td></tr><tr><td class="line-number" value="96"></td><td class="line-content">var controls;</td></tr><tr><td class="line-number" value="97"></td><td class="line-content"></td></tr><tr><td class="line-number" value="98"></td><td class="line-content">var sensor;</td></tr><tr><td class="line-number" value="99"></td><td class="line-content">var sensorX;</td></tr><tr><td class="line-number" value="100"></td><td class="line-content">var sensorY;</td></tr><tr><td class="line-number" value="101"></td><td class="line-content">var sensorexists = false;</td></tr><tr><td class="line-number" value="102"></td><td class="line-content">var sensorAngle;</td></tr><tr><td class="line-number" value="103"></td><td class="line-content"></td></tr><tr><td class="line-number" value="104"></td><td class="line-content">var constraints= [];</td></tr><tr><td class="line-number" value="105"></td><td class="line-content">var accelerate = false;</td></tr><tr><td class="line-number" value="106"></td><td class="line-content">var docked= false;</td></tr><tr><td class="line-number" value="107"></td><td class="line-content"></td></tr><tr><td class="line-number" value="108"></td><td class="line-content">var chainMaxLength = 550;</td></tr><tr><td class="line-number" value="109"></td><td class="line-content">var flightDistance = 0;</td></tr><tr><td class="line-number" value="110"></td><td class="line-content">var sensorDistance = 0;</td></tr><tr><td class="line-number" value="111"></td><td class="line-content">var chainSectionCount = 0;</td></tr><tr><td class="line-number" value="112"></td><td class="line-content">var chainMaxSections = 20;</td></tr><tr><td class="line-number" value="113"></td><td class="line-content">var chainLength = 0;</td></tr><tr><td class="line-number" value="114"></td><td class="line-content">var formerMouse = -1;</td></tr><tr><td class="line-number" value="115"></td><td class="line-content">var playerChainRC =false;</td></tr><tr><td class="line-number" value="116"></td><td class="line-content">var objectAbove = false;</td></tr><tr><td class="line-number" value="117"></td><td class="line-content"></td></tr><tr><td class="line-number" value="118"></td><td class="line-content">var BootState = {</td></tr><tr><td class="line-number" value="119"></td><td class="line-content">    preload: function() {</td></tr><tr><td class="line-number" value="120"></td><td class="line-content">        game.load.image('preloadbar', 'assets/preloadbar.png');</td></tr><tr><td class="line-number" value="121"></td><td class="line-content">        game.load.image('orientation', 'assets/orientation.jpg');</td></tr><tr><td class="line-number" value="122"></td><td class="line-content"></td></tr><tr><td class="line-number" value="123"></td><td class="line-content">    },</td></tr><tr><td class="line-number" value="124"></td><td class="line-content">    create: function() {</td></tr><tr><td class="line-number" value="125"></td><td class="line-content">        if (game.device.desktop){</td></tr><tr><td class="line-number" value="126"></td><td class="line-content">             game.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;</td></tr><tr><td class="line-number" value="127"></td><td class="line-content">             game.scale.maxWidth = 800;</td></tr><tr><td class="line-number" value="128"></td><td class="line-content">             game.scale.maxHeight = 480;</td></tr><tr><td class="line-number" value="129"></td><td class="line-content">             game.scale.pageAlignHorizontally = true;</td></tr><tr><td class="line-number" value="130"></td><td class="line-content">             game.scale.pageAlignVertically = true;</td></tr><tr><td class="line-number" value="131"></td><td class="line-content">             game.scale.setScreenSize(true);</td></tr><tr><td class="line-number" value="132"></td><td class="line-content">         }</td></tr><tr><td class="line-number" value="133"></td><td class="line-content">         else{  </td></tr><tr><td class="line-number" value="134"></td><td class="line-content">             game.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;</td></tr><tr><td class="line-number" value="135"></td><td class="line-content">             game.scale.minWidth = 400;</td></tr><tr><td class="line-number" value="136"></td><td class="line-content">             game.scale.minHeight = 300;</td></tr><tr><td class="line-number" value="137"></td><td class="line-content">             game.scale.maxWidth = 1024;</td></tr><tr><td class="line-number" value="138"></td><td class="line-content">             game.scale.maxHeight = 768;</td></tr><tr><td class="line-number" value="139"></td><td class="line-content">             game.scale.pageAlignHorizontally = true;</td></tr><tr><td class="line-number" value="140"></td><td class="line-content">             game.scale.pageAlignVertically = true;</td></tr><tr><td class="line-number" value="141"></td><td class="line-content">             game.scale.forceOrientation(true, false,'orientation'); //landscape, portrait, incorrectorientation image</td></tr><tr><td class="line-number" value="142"></td><td class="line-content">             game.scale.enterIncorrectOrientation.add(enterIncorrectOrientation);</td></tr><tr><td class="line-number" value="143"></td><td class="line-content">             game.scale.leaveIncorrectOrientation.add(leaveIncorrectOrientation);</td></tr><tr><td class="line-number" value="144"></td><td class="line-content">             game.scale.setScreenSize(true);</td></tr><tr><td class="line-number" value="145"></td><td class="line-content">             game.scale.fullScreenScaleMode = Phaser.ScaleManager.EXACT_FIT;</td></tr><tr><td class="line-number" value="146"></td><td class="line-content">         }</td></tr><tr><td class="line-number" value="147"></td><td class="line-content">		game.stage.smoothed = true;</td></tr><tr><td class="line-number" value="148"></td><td class="line-content">        game.state.start('preload');</td></tr><tr><td class="line-number" value="149"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="150"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="151"></td><td class="line-content"></td></tr><tr><td class="line-number" value="152"></td><td class="line-content">var PreloadState = {</td></tr><tr><td class="line-number" value="153"></td><td class="line-content">    preload: function() {</td></tr><tr><td class="line-number" value="154"></td><td class="line-content">        preloadbar = game.add.sprite(0, 0, 'preloadbar');</td></tr><tr><td class="line-number" value="155"></td><td class="line-content">        // Center the preload bar</td></tr><tr><td class="line-number" value="156"></td><td class="line-content">        preloadbar.x = game.world.centerX - preloadbar.width / 2;</td></tr><tr><td class="line-number" value="157"></td><td class="line-content">        preloadbar.y = game.world.centerY - preloadbar.height / 2;</td></tr><tr><td class="line-number" value="158"></td><td class="line-content">        game.load.setPreloadSprite(preloadbar);  //this is all you have to do to get a nice preload screen</td></tr><tr><td class="line-number" value="159"></td><td class="line-content"></td></tr><tr><td class="line-number" value="160"></td><td class="line-content">        game.load.spritesheet('mario', 'assets/mariospritesheet-small.png',50,50);</td></tr><tr><td class="line-number" value="161"></td><td class="line-content">        game.load.spritesheet('mariowhite', 'assets/mariowhitespritesheet-small.png',50,50);</td></tr><tr><td class="line-number" value="162"></td><td class="line-content">        game.load.spritesheet('coin', 'assets/coinspritesheet.png',64,64);</td></tr><tr><td class="line-number" value="163"></td><td class="line-content">        game.load.spritesheet('button', 'assets/start-button.png', 224, 70);</td></tr><tr><td class="line-number" value="164"></td><td class="line-content">        game.load.spritesheet('levelbutton', 'assets/levelbutton.png', 64, 64);</td></tr><tr><td class="line-number" value="165"></td><td class="line-content">        game.load.spritesheet('numbers', 'assets/numbers.png', 64, 64);</td></tr><tr><td class="line-number" value="166"></td><td class="line-content">        game.load.spritesheet('questionmark', 'assets/tilesets/brick-questionmark.png', 64, 64);</td></tr><tr><td class="line-number" value="167"></td><td class="line-content">        game.load.spritesheet('powerups', 'assets/tilesets/powerups.png', 64, 64);</td></tr><tr><td class="line-number" value="168"></td><td class="line-content">        game.load.spritesheet('movingplatforms', 'assets/tilesets/movingplatforms.png', 128, 32);</td></tr><tr><td class="line-number" value="169"></td><td class="line-content">        game.load.spritesheet('gomba', 'assets/gomba-spritesheet.png', 64, 64);</td></tr><tr><td class="line-number" value="170"></td><td class="line-content">        game.load.spritesheet('enemysheet', 'assets/tilesets/enemies.png', 40, 32);</td></tr><tr><td class="line-number" value="171"></td><td class="line-content">        game.load.spritesheet('chain','./assets/chain.png',16,26);</td></tr><tr><td class="line-number" value="172"></td><td class="line-content">        game.load.spritesheet('ui','./assets/ui-sprite.png',32,32);</td></tr><tr><td class="line-number" value="173"></td><td class="line-content">        game.load.spritesheet('menucorner','./assets/menucorner.png',64,64);</td></tr><tr><td class="line-number" value="174"></td><td class="line-content"></td></tr><tr><td class="line-number" value="175"></td><td class="line-content">        game.load.image('circlemask', 'assets/circlemask.png');</td></tr><tr><td class="line-number" value="176"></td><td class="line-content">        game.load.image('ghosttransparent', 'assets/ghost-big-transparent.png');</td></tr><tr><td class="line-number" value="177"></td><td class="line-content">        game.load.image('smoke', 'assets/smoke.png');</td></tr><tr><td class="line-number" value="178"></td><td class="line-content">        game.load.image('fireball', 'assets/fireball-small.png');</td></tr><tr><td class="line-number" value="179"></td><td class="line-content">        game.load.image('bullet', 'assets/bullet-angry.png');</td></tr><tr><td class="line-number" value="180"></td><td class="line-content">        game.load.image('clouds', 'assets/clouds.jpg');</td></tr><tr><td class="line-number" value="181"></td><td class="line-content">        game.load.image('starfield', 'assets/starfield1.png');</td></tr><tr><td class="line-number" value="182"></td><td class="line-content">        game.load.image('mariomiddle-lightgreen', 'assets/mario-lightgreen-middle-blur.png');</td></tr><tr><td class="line-number" value="183"></td><td class="line-content">        game.load.image('marioback-lightgreen', 'assets/mario-lightgreen-back-blur.png');</td></tr><tr><td class="line-number" value="184"></td><td class="line-content">        game.load.image('marioback', 'assets/mario-darkgreen-back-blur.png');</td></tr><tr><td class="line-number" value="185"></td><td class="line-content">        game.load.image('mariomiddle', 'assets/mario-darkgreen-middle-blur.png');</td></tr><tr><td class="line-number" value="186"></td><td class="line-content">        game.load.image('mariofront', 'assets/mario-darkgreen-front-blur.png');</td></tr><tr><td class="line-number" value="187"></td><td class="line-content">        game.load.image('textdoublejump', 'assets/text-doublejump.png');</td></tr><tr><td class="line-number" value="188"></td><td class="line-content">        game.load.image('textclimb', 'assets/text-climb.png');</td></tr><tr><td class="line-number" value="189"></td><td class="line-content">        game.load.image('textslide', 'assets/text-slide.png');</td></tr><tr><td class="line-number" value="190"></td><td class="line-content">        game.load.image('textdie', 'assets/text-die.png');</td></tr><tr><td class="line-number" value="191"></td><td class="line-content">        game.load.image('textduck', 'assets/text-duck.png');</td></tr><tr><td class="line-number" value="192"></td><td class="line-content">        game.load.image('textsave', 'assets/text-save.png');</td></tr><tr><td class="line-number" value="193"></td><td class="line-content">		game.load.image('anchor','assets/anchor.png');</td></tr><tr><td class="line-number" value="194"></td><td class="line-content">		game.load.image('sword','assets/sword1.png');</td></tr><tr><td class="line-number" value="195"></td><td class="line-content">		game.load.image('gun1','assets/gun1.png');</td></tr><tr><td class="line-number" value="196"></td><td class="line-content">		game.load.image('blitz','assets/blitz.png');</td></tr><tr><td class="line-number" value="197"></td><td class="line-content"></td></tr><tr><td class="line-number" value="198"></td><td class="line-content">		game.load.audio('map', 'assets/map2.ogg');</td></tr><tr><td class="line-number" value="199"></td><td class="line-content">        game.load.audio('finishedgame', 'assets/finishedgame.ogg');</td></tr><tr><td class="line-number" value="200"></td><td class="line-content">        game.load.audio('gameover', 'assets/gameover.ogg');</td></tr><tr><td class="line-number" value="201"></td><td class="line-content">        game.load.audio('1up', 'assets/1up.ogg');</td></tr><tr><td class="line-number" value="202"></td><td class="line-content">        game.load.audio('cannon', 'assets/cannon.ogg');</td></tr><tr><td class="line-number" value="203"></td><td class="line-content">        game.load.audio('fire', 'assets/fireball.ogg');</td></tr><tr><td class="line-number" value="204"></td><td class="line-content">        game.load.audio('jump', 'assets/jump.ogg');</td></tr><tr><td class="line-number" value="205"></td><td class="line-content">        game.load.audio('theme', 'assets/mariotheme.ogg');</td></tr><tr><td class="line-number" value="206"></td><td class="line-content">        game.load.audio('theme3', 'assets/mario3-theme.ogg');</td></tr><tr><td class="line-number" value="207"></td><td class="line-content">        game.load.audio('theme-under', 'assets/mario-theme-underworld.ogg');</td></tr><tr><td class="line-number" value="208"></td><td class="line-content">        game.load.audio('kick', 'assets/kick.ogg');</td></tr><tr><td class="line-number" value="209"></td><td class="line-content">        game.load.audio('lose', 'assets/lose.ogg');</td></tr><tr><td class="line-number" value="210"></td><td class="line-content">        game.load.audio('clear', 'assets/stageclear.ogg');</td></tr><tr><td class="line-number" value="211"></td><td class="line-content">        game.load.audio('coin', 'assets/coin.ogg');</td></tr><tr><td class="line-number" value="212"></td><td class="line-content">        game.load.audio('shrink', 'assets/shrink.ogg');</td></tr><tr><td class="line-number" value="213"></td><td class="line-content">        game.load.audio('grow', 'assets/grow.ogg');</td></tr><tr><td class="line-number" value="214"></td><td class="line-content">        game.load.audio('showpowerup', 'assets/mushroom_appears.ogg');</td></tr><tr><td class="line-number" value="215"></td><td class="line-content">        game.load.audio('savepoint', 'assets/savepoint.ogg');</td></tr><tr><td class="line-number" value="216"></td><td class="line-content"></td></tr><tr><td class="line-number" value="217"></td><td class="line-content">        game.load.spritesheet('buttonvertical', 'assets/buttons-big/button-vertical.png',64,64);</td></tr><tr><td class="line-number" value="218"></td><td class="line-content">        game.load.spritesheet('buttonhorizontal', 'assets/buttons-big/button-horizontal.png',96,64);</td></tr><tr><td class="line-number" value="219"></td><td class="line-content">        game.load.spritesheet('buttondiagonal', 'assets/buttons-big/button-diagonal.png',64,64);</td></tr><tr><td class="line-number" value="220"></td><td class="line-content">        game.load.spritesheet('buttonfire', 'assets/buttons-big/button-circle-f.png',96,96);</td></tr><tr><td class="line-number" value="221"></td><td class="line-content">        game.load.spritesheet('buttonjump', 'assets/buttons-big/button-round-j.png',96,96);</td></tr><tr><td class="line-number" value="222"></td><td class="line-content">        game.load.spritesheet('buttonanchor', 'assets/buttons-big/button-circle-a.png',96,96);</td></tr><tr><td class="line-number" value="223"></td><td class="line-content"></td></tr><tr><td class="line-number" value="224"></td><td class="line-content">        game.load.tilemap('trainingmap', './assets/tilesets/training.json', null, Phaser.Tilemap.TILED_JSON);</td></tr><tr><td class="line-number" value="225"></td><td class="line-content">        game.load.tilemap('trainingmap0', './assets/tilesets/training0.json', null, Phaser.Tilemap.TILED_JSON);</td></tr><tr><td class="line-number" value="226"></td><td class="line-content">        game.load.tilemap('flappymap', './assets/tilesets/flappy.json', null, Phaser.Tilemap.TILED_JSON);</td></tr><tr><td class="line-number" value="227"></td><td class="line-content">        game.load.tilemap('level1map', './assets/tilesets/level1.json', null, Phaser.Tilemap.TILED_JSON);</td></tr><tr><td class="line-number" value="228"></td><td class="line-content">        game.load.tilemap('level2map', './assets/tilesets/level2.json', null, Phaser.Tilemap.TILED_JSON);</td></tr><tr><td class="line-number" value="229"></td><td class="line-content">        game.load.tilemap('level3map', './assets/tilesets/level3.json', null, Phaser.Tilemap.TILED_JSON);</td></tr><tr><td class="line-number" value="230"></td><td class="line-content">        game.load.tilemap('level4map', './assets/tilesets/level4.json', null, Phaser.Tilemap.TILED_JSON);</td></tr><tr><td class="line-number" value="231"></td><td class="line-content">        game.load.tilemap('level5map', './assets/tilesets/level5.json', null, Phaser.Tilemap.TILED_JSON);</td></tr><tr><td class="line-number" value="232"></td><td class="line-content">        game.load.tilemap('levelmap', './assets/tilesets/map.json', null, Phaser.Tilemap.TILED_JSON);</td></tr><tr><td class="line-number" value="233"></td><td class="line-content">        game.load.image('mariotileset', './assets/tilesets/mariotileset.png');</td></tr><tr><td class="line-number" value="234"></td><td class="line-content">    },</td></tr><tr><td class="line-number" value="235"></td><td class="line-content">    create: function() {</td></tr><tr><td class="line-number" value="236"></td><td class="line-content">        var howtoText = game.add.text(game.world.centerX, game.world.centerY-40, 'Use WASD and SPACE to move | Mouse to aim', { fill: '#ececec', font: '12px Arial' });</td></tr><tr><td class="line-number" value="237"></td><td class="line-content">        howtoText.x= game.world.centerX-howtoText.width/2;</td></tr><tr><td class="line-number" value="238"></td><td class="line-content">        preloadbar.crop.width = preloadbar.width;</td></tr><tr><td class="line-number" value="239"></td><td class="line-content">        var tween = game.add.tween(preloadbar).to({ alpha: 0 }, 1000, Phaser.Easing.Linear.None, true);</td></tr><tr><td class="line-number" value="240"></td><td class="line-content">        tween.onComplete.addOnce(function() {</td></tr><tr><td class="line-number" value="241"></td><td class="line-content">            //game.state.start(''+level+'');</td></tr><tr><td class="line-number" value="242"></td><td class="line-content">            game.state.start('menu');</td></tr><tr><td class="line-number" value="243"></td><td class="line-content">        });</td></tr><tr><td class="line-number" value="244"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="245"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="246"></td><td class="line-content"></td></tr><tr><td class="line-number" value="247"></td><td class="line-content"></td></tr><tr><td class="line-number" value="248"></td><td class="line-content"></td></tr><tr><td class="line-number" value="249"></td><td class="line-content">var Menu = {</td></tr><tr><td class="line-number" value="250"></td><td class="line-content">    create: function () {</td></tr><tr><td class="line-number" value="251"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="252"></td><td class="line-content">        saved = false;  // wenn dann levelspezifisch gespeichert wird kann das wieder fallen</td></tr><tr><td class="line-number" value="253"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="254"></td><td class="line-content">        if (music){music.stop();}</td></tr><tr><td class="line-number" value="255"></td><td class="line-content">        music = game.add.audio('map',1,true);  // key, volume, loop</td></tr><tr><td class="line-number" value="256"></td><td class="line-content">        music.play('',0,3,true);  //marker, position, volume, loop, forceRestart</td></tr><tr><td class="line-number" value="257"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="258"></td><td class="line-content">        sky=game.add.tileSprite(0, 0, worldwidth,worldheight, 'clouds');</td></tr><tr><td class="line-number" value="259"></td><td class="line-content">        game.world.setBounds(0, 0, worldwidth, worldheight);</td></tr><tr><td class="line-number" value="260"></td><td class="line-content">        gameobjects = game.add.group();</td></tr><tr><td class="line-number" value="261"></td><td class="line-content">        textobjects = game.add.group();</td></tr><tr><td class="line-number" value="262"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="263"></td><td class="line-content">        setupPhysics();</td></tr><tr><td class="line-number" value="264"></td><td class="line-content">         //initialise tilemap</td></tr><tr><td class="line-number" value="265"></td><td class="line-content">        map = game.add.tilemap('levelmap');</td></tr><tr><td class="line-number" value="266"></td><td class="line-content">        map.addTilesetImage('mariotileset');</td></tr><tr><td class="line-number" value="267"></td><td class="line-content">        setupLayers();</td></tr><tr><td class="line-number" value="268"></td><td class="line-content">        createObjects('menu');</td></tr><tr><td class="line-number" value="269"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="270"></td><td class="line-content">        var button = game.add.button(worldwidth-worldwidth/5*4, worldheight-worldheight/4*3, 'levelbutton', function(){music.stop(); level=0;game.state.start('0');}, this, 0, 1, 1);</td></tr><tr><td class="line-number" value="271"></td><td class="line-content">        button.anchor.setTo(0.5,0.5);</td></tr><tr><td class="line-number" value="272"></td><td class="line-content">        var number = game.add.sprite(worldwidth-worldwidth/5*4, worldheight-worldheight/4*3, 'numbers', 0);</td></tr><tr><td class="line-number" value="273"></td><td class="line-content">        number.anchor.setTo(0.5,0.4);</td></tr><tr><td class="line-number" value="274"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="275"></td><td class="line-content">        var button = game.add.button(worldwidth-worldwidth/5*3, worldheight-worldheight/4*3, 'levelbutton', function(){music.stop();level=1;game.state.start('1');}, this, 0, 1, 1);</td></tr><tr><td class="line-number" value="276"></td><td class="line-content">        button.anchor.setTo(0.5,0.5);</td></tr><tr><td class="line-number" value="277"></td><td class="line-content">        var number = game.add.sprite(worldwidth-worldwidth/5*3, worldheight-worldheight/4*3, 'numbers', 1);</td></tr><tr><td class="line-number" value="278"></td><td class="line-content">        number.anchor.setTo(0.5,0.4);</td></tr><tr><td class="line-number" value="279"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="280"></td><td class="line-content">        var button = game.add.button(worldwidth-worldwidth/5*2, worldheight-worldheight/4*3, 'levelbutton', function(){music.stop();level=2;game.state.start('2');}, this, 0, 1, 1);</td></tr><tr><td class="line-number" value="281"></td><td class="line-content">        button.anchor.setTo(0.5,0.5);</td></tr><tr><td class="line-number" value="282"></td><td class="line-content">        var number = game.add.sprite(worldwidth-worldwidth/5*2, worldheight-worldheight/4*3, 'numbers', 2);</td></tr><tr><td class="line-number" value="283"></td><td class="line-content">        number.anchor.setTo(0.5,0.4);</td></tr><tr><td class="line-number" value="284"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="285"></td><td class="line-content">        var button = game.add.button(worldwidth-worldwidth/5*1, worldheight-worldheight/4*3, 'levelbutton', function(){music.stop();level=3;game.state.start('3');}, this, 0, 1, 1);</td></tr><tr><td class="line-number" value="286"></td><td class="line-content">        button.anchor.setTo(0.5,0.5);</td></tr><tr><td class="line-number" value="287"></td><td class="line-content">        var number = game.add.sprite(worldwidth-worldwidth/5*1, worldheight-worldheight/4*3, 'numbers', 3);</td></tr><tr><td class="line-number" value="288"></td><td class="line-content">        number.anchor.setTo(0.5,0.4);</td></tr><tr><td class="line-number" value="289"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="290"></td><td class="line-content">        var button = game.add.button(worldwidth-worldwidth/5*4, worldheight-worldheight/4*2, 'levelbutton', function(){music.stop();level=4;game.state.start('4');}, this, 0, 1, 1);</td></tr><tr><td class="line-number" value="291"></td><td class="line-content">        button.anchor.setTo(0.5,0.5);</td></tr><tr><td class="line-number" value="292"></td><td class="line-content">        var number = game.add.sprite(worldwidth-worldwidth/5*4, worldheight-worldheight/4*2, 'numbers', 4);</td></tr><tr><td class="line-number" value="293"></td><td class="line-content">        number.anchor.setTo(0.5,0.4);</td></tr><tr><td class="line-number" value="294"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="295"></td><td class="line-content">        var button = game.add.button(worldwidth-worldwidth/5*3, worldheight-worldheight/4*2, 'levelbutton', function(){music.stop();level=5;game.state.start('5');}, this, 0, 1, 1);</td></tr><tr><td class="line-number" value="296"></td><td class="line-content">        button.anchor.setTo(0.5,0.5);</td></tr><tr><td class="line-number" value="297"></td><td class="line-content">        var number = game.add.sprite(worldwidth-worldwidth/5*3, worldheight-worldheight/4*2, 'numbers', 5);</td></tr><tr><td class="line-number" value="298"></td><td class="line-content">        number.anchor.setTo(0.5,0.4);</td></tr><tr><td class="line-number" value="299"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="300"></td><td class="line-content">        var button = game.add.button(worldwidth-worldwidth/5*2, worldheight-worldheight/4*2, 'levelbutton', function(){music.stop();level=6;game.state.start('6');}, this, 0, 1, 1);</td></tr><tr><td class="line-number" value="301"></td><td class="line-content">        button.anchor.setTo(0.5,0.5);</td></tr><tr><td class="line-number" value="302"></td><td class="line-content">        var number = game.add.sprite(worldwidth-worldwidth/5*2, worldheight-worldheight/4*2, 'numbers', 6);</td></tr><tr><td class="line-number" value="303"></td><td class="line-content">        number.anchor.setTo(0.5,0.5);</td></tr><tr><td class="line-number" value="304"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="305"></td><td class="line-content">        var button = game.add.button(worldwidth-worldwidth/5*1, worldheight-worldheight/4*2, 'levelbutton', function(){music.stop();level=7;game.state.start('7');}, this, 0, 1, 1);</td></tr><tr><td class="line-number" value="306"></td><td class="line-content">        button.anchor.setTo(0.5,0.5);</td></tr><tr><td class="line-number" value="307"></td><td class="line-content">        var number = game.add.sprite(worldwidth-worldwidth/5*1, worldheight-worldheight/4*2, 'numbers', 7);</td></tr><tr><td class="line-number" value="308"></td><td class="line-content">        number.anchor.setTo(0.5,0.5);</td></tr><tr><td class="line-number" value="309"></td><td class="line-content">   },</td></tr><tr><td class="line-number" value="310"></td><td class="line-content">    update: function() {</td></tr><tr><td class="line-number" value="311"></td><td class="line-content">        timer += 0.005</td></tr><tr><td class="line-number" value="312"></td><td class="line-content">        sky.tileScale.x = 2 + Math.sin(timer);</td></tr><tr><td class="line-number" value="313"></td><td class="line-content">        sky.tileScale.y = 2 + Math.cos(timer);</td></tr><tr><td class="line-number" value="314"></td><td class="line-content">        sky.tilePosition.x += 1;</td></tr><tr><td class="line-number" value="315"></td><td class="line-content">        sky.tilePosition.y += 1;</td></tr><tr><td class="line-number" value="316"></td><td class="line-content">        enemies.forEach(moveAliveEnemy,this);</td></tr><tr><td class="line-number" value="317"></td><td class="line-content">        movingplatforms.forEach(movePlatforms,this);</td></tr><tr><td class="line-number" value="318"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="319"></td><td class="line-content">    </td></tr><tr><td class="line-number" value="320"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="321"></td><td class="line-content"></td></tr><tr><td class="line-number" value="322"></td><td class="line-content"></td></tr><tr><td class="line-number" value="323"></td><td class="line-content"></td></tr><tr><td class="line-number" value="324"></td><td class="line-content"></td></tr><tr><td class="line-number" value="325"></td><td class="line-content"></td></tr><tr><td class="line-number" value="326"></td><td class="line-content"></td></tr><tr><td class="line-number" value="327"></td><td class="line-content"></td></tr><tr><td class="line-number" value="328"></td><td class="line-content"></td></tr><tr><td class="line-number" value="329"></td><td class="line-content">var Level0 = {</td></tr><tr><td class="line-number" value="330"></td><td class="line-content">    create: function () {</td></tr><tr><td class="line-number" value="331"></td><td class="line-content">        //reset state vars</td></tr><tr><td class="line-number" value="332"></td><td class="line-content">        gamestate='running';</td></tr><tr><td class="line-number" value="333"></td><td class="line-content">        climbing = false;</td></tr><tr><td class="line-number" value="334"></td><td class="line-content">        hanging = false;</td></tr><tr><td class="line-number" value="335"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="336"></td><td class="line-content">        music = game.add.audio('theme3',1,true);  // key, voluem, loop</td></tr><tr><td class="line-number" value="337"></td><td class="line-content">        music.play('',0,3,true);  //wtf?  this plays the audio</td></tr><tr><td class="line-number" value="338"></td><td class="line-content">        //load beautiful backgrounds</td></tr><tr><td class="line-number" value="339"></td><td class="line-content">        sky = game.add.tileSprite(0, 0, worldwidth, worldheight, 'clouds'); </td></tr><tr><td class="line-number" value="340"></td><td class="line-content">        sky.fixedToCamera = true;</td></tr><tr><td class="line-number" value="341"></td><td class="line-content">        paralax1 = game.add.tileSprite(0, 0, 6600,  660, 'mariomiddle');</td></tr><tr><td class="line-number" value="342"></td><td class="line-content">        paralax0 = game.add.tileSprite(0, 0, 6600, 660, 'mariofront');</td></tr><tr><td class="line-number" value="343"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="344"></td><td class="line-content">        //create groups for z-index</td></tr><tr><td class="line-number" value="345"></td><td class="line-content">        gameobjects = game.add.group();</td></tr><tr><td class="line-number" value="346"></td><td class="line-content">        textobjects = game.add.group();</td></tr><tr><td class="line-number" value="347"></td><td class="line-content">        controls = game.add.group();  //controls group is created after the gameobjects so they stay onTop</td></tr><tr><td class="line-number" value="348"></td><td class="line-content">        gameobjects.add(sky);</td></tr><tr><td class="line-number" value="349"></td><td class="line-content">        gameobjects.add(paralax1);</td></tr><tr><td class="line-number" value="350"></td><td class="line-content">        gameobjects.add(paralax0);</td></tr><tr><td class="line-number" value="351"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="352"></td><td class="line-content">        setupPhysics();</td></tr><tr><td class="line-number" value="353"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="354"></td><td class="line-content">        //initialise tilemap</td></tr><tr><td class="line-number" value="355"></td><td class="line-content">        map = game.add.tilemap('trainingmap0');</td></tr><tr><td class="line-number" value="356"></td><td class="line-content">        map.addTilesetImage('mariotileset');</td></tr><tr><td class="line-number" value="357"></td><td class="line-content"></td></tr><tr><td class="line-number" value="358"></td><td class="line-content">        createObjects();  </td></tr><tr><td class="line-number" value="359"></td><td class="line-content">        setupLayers();</td></tr><tr><td class="line-number" value="360"></td><td class="line-content">        setupControls();</td></tr><tr><td class="line-number" value="361"></td><td class="line-content"> </td></tr><tr><td class="line-number" value="362"></td><td class="line-content">        timerEvents[0]=game.time.events.loop(Phaser.Timer.SECOND * 4, resetBullets, this);  // let bullets fly through the world</td></tr><tr><td class="line-number" value="363"></td><td class="line-content">        // trainingmap help texts</td></tr><tr><td class="line-number" value="364"></td><td class="line-content">        text1=textobjects.create(40, 400, 'textdoublejump');text1.scale.setTo(0.6,0.6);</td></tr><tr><td class="line-number" value="365"></td><td class="line-content">        text2=textobjects.create(840, 480, 'textclimb');text2.scale.setTo(0.6,0.6);</td></tr><tr><td class="line-number" value="366"></td><td class="line-content">        text3=textobjects.create(3200, 540, 'textslide');text3.scale.setTo(0.6,0.6);</td></tr><tr><td class="line-number" value="367"></td><td class="line-content">        text4=textobjects.create(2460, 510, 'textdie');text4.scale.setTo(0.6,0.6);</td></tr><tr><td class="line-number" value="368"></td><td class="line-content">        text5=textobjects.create(3410, 490, 'textduck');text5.scale.setTo(0.6,0.6);</td></tr><tr><td class="line-number" value="369"></td><td class="line-content">        text6=textobjects.create(1100, 30, 'textsave');text6.scale.setTo(0.6,0.6);</td></tr><tr><td class="line-number" value="370"></td><td class="line-content"></td></tr><tr><td class="line-number" value="371"></td><td class="line-content">        // frame counter for measuring performance</td></tr><tr><td class="line-number" value="372"></td><td class="line-content">        game.time.advancedTiming = true;</td></tr><tr><td class="line-number" value="373"></td><td class="line-content">        fpsText = this.game.add.text(game.camera.width-60, 40, '', { font: '16px Arial', fill: '#ffffff' } );</td></tr><tr><td class="line-number" value="374"></td><td class="line-content">        fpsText.fixedToCamera = true;</td></tr><tr><td class="line-number" value="375"></td><td class="line-content">        textobjects.add(fpsText);</td></tr><tr><td class="line-number" value="376"></td><td class="line-content"></td></tr><tr><td class="line-number" value="377"></td><td class="line-content">        if (saved === true){setupPlayer(savepointX,savepointY);}</td></tr><tr><td class="line-number" value="378"></td><td class="line-content">        else {  setupPlayer(150,500); }     </td></tr><tr><td class="line-number" value="379"></td><td class="line-content">    },</td></tr><tr><td class="line-number" value="380"></td><td class="line-content">    update: function () {</td></tr><tr><td class="line-number" value="381"></td><td class="line-content">        paralax1.x= game.camera.x*0.5; </td></tr><tr><td class="line-number" value="382"></td><td class="line-content">        paralax0.x= game.camera.x*0.3; </td></tr><tr><td class="line-number" value="383"></td><td class="line-content">        if (gamestate=='running'){ playerInputActions();   if(game.time.fps !== 0){fpsText.setText(game.time.fps + ' FPS');} }</td></tr><tr><td class="line-number" value="384"></td><td class="line-content">        else if (gamestate == 'lost'){ playerstate = 'die'; player.body.data.gravityScale=1; player.body.collideWorldBounds=false;}</td></tr><tr><td class="line-number" value="385"></td><td class="line-content">        else if (gamestate == 'win'){ fadeOut(); playerstate = 'win'; player.body.collideWorldBounds=false;}</td></tr><tr><td class="line-number" value="386"></td><td class="line-content">        playerAnimations(player);</td></tr><tr><td class="line-number" value="387"></td><td class="line-content">		movingplatforms.forEach(movePlatforms,this);</td></tr><tr><td class="line-number" value="388"></td><td class="line-content">		enemies.forEach(moveAliveEnemy,this); // make sure bullets keep moving     //foreachAlive or foreach 1!!!????</td></tr><tr><td class="line-number" value="389"></td><td class="line-content">        layerforeground.bringToTop(); </td></tr><tr><td class="line-number" value="390"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="391"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="392"></td><td class="line-content"></td></tr><tr><td class="line-number" value="393"></td><td class="line-content"></td></tr><tr><td class="line-number" value="394"></td><td class="line-content">var Level1 = {</td></tr><tr><td class="line-number" value="395"></td><td class="line-content">    create: function () {</td></tr><tr><td class="line-number" value="396"></td><td class="line-content">        //reset state vars</td></tr><tr><td class="line-number" value="397"></td><td class="line-content">        gamestate='running';</td></tr><tr><td class="line-number" value="398"></td><td class="line-content">        climbing = false;</td></tr><tr><td class="line-number" value="399"></td><td class="line-content">        hanging = false;</td></tr><tr><td class="line-number" value="400"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="401"></td><td class="line-content">        music = game.add.audio('theme3',1,true);  // key, voluem, loop</td></tr><tr><td class="line-number" value="402"></td><td class="line-content">        music.play('',0,3,true);  //wtf?  this plays the audio</td></tr><tr><td class="line-number" value="403"></td><td class="line-content">        //load beautiful backgrounds</td></tr><tr><td class="line-number" value="404"></td><td class="line-content">        sky = game.add.tileSprite(0, 0, worldwidth, worldheight, 'clouds'); </td></tr><tr><td class="line-number" value="405"></td><td class="line-content">        sky.fixedToCamera = true;</td></tr><tr><td class="line-number" value="406"></td><td class="line-content">        paralax1 = game.add.tileSprite(0, 0, 6600,  660, 'mariomiddle');</td></tr><tr><td class="line-number" value="407"></td><td class="line-content">        paralax0 = game.add.tileSprite(0, 0, 6600, 660, 'mariofront');</td></tr><tr><td class="line-number" value="408"></td><td class="line-content"></td></tr><tr><td class="line-number" value="409"></td><td class="line-content">        //create groups for z-index</td></tr><tr><td class="line-number" value="410"></td><td class="line-content">        gameobjects = game.add.group();</td></tr><tr><td class="line-number" value="411"></td><td class="line-content">        textobjects = game.add.group();</td></tr><tr><td class="line-number" value="412"></td><td class="line-content">        controls = game.add.group();  //controls group is created after the gameobjects so they stay onTop</td></tr><tr><td class="line-number" value="413"></td><td class="line-content">        gameobjects.add(sky);</td></tr><tr><td class="line-number" value="414"></td><td class="line-content">        gameobjects.add(paralax1);</td></tr><tr><td class="line-number" value="415"></td><td class="line-content">        gameobjects.add(paralax0);</td></tr><tr><td class="line-number" value="416"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="417"></td><td class="line-content">        setupPhysics();</td></tr><tr><td class="line-number" value="418"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="419"></td><td class="line-content">        //initialise tilemap</td></tr><tr><td class="line-number" value="420"></td><td class="line-content">        map = game.add.tilemap('trainingmap');</td></tr><tr><td class="line-number" value="421"></td><td class="line-content">        map.addTilesetImage('mariotileset');</td></tr><tr><td class="line-number" value="422"></td><td class="line-content"></td></tr><tr><td class="line-number" value="423"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="424"></td><td class="line-content">        setupLayers();</td></tr><tr><td class="line-number" value="425"></td><td class="line-content">        setupControls();</td></tr><tr><td class="line-number" value="426"></td><td class="line-content">        createObjects();  </td></tr><tr><td class="line-number" value="427"></td><td class="line-content">        timerEvents[0]=game.time.events.loop(Phaser.Timer.SECOND * 4, resetBullets, this);  // let bullets fly through the world</td></tr><tr><td class="line-number" value="428"></td><td class="line-content">  </td></tr><tr><td class="line-number" value="429"></td><td class="line-content"> </td></tr><tr><td class="line-number" value="430"></td><td class="line-content">        if (saved === true){setupPlayer(savepointX,savepointY);}</td></tr><tr><td class="line-number" value="431"></td><td class="line-content">        else {  setupPlayer(150,500); }</td></tr><tr><td class="line-number" value="432"></td><td class="line-content">       </td></tr><tr><td class="line-number" value="433"></td><td class="line-content">    },</td></tr><tr><td class="line-number" value="434"></td><td class="line-content">    update: function () {</td></tr><tr><td class="line-number" value="435"></td><td class="line-content">        paralax1.x= game.camera.x*0.5; </td></tr><tr><td class="line-number" value="436"></td><td class="line-content">        paralax0.x= game.camera.x*0.3; </td></tr><tr><td class="line-number" value="437"></td><td class="line-content">        if (gamestate=='running'){ playerInputActions();}</td></tr><tr><td class="line-number" value="438"></td><td class="line-content">        else if (gamestate == 'lost'){ playerstate = 'die'; player.body.data.gravityScale=1; player.body.collideWorldBounds=false;}</td></tr><tr><td class="line-number" value="439"></td><td class="line-content">        else if (gamestate == 'win'){ fadeOut(); playerstate = 'win'; player.body.collideWorldBounds=false;}</td></tr><tr><td class="line-number" value="440"></td><td class="line-content">        playerAnimations(player);</td></tr><tr><td class="line-number" value="441"></td><td class="line-content">        movingplatforms.forEach(movePlatforms,this);</td></tr><tr><td class="line-number" value="442"></td><td class="line-content">        enemies.forEach(moveAliveEnemy,this); // make sure bullets keep moving     //foreachAlive or foreach 1!!!????</td></tr><tr><td class="line-number" value="443"></td><td class="line-content">        layerforeground.bringToTop(); </td></tr><tr><td class="line-number" value="444"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="445"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="446"></td><td class="line-content"></td></tr><tr><td class="line-number" value="447"></td><td class="line-content"></td></tr><tr><td class="line-number" value="448"></td><td class="line-content"></td></tr><tr><td class="line-number" value="449"></td><td class="line-content"></td></tr><tr><td class="line-number" value="450"></td><td class="line-content">var Level2 = {</td></tr><tr><td class="line-number" value="451"></td><td class="line-content">    create: function () { </td></tr><tr><td class="line-number" value="452"></td><td class="line-content">        //reset state vars</td></tr><tr><td class="line-number" value="453"></td><td class="line-content">        gamestate='running';</td></tr><tr><td class="line-number" value="454"></td><td class="line-content">        climbing = false;</td></tr><tr><td class="line-number" value="455"></td><td class="line-content">        hanging = false;</td></tr><tr><td class="line-number" value="456"></td><td class="line-content">        music = game.add.audio('theme',1,true);  // key, voluem, loop</td></tr><tr><td class="line-number" value="457"></td><td class="line-content">        music.play('',0,1,true);  //wtf?  this plays the audio</td></tr><tr><td class="line-number" value="458"></td><td class="line-content">        //load beautiful backgrounds</td></tr><tr><td class="line-number" value="459"></td><td class="line-content">        sky = game.add.tileSprite(0, 0, worldwidth, worldheight, 'clouds'); </td></tr><tr><td class="line-number" value="460"></td><td class="line-content">        sky.fixedToCamera = true;</td></tr><tr><td class="line-number" value="461"></td><td class="line-content"></td></tr><tr><td class="line-number" value="462"></td><td class="line-content">        paralax1 = game.add.tileSprite(0, 400, 3300,  816, 'marioback-lightgreen');</td></tr><tr><td class="line-number" value="463"></td><td class="line-content">        paralax2 = game.add.tileSprite(0, 400, 3300, 816, 'mariomiddle-lightgreen');</td></tr><tr><td class="line-number" value="464"></td><td class="line-content"></td></tr><tr><td class="line-number" value="465"></td><td class="line-content">        gameobjects = game.add.group();</td></tr><tr><td class="line-number" value="466"></td><td class="line-content">        textobjects = game.add.group();</td></tr><tr><td class="line-number" value="467"></td><td class="line-content">        controls = game.add.group();  //controls group is created after the gameobjects so they stay onTop</td></tr><tr><td class="line-number" value="468"></td><td class="line-content">        gameobjects.add(sky);</td></tr><tr><td class="line-number" value="469"></td><td class="line-content">        gameobjects.add(paralax1);</td></tr><tr><td class="line-number" value="470"></td><td class="line-content">        gameobjects.add(paralax2);</td></tr><tr><td class="line-number" value="471"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="472"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="473"></td><td class="line-content">        setupPhysics();</td></tr><tr><td class="line-number" value="474"></td><td class="line-content">        //initialise tilemap</td></tr><tr><td class="line-number" value="475"></td><td class="line-content">        map = game.add.tilemap('level1map');</td></tr><tr><td class="line-number" value="476"></td><td class="line-content">        map.addTilesetImage('mariotileset');</td></tr><tr><td class="line-number" value="477"></td><td class="line-content">        setupLayers();</td></tr><tr><td class="line-number" value="478"></td><td class="line-content">        setupControls();</td></tr><tr><td class="line-number" value="479"></td><td class="line-content">        timerEvents[0]=game.time.events.loop(Phaser.Timer.SECOND * 4, resetBullets, this);  // let bullets fly through the world</td></tr><tr><td class="line-number" value="480"></td><td class="line-content">        createObjects();</td></tr><tr><td class="line-number" value="481"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="482"></td><td class="line-content">        if (saved === true){setupPlayer(savepointX,savepointY);}</td></tr><tr><td class="line-number" value="483"></td><td class="line-content">        else {  setupPlayer(120,800); }</td></tr><tr><td class="line-number" value="484"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="485"></td><td class="line-content">    },</td></tr><tr><td class="line-number" value="486"></td><td class="line-content">    update: function () {</td></tr><tr><td class="line-number" value="487"></td><td class="line-content">        paralax2.x= game.camera.x*0.1; //paralax2.y= game.camera.y*0.1+340;</td></tr><tr><td class="line-number" value="488"></td><td class="line-content">        paralax1.x= game.camera.x*0.2;// paralax1.y= game.camera.y*0.2+300; //move it down a few pixels to account for the missing pixels when moving with camera</td></tr><tr><td class="line-number" value="489"></td><td class="line-content"></td></tr><tr><td class="line-number" value="490"></td><td class="line-content">        if (gamestate=='running'){ playerInputActions(); }</td></tr><tr><td class="line-number" value="491"></td><td class="line-content">        else if (gamestate == 'lost'){ playerstate = 'die'; player.body.data.gravityScale=1;player.body.collideWorldBounds=false;}</td></tr><tr><td class="line-number" value="492"></td><td class="line-content">        else if (gamestate == 'win'){  fadeOut();playerstate = 'win'; player.body.collideWorldBounds=false;}</td></tr><tr><td class="line-number" value="493"></td><td class="line-content">        playerAnimations(player);</td></tr><tr><td class="line-number" value="494"></td><td class="line-content">        movingplatforms.forEach(movePlatforms,this);</td></tr><tr><td class="line-number" value="495"></td><td class="line-content">        enemies.forEach(moveAliveEnemy,this); // make sure bullets keep moving     //foreachAlive or foreach 1!!!????</td></tr><tr><td class="line-number" value="496"></td><td class="line-content">        layerforeground.bringToTop(); </td></tr><tr><td class="line-number" value="497"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="498"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="499"></td><td class="line-content"></td></tr><tr><td class="line-number" value="500"></td><td class="line-content"></td></tr><tr><td class="line-number" value="501"></td><td class="line-content"></td></tr><tr><td class="line-number" value="502"></td><td class="line-content"></td></tr><tr><td class="line-number" value="503"></td><td class="line-content"></td></tr><tr><td class="line-number" value="504"></td><td class="line-content"></td></tr><tr><td class="line-number" value="505"></td><td class="line-content"></td></tr><tr><td class="line-number" value="506"></td><td class="line-content"></td></tr><tr><td class="line-number" value="507"></td><td class="line-content"></td></tr><tr><td class="line-number" value="508"></td><td class="line-content"></td></tr><tr><td class="line-number" value="509"></td><td class="line-content"></td></tr><tr><td class="line-number" value="510"></td><td class="line-content"></td></tr><tr><td class="line-number" value="511"></td><td class="line-content"></td></tr><tr><td class="line-number" value="512"></td><td class="line-content"></td></tr><tr><td class="line-number" value="513"></td><td class="line-content"></td></tr><tr><td class="line-number" value="514"></td><td class="line-content">var Level3 = {</td></tr><tr><td class="line-number" value="515"></td><td class="line-content">    create: function () { </td></tr><tr><td class="line-number" value="516"></td><td class="line-content">        //reset state vars</td></tr><tr><td class="line-number" value="517"></td><td class="line-content">        gamestate='running';</td></tr><tr><td class="line-number" value="518"></td><td class="line-content">        climbing = false;</td></tr><tr><td class="line-number" value="519"></td><td class="line-content">        hanging = false;</td></tr><tr><td class="line-number" value="520"></td><td class="line-content">        music = game.add.audio('theme-under',1,true);  // key, voluem, loop</td></tr><tr><td class="line-number" value="521"></td><td class="line-content">        music.play('',0,2,true);  //wtf?  this plays the audio</td></tr><tr><td class="line-number" value="522"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="523"></td><td class="line-content">        //load beautiful backgrounds</td></tr><tr><td class="line-number" value="524"></td><td class="line-content">        sky = game.add.tileSprite(0, 0, worldwidth, worldheight, 'starfield'); </td></tr><tr><td class="line-number" value="525"></td><td class="line-content">        sky.fixedToCamera = true;</td></tr><tr><td class="line-number" value="526"></td><td class="line-content">        paralax1 = game.add.tileSprite(0, 0, 6600,  660, 'mariomiddle');         </td></tr><tr><td class="line-number" value="527"></td><td class="line-content">        paralax0 = game.add.tileSprite(0, 0, 6600, 660, 'mariofront');</td></tr><tr><td class="line-number" value="528"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="529"></td><td class="line-content">        //create groups for z-index</td></tr><tr><td class="line-number" value="530"></td><td class="line-content">        gameobjects = game.add.group();</td></tr><tr><td class="line-number" value="531"></td><td class="line-content">        textobjects = game.add.group();</td></tr><tr><td class="line-number" value="532"></td><td class="line-content">        controls = game.add.group();  //controls group is created after the gameobjects so they stay onTop</td></tr><tr><td class="line-number" value="533"></td><td class="line-content">        gameobjects.add(sky);</td></tr><tr><td class="line-number" value="534"></td><td class="line-content">        gameobjects.add(paralax1);</td></tr><tr><td class="line-number" value="535"></td><td class="line-content">        gameobjects.add(paralax0);</td></tr><tr><td class="line-number" value="536"></td><td class="line-content">               </td></tr><tr><td class="line-number" value="537"></td><td class="line-content">               </td></tr><tr><td class="line-number" value="538"></td><td class="line-content">        setupPhysics();</td></tr><tr><td class="line-number" value="539"></td><td class="line-content">        //initialise tilemap</td></tr><tr><td class="line-number" value="540"></td><td class="line-content">        map = game.add.tilemap('level2map');</td></tr><tr><td class="line-number" value="541"></td><td class="line-content">        map.addTilesetImage('mariotileset');</td></tr><tr><td class="line-number" value="542"></td><td class="line-content"></td></tr><tr><td class="line-number" value="543"></td><td class="line-content">        setupLayers();</td></tr><tr><td class="line-number" value="544"></td><td class="line-content">        setupControls();</td></tr><tr><td class="line-number" value="545"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="546"></td><td class="line-content">        timerEvents[0]=game.time.events.loop(Phaser.Timer.SECOND * 4, resetBullets, this);  // let bullets fly through the world</td></tr><tr><td class="line-number" value="547"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="548"></td><td class="line-content">        createObjects();</td></tr><tr><td class="line-number" value="549"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="550"></td><td class="line-content">        if (saved === true){setupPlayer(savepointX,savepointY);}</td></tr><tr><td class="line-number" value="551"></td><td class="line-content">        else {  setupPlayer(50,500); }</td></tr><tr><td class="line-number" value="552"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="553"></td><td class="line-content">        createGhost(2200, game.world.centerY);</td></tr><tr><td class="line-number" value="554"></td><td class="line-content">    },</td></tr><tr><td class="line-number" value="555"></td><td class="line-content">    update: function () {</td></tr><tr><td class="line-number" value="556"></td><td class="line-content">        paralax1.x= game.camera.x*0.5;// paralax1.y= game.camera.y*0.2; //move it down a few pixels to account for the missing pixels when moving with camera</td></tr><tr><td class="line-number" value="557"></td><td class="line-content">        paralax0.x= game.camera.x*0.3;// paralax0.y= game.camera.y*0.1;</td></tr><tr><td class="line-number" value="558"></td><td class="line-content">        if (gamestate=='running'){ playerInputActions(); }</td></tr><tr><td class="line-number" value="559"></td><td class="line-content">        else if (gamestate == 'lost'){ playerstate = 'die'; player.body.data.gravityScale=1; player.body.collideWorldBounds=false;}</td></tr><tr><td class="line-number" value="560"></td><td class="line-content">        else if (gamestate == 'win'){fadeOut(); playerstate = 'win'; player.body.collideWorldBounds=false;}</td></tr><tr><td class="line-number" value="561"></td><td class="line-content">        playerAnimations(player);</td></tr><tr><td class="line-number" value="562"></td><td class="line-content">        movingplatforms.forEach(movePlatforms,this);</td></tr><tr><td class="line-number" value="563"></td><td class="line-content">        enemies.forEach(moveAliveEnemy,this); // make sure bullets keep moving     //foreachAlive or foreach 1!!!????</td></tr><tr><td class="line-number" value="564"></td><td class="line-content">        layerforeground.bringToTop(); </td></tr><tr><td class="line-number" value="565"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="566"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="567"></td><td class="line-content"></td></tr><tr><td class="line-number" value="568"></td><td class="line-content"></td></tr><tr><td class="line-number" value="569"></td><td class="line-content"></td></tr><tr><td class="line-number" value="570"></td><td class="line-content">var Level4 = {</td></tr><tr><td class="line-number" value="571"></td><td class="line-content">    create: function () { </td></tr><tr><td class="line-number" value="572"></td><td class="line-content">        //reset state vars</td></tr><tr><td class="line-number" value="573"></td><td class="line-content">        gamestate='running';</td></tr><tr><td class="line-number" value="574"></td><td class="line-content">        climbing = false;</td></tr><tr><td class="line-number" value="575"></td><td class="line-content">        hanging = false;</td></tr><tr><td class="line-number" value="576"></td><td class="line-content">        music = game.add.audio('theme3',1,true);  // key, voluem, loop</td></tr><tr><td class="line-number" value="577"></td><td class="line-content">        music.play('',0,3,true);  //wtf?  this plays the audio</td></tr><tr><td class="line-number" value="578"></td><td class="line-content">        //load beautiful backgrounds</td></tr><tr><td class="line-number" value="579"></td><td class="line-content">        sky = game.add.tileSprite(0, 0, worldwidth, worldheight, 'clouds'); </td></tr><tr><td class="line-number" value="580"></td><td class="line-content">        sky.fixedToCamera = true;</td></tr><tr><td class="line-number" value="581"></td><td class="line-content"></td></tr><tr><td class="line-number" value="582"></td><td class="line-content">        paralax1 = game.add.tileSprite(0, 0, 6600,  660, 'mariomiddle');         </td></tr><tr><td class="line-number" value="583"></td><td class="line-content">        paralax0 = game.add.tileSprite(0, 0, 6600, 660, 'mariofront');</td></tr><tr><td class="line-number" value="584"></td><td class="line-content"></td></tr><tr><td class="line-number" value="585"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="586"></td><td class="line-content">        gameobjects = game.add.group();</td></tr><tr><td class="line-number" value="587"></td><td class="line-content">        textobjects = game.add.group();</td></tr><tr><td class="line-number" value="588"></td><td class="line-content">        controls = game.add.group();  //controls group is created after the gameobjects so they stay onTop</td></tr><tr><td class="line-number" value="589"></td><td class="line-content">        gameobjects.add(sky);</td></tr><tr><td class="line-number" value="590"></td><td class="line-content">        gameobjects.add(paralax1);</td></tr><tr><td class="line-number" value="591"></td><td class="line-content">        gameobjects.add(paralax0);</td></tr><tr><td class="line-number" value="592"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="593"></td><td class="line-content">        setupPhysics();</td></tr><tr><td class="line-number" value="594"></td><td class="line-content">        //initialise tilemap</td></tr><tr><td class="line-number" value="595"></td><td class="line-content">        map = game.add.tilemap('level3map');</td></tr><tr><td class="line-number" value="596"></td><td class="line-content">        map.addTilesetImage('mariotileset');</td></tr><tr><td class="line-number" value="597"></td><td class="line-content"></td></tr><tr><td class="line-number" value="598"></td><td class="line-content">        setupLayers();</td></tr><tr><td class="line-number" value="599"></td><td class="line-content">        setupControls();</td></tr><tr><td class="line-number" value="600"></td><td class="line-content">        createObjects();</td></tr><tr><td class="line-number" value="601"></td><td class="line-content">        timerEvents[0]=game.time.events.loop(Phaser.Timer.SECOND * 4, resetBullets, this);  // let bullets fly through the world</td></tr><tr><td class="line-number" value="602"></td><td class="line-content"></td></tr><tr><td class="line-number" value="603"></td><td class="line-content">        if (saved === true){setupPlayer(savepointX,savepointY);}</td></tr><tr><td class="line-number" value="604"></td><td class="line-content">        else {  setupPlayer(150,500); }</td></tr><tr><td class="line-number" value="605"></td><td class="line-content">    },</td></tr><tr><td class="line-number" value="606"></td><td class="line-content">    update: function () {</td></tr><tr><td class="line-number" value="607"></td><td class="line-content">        paralax1.x= game.camera.x*0.5; //paralax1.y= game.camera.y*0.2; //move it down a few pixels to account for the missing pixels when moving with camera</td></tr><tr><td class="line-number" value="608"></td><td class="line-content">        paralax0.x= game.camera.x*0.3; //paralax0.y= game.camera.y*0.1;</td></tr><tr><td class="line-number" value="609"></td><td class="line-content">        if (gamestate=='running'){ playerInputActions(); }</td></tr><tr><td class="line-number" value="610"></td><td class="line-content">        else if (gamestate == 'lost'){ playerstate = 'die'; player.body.data.gravityScale=1; player.body.collideWorldBounds=false;}</td></tr><tr><td class="line-number" value="611"></td><td class="line-content">        else if (gamestate == 'win'){fadeOut(); playerstate = 'win'; player.body.collideWorldBounds=false;}</td></tr><tr><td class="line-number" value="612"></td><td class="line-content">        playerAnimations(player);</td></tr><tr><td class="line-number" value="613"></td><td class="line-content">        movingplatforms.forEach(movePlatforms,this);</td></tr><tr><td class="line-number" value="614"></td><td class="line-content">        enemies.forEach(moveAliveEnemy,this); // make sure bullets keep moving     //foreachAlive or foreach 1!!!????</td></tr><tr><td class="line-number" value="615"></td><td class="line-content">        layerforeground.bringToTop(); </td></tr><tr><td class="line-number" value="616"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="617"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="618"></td><td class="line-content"></td></tr><tr><td class="line-number" value="619"></td><td class="line-content"></td></tr><tr><td class="line-number" value="620"></td><td class="line-content"></td></tr><tr><td class="line-number" value="621"></td><td class="line-content">var Level5 = {</td></tr><tr><td class="line-number" value="622"></td><td class="line-content">    create: function () { </td></tr><tr><td class="line-number" value="623"></td><td class="line-content">        //reset state vars</td></tr><tr><td class="line-number" value="624"></td><td class="line-content">        gamestate='running';</td></tr><tr><td class="line-number" value="625"></td><td class="line-content">        climbing = false;</td></tr><tr><td class="line-number" value="626"></td><td class="line-content">        hanging = false;</td></tr><tr><td class="line-number" value="627"></td><td class="line-content">        music = game.add.audio('theme-under',1,true);  // key, voluem, loop</td></tr><tr><td class="line-number" value="628"></td><td class="line-content">        music.play('',0,2,true);  //wtf?  this plays the audio</td></tr><tr><td class="line-number" value="629"></td><td class="line-content">        //load beautiful backgrounds</td></tr><tr><td class="line-number" value="630"></td><td class="line-content">        sky = game.add.tileSprite(0, 0, worldwidth, worldheight, 'starfield'); </td></tr><tr><td class="line-number" value="631"></td><td class="line-content">        sky.fixedToCamera = true;</td></tr><tr><td class="line-number" value="632"></td><td class="line-content"></td></tr><tr><td class="line-number" value="633"></td><td class="line-content">        paralax1 = game.add.tileSprite(0, 0, 6600,  660, 'mariomiddle');         </td></tr><tr><td class="line-number" value="634"></td><td class="line-content">        paralax0 = game.add.tileSprite(0, 0, 6600, 660, 'mariofront');</td></tr><tr><td class="line-number" value="635"></td><td class="line-content"></td></tr><tr><td class="line-number" value="636"></td><td class="line-content">        gameobjects = game.add.group();</td></tr><tr><td class="line-number" value="637"></td><td class="line-content">        textobjects = game.add.group();</td></tr><tr><td class="line-number" value="638"></td><td class="line-content">        controls = game.add.group();  //controls group is created after the gameobjects so they stay onTop</td></tr><tr><td class="line-number" value="639"></td><td class="line-content">        gameobjects.add(sky);</td></tr><tr><td class="line-number" value="640"></td><td class="line-content">        gameobjects.add(paralax1);</td></tr><tr><td class="line-number" value="641"></td><td class="line-content">        gameobjects.add(paralax0);</td></tr><tr><td class="line-number" value="642"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="643"></td><td class="line-content">        setupPhysics();</td></tr><tr><td class="line-number" value="644"></td><td class="line-content">        //initialise tilemap</td></tr><tr><td class="line-number" value="645"></td><td class="line-content">        map = game.add.tilemap('level4map');</td></tr><tr><td class="line-number" value="646"></td><td class="line-content">        map.addTilesetImage('mariotileset');</td></tr><tr><td class="line-number" value="647"></td><td class="line-content"></td></tr><tr><td class="line-number" value="648"></td><td class="line-content">        setupLayers();</td></tr><tr><td class="line-number" value="649"></td><td class="line-content">        setupControls();</td></tr><tr><td class="line-number" value="650"></td><td class="line-content">        createObjects();</td></tr><tr><td class="line-number" value="651"></td><td class="line-content">        timerEvents[0]=game.time.events.loop(Phaser.Timer.SECOND * 4, resetBullets, this);  // let bullets fly through the world</td></tr><tr><td class="line-number" value="652"></td><td class="line-content"></td></tr><tr><td class="line-number" value="653"></td><td class="line-content">        if (saved === true){setupPlayer(savepointX,savepointY);}</td></tr><tr><td class="line-number" value="654"></td><td class="line-content">        else {  setupPlayer(150,500); }</td></tr><tr><td class="line-number" value="655"></td><td class="line-content">    },</td></tr><tr><td class="line-number" value="656"></td><td class="line-content">    update: function () {</td></tr><tr><td class="line-number" value="657"></td><td class="line-content">        paralax1.x= game.camera.x*0.5;// paralax1.y= game.camera.y*0.2; //move it down a few pixels to account for the missing pixels when moving with camera</td></tr><tr><td class="line-number" value="658"></td><td class="line-content">        paralax0.x= game.camera.x*0.3; //paralax0.y= game.camera.y*0.1;</td></tr><tr><td class="line-number" value="659"></td><td class="line-content">        if (gamestate=='running'){ playerInputActions(); }</td></tr><tr><td class="line-number" value="660"></td><td class="line-content">        else if (gamestate == 'lost'){ playerstate = 'die'; player.body.data.gravityScale=1; player.body.collideWorldBounds=false;}</td></tr><tr><td class="line-number" value="661"></td><td class="line-content">        else if (gamestate == 'win'){fadeOut(); playerstate = 'win'; player.body.collideWorldBounds=false;}</td></tr><tr><td class="line-number" value="662"></td><td class="line-content">        playerAnimations(player);</td></tr><tr><td class="line-number" value="663"></td><td class="line-content">        movingplatforms.forEach(movePlatforms,this);</td></tr><tr><td class="line-number" value="664"></td><td class="line-content">        enemies.forEach(moveAliveEnemy,this); // make sure bullets keep moving     //foreachAlive or foreach 1!!!????</td></tr><tr><td class="line-number" value="665"></td><td class="line-content">        layerforeground.bringToTop(); </td></tr><tr><td class="line-number" value="666"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="667"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="668"></td><td class="line-content"></td></tr><tr><td class="line-number" value="669"></td><td class="line-content"></td></tr><tr><td class="line-number" value="670"></td><td class="line-content"></td></tr><tr><td class="line-number" value="671"></td><td class="line-content">var Level6 = {</td></tr><tr><td class="line-number" value="672"></td><td class="line-content">    create: function () { </td></tr><tr><td class="line-number" value="673"></td><td class="line-content">        //reset state vars</td></tr><tr><td class="line-number" value="674"></td><td class="line-content">        gamestate='running';</td></tr><tr><td class="line-number" value="675"></td><td class="line-content">        climbing = false;</td></tr><tr><td class="line-number" value="676"></td><td class="line-content">        hanging = false;</td></tr><tr><td class="line-number" value="677"></td><td class="line-content">        music = game.add.audio('theme-under',1,true);  // key, voluem, loop</td></tr><tr><td class="line-number" value="678"></td><td class="line-content">        music.play('',0,2,true);  //wtf?  this plays the audio</td></tr><tr><td class="line-number" value="679"></td><td class="line-content">        //load beautiful backgrounds</td></tr><tr><td class="line-number" value="680"></td><td class="line-content">        sky = game.add.tileSprite(0, 0, 3200, 3000, 'starfield'); </td></tr><tr><td class="line-number" value="681"></td><td class="line-content">        paralax1 = game.add.tileSprite(0, 1600, 3200,  816, 'marioback');</td></tr><tr><td class="line-number" value="682"></td><td class="line-content">     //  paralax2 = game.add.tileSprite(0, 1600, 3200, 816, 'mariofront');</td></tr><tr><td class="line-number" value="683"></td><td class="line-content"></td></tr><tr><td class="line-number" value="684"></td><td class="line-content">        gameobjects = game.add.group();</td></tr><tr><td class="line-number" value="685"></td><td class="line-content">        textobjects = game.add.group();</td></tr><tr><td class="line-number" value="686"></td><td class="line-content">        controls = game.add.group();  //controls group is created after the gameobjects so they stay onTop</td></tr><tr><td class="line-number" value="687"></td><td class="line-content">        gameobjects.add(sky);</td></tr><tr><td class="line-number" value="688"></td><td class="line-content">        gameobjects.add(paralax1);</td></tr><tr><td class="line-number" value="689"></td><td class="line-content"></td></tr><tr><td class="line-number" value="690"></td><td class="line-content"></td></tr><tr><td class="line-number" value="691"></td><td class="line-content">        setupPhysics();</td></tr><tr><td class="line-number" value="692"></td><td class="line-content">        //initialise tilemap</td></tr><tr><td class="line-number" value="693"></td><td class="line-content">        map = game.add.tilemap('level5map');</td></tr><tr><td class="line-number" value="694"></td><td class="line-content">        map.addTilesetImage('mariotileset');</td></tr><tr><td class="line-number" value="695"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="696"></td><td class="line-content">        setupLayers();</td></tr><tr><td class="line-number" value="697"></td><td class="line-content">        setupControls();</td></tr><tr><td class="line-number" value="698"></td><td class="line-content">		createObjects();</td></tr><tr><td class="line-number" value="699"></td><td class="line-content">		</td></tr><tr><td class="line-number" value="700"></td><td class="line-content">        timerEvents[0]=game.time.events.loop(Phaser.Timer.SECOND * 4, resetBullets, this);  // let bullets fly through the world</td></tr><tr><td class="line-number" value="701"></td><td class="line-content">       </td></tr><tr><td class="line-number" value="702"></td><td class="line-content">        if (saved === true){setupPlayer(savepointX,savepointY);}</td></tr><tr><td class="line-number" value="703"></td><td class="line-content">        else {  setupPlayer(120,100); }        </td></tr><tr><td class="line-number" value="704"></td><td class="line-content">        createGhost(game.world.centerX, game.world.centerY);</td></tr><tr><td class="line-number" value="705"></td><td class="line-content">    },</td></tr><tr><td class="line-number" value="706"></td><td class="line-content">    update: function () {</td></tr><tr><td class="line-number" value="707"></td><td class="line-content">      //  paralax2.x= game.camera.x*0.1; //paralax2.y= game.camera.y*0.1+340;</td></tr><tr><td class="line-number" value="708"></td><td class="line-content">        paralax1.x= game.camera.x*0.2;// paralax1.y= game.camera.y*0.2+300; //move it down a few pixels to account for the missing pixels when moving with camera</td></tr><tr><td class="line-number" value="709"></td><td class="line-content">        sky.x = game.camera.x*0.1; sky.y=game.camera.y*0.1;</td></tr><tr><td class="line-number" value="710"></td><td class="line-content"></td></tr><tr><td class="line-number" value="711"></td><td class="line-content">        if (gamestate=='running'){ playerInputActions(); }</td></tr><tr><td class="line-number" value="712"></td><td class="line-content">        else if (gamestate == 'lost'){ playerstate = 'die'; player.body.data.gravityScale=1;player.body.collideWorldBounds=false;}</td></tr><tr><td class="line-number" value="713"></td><td class="line-content">        else if (gamestate == 'win'){  fadeOut();playerstate = 'win'; player.body.collideWorldBounds=false;}</td></tr><tr><td class="line-number" value="714"></td><td class="line-content">        playerAnimations(player);</td></tr><tr><td class="line-number" value="715"></td><td class="line-content">        movingplatforms.forEach(movePlatforms,this);</td></tr><tr><td class="line-number" value="716"></td><td class="line-content">        enemies.forEach(moveAliveEnemy,this); // make sure bullets keep moving     //foreachAlive or foreach 1!!!????</td></tr><tr><td class="line-number" value="717"></td><td class="line-content">        layerforeground.bringToTop();   // do it here so mario will be behind layerforeground (good for pipes for example)</td></tr><tr><td class="line-number" value="718"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="719"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="720"></td><td class="line-content"></td></tr><tr><td class="line-number" value="721"></td><td class="line-content"></td></tr><tr><td class="line-number" value="722"></td><td class="line-content"></td></tr><tr><td class="line-number" value="723"></td><td class="line-content"></td></tr><tr><td class="line-number" value="724"></td><td class="line-content"></td></tr><tr><td class="line-number" value="725"></td><td class="line-content">var LastLevel = {</td></tr><tr><td class="line-number" value="726"></td><td class="line-content">    create: function () { </td></tr><tr><td class="line-number" value="727"></td><td class="line-content">        //reset state vars</td></tr><tr><td class="line-number" value="728"></td><td class="line-content">        gamestate='running';</td></tr><tr><td class="line-number" value="729"></td><td class="line-content">        climbing = false;</td></tr><tr><td class="line-number" value="730"></td><td class="line-content">        hanging = false;</td></tr><tr><td class="line-number" value="731"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="732"></td><td class="line-content">        music = game.add.audio('theme3',1,true);  // key, voluem, loop</td></tr><tr><td class="line-number" value="733"></td><td class="line-content">        music.play('',0,3,true);  //wtf?  this plays the audio  (key?,?,volume,?)</td></tr><tr><td class="line-number" value="734"></td><td class="line-content">        //load beautiful backgrounds</td></tr><tr><td class="line-number" value="735"></td><td class="line-content">        sky = game.add.tileSprite(0, 0, worldwidth, worldheight, 'clouds'); </td></tr><tr><td class="line-number" value="736"></td><td class="line-content">        sky.fixedToCamera = true;</td></tr><tr><td class="line-number" value="737"></td><td class="line-content"></td></tr><tr><td class="line-number" value="738"></td><td class="line-content">        paralax1 = game.add.tileSprite(0, 0, 6600,  700, 'marioback');</td></tr><tr><td class="line-number" value="739"></td><td class="line-content">        paralax2 = game.add.tileSprite(0, 0, 6600, 700, 'mariomiddle-lightgreen');</td></tr><tr><td class="line-number" value="740"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="741"></td><td class="line-content">        gameobjects = game.add.group();</td></tr><tr><td class="line-number" value="742"></td><td class="line-content">        textobjects = game.add.group();</td></tr><tr><td class="line-number" value="743"></td><td class="line-content">        controls = game.add.group();  //controls group is created after the gameobjects so they stay onTop</td></tr><tr><td class="line-number" value="744"></td><td class="line-content">        gameobjects.add(sky);</td></tr><tr><td class="line-number" value="745"></td><td class="line-content">        gameobjects.add(paralax1);</td></tr><tr><td class="line-number" value="746"></td><td class="line-content">        gameobjects.add(paralax2);</td></tr><tr><td class="line-number" value="747"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="748"></td><td class="line-content">        setupPhysics();</td></tr><tr><td class="line-number" value="749"></td><td class="line-content">        //initialise tilemap</td></tr><tr><td class="line-number" value="750"></td><td class="line-content">        map = game.add.tilemap('flappymap');</td></tr><tr><td class="line-number" value="751"></td><td class="line-content">        map.addTilesetImage('mariotileset');</td></tr><tr><td class="line-number" value="752"></td><td class="line-content"></td></tr><tr><td class="line-number" value="753"></td><td class="line-content">        setupLayers();</td></tr><tr><td class="line-number" value="754"></td><td class="line-content">        setupControls();</td></tr><tr><td class="line-number" value="755"></td><td class="line-content">        timerEvents[0]=game.time.events.loop(Phaser.Timer.SECOND * 4, resetBullets, this);  // let bullets fly through the world</td></tr><tr><td class="line-number" value="756"></td><td class="line-content">        createObjects();</td></tr><tr><td class="line-number" value="757"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="758"></td><td class="line-content">        if (saved === true){setupPlayer(savepointX,savepointY);}</td></tr><tr><td class="line-number" value="759"></td><td class="line-content">        else {  setupPlayer(150,500); }</td></tr><tr><td class="line-number" value="760"></td><td class="line-content">      </td></tr><tr><td class="line-number" value="761"></td><td class="line-content">    },</td></tr><tr><td class="line-number" value="762"></td><td class="line-content">    update: function () {</td></tr><tr><td class="line-number" value="763"></td><td class="line-content">        paralax1.x= game.camera.x*0.2; //paralax1.y= game.camera.y*0.2; //move it down a few pixels to account for the missing pixels when moving with camera</td></tr><tr><td class="line-number" value="764"></td><td class="line-content">        paralax2.x= game.camera.x*0.1; //paralax2.y= game.camera.y*0.1;</td></tr><tr><td class="line-number" value="765"></td><td class="line-content">        enemies.forEach(moveAliveEnemy,this); // make sure bullets keep moving     //foreachAlive or foreach 1!!!????</td></tr><tr><td class="line-number" value="766"></td><td class="line-content">        if (gamestate=='running'){playerInputActions(); }</td></tr><tr><td class="line-number" value="767"></td><td class="line-content">        else if (gamestate == 'lost'){ playerstate = 'die'; player.body.data.gravityScale=1; player.body.collideWorldBounds=false;}</td></tr><tr><td class="line-number" value="768"></td><td class="line-content">        else if (gamestate == 'win'){fadeOut(); playerstate = 'win'; player.body.collideWorldBounds=false;}</td></tr><tr><td class="line-number" value="769"></td><td class="line-content">        playerAnimations(player);</td></tr><tr><td class="line-number" value="770"></td><td class="line-content">        movingplatforms.forEach(movePlatforms,this);</td></tr><tr><td class="line-number" value="771"></td><td class="line-content">        layerforeground.bringToTop();   // do it here so mario will be behind layerforeground (good for pipes for example)</td></tr><tr><td class="line-number" value="772"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="773"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="774"></td><td class="line-content"></td></tr><tr><td class="line-number" value="775"></td><td class="line-content"></td></tr><tr><td class="line-number" value="776"></td><td class="line-content"></td></tr><tr><td class="line-number" value="777"></td><td class="line-content"></td></tr><tr><td class="line-number" value="778"></td><td class="line-content"></td></tr><tr><td class="line-number" value="779"></td><td class="line-content"></td></tr><tr><td class="line-number" value="780"></td><td class="line-content">var Finish = {</td></tr><tr><td class="line-number" value="781"></td><td class="line-content">    create: function () {</td></tr><tr><td class="line-number" value="782"></td><td class="line-content">        music.pause();  // pause maintheme</td></tr><tr><td class="line-number" value="783"></td><td class="line-content">        sky=game.add.tileSprite(0, 0, worldwidth,worldheight, 'clouds');</td></tr><tr><td class="line-number" value="784"></td><td class="line-content">        game.world.setBounds(0, 0, worldwidth, worldheight);</td></tr><tr><td class="line-number" value="785"></td><td class="line-content"></td></tr><tr><td class="line-number" value="786"></td><td class="line-content">        var infoText1 = game.add.text(game.world.centerX, 70, 'World Cleared!', { fill: '#FFF', font: '40px Arial' });</td></tr><tr><td class="line-number" value="787"></td><td class="line-content">        infoText1.x= game.world.centerX-infoText1.width/2;</td></tr><tr><td class="line-number" value="788"></td><td class="line-content">        var infoText2 = game.add.text(game.world.centerX, 120, 'Score:'+ score, { fill: '#FFF', font: '22px Arial' });</td></tr><tr><td class="line-number" value="789"></td><td class="line-content">        infoText2.x= game.world.centerX-infoText2.width/2;</td></tr><tr><td class="line-number" value="790"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="791"></td><td class="line-content">        var button = game.add.button(game.world.centerX, game.world.centerY+50, 'button', startNextLevel, this, 1, 2, 2);</td></tr><tr><td class="line-number" value="792"></td><td class="line-content">        button.anchor.setTo(0.5, 0.5);</td></tr><tr><td class="line-number" value="793"></td><td class="line-content">    },</td></tr><tr><td class="line-number" value="794"></td><td class="line-content">    update: function() {</td></tr><tr><td class="line-number" value="795"></td><td class="line-content">        timer += 0.005</td></tr><tr><td class="line-number" value="796"></td><td class="line-content">        sky.tileScale.x = 2 + Math.sin(timer);</td></tr><tr><td class="line-number" value="797"></td><td class="line-content">        sky.tileScale.y = 2 + Math.cos(timer);</td></tr><tr><td class="line-number" value="798"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="799"></td><td class="line-content">        sky.tilePosition.x += 1;</td></tr><tr><td class="line-number" value="800"></td><td class="line-content">        sky.tilePosition.y += 1;</td></tr><tr><td class="line-number" value="801"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="802"></td><td class="line-content">    </td></tr><tr><td class="line-number" value="803"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="804"></td><td class="line-content"></td></tr><tr><td class="line-number" value="805"></td><td class="line-content"></td></tr><tr><td class="line-number" value="806"></td><td class="line-content"></td></tr><tr><td class="line-number" value="807"></td><td class="line-content">var EndGame = {</td></tr><tr><td class="line-number" value="808"></td><td class="line-content">    create: function () {</td></tr><tr><td class="line-number" value="809"></td><td class="line-content">        music.pause();  // pause maintheme</td></tr><tr><td class="line-number" value="810"></td><td class="line-content">        game.world.setBounds(0, 0, worldwidth, worldheight);</td></tr><tr><td class="line-number" value="811"></td><td class="line-content">       </td></tr><tr><td class="line-number" value="812"></td><td class="line-content">       if (player_lives &lt;= 0){  //catch the case this state is called because you are out of lives</td></tr><tr><td class="line-number" value="813"></td><td class="line-content">            game.sound.play('gameover');</td></tr><tr><td class="line-number" value="814"></td><td class="line-content">            sky=game.add.tileSprite(0, 0, worldwidth,worldheight, 'starfield');</td></tr><tr><td class="line-number" value="815"></td><td class="line-content">            var infoText3 = game.add.text(game.world.centerX, 70, 'Game Over!', { fill: '#FFF', font: '40px Arial' });</td></tr><tr><td class="line-number" value="816"></td><td class="line-content">            infoText3.x= game.world.centerX-infoText3.width/2;</td></tr><tr><td class="line-number" value="817"></td><td class="line-content">            var infoText1 = game.add.text(game.world.centerX, 120, 'Score:'+ score, { fill: '#FFF', font: '22px Arial' });</td></tr><tr><td class="line-number" value="818"></td><td class="line-content">            infoText1.x= game.world.centerX-infoText1.width/2;</td></tr><tr><td class="line-number" value="819"></td><td class="line-content">            var infoText2 = game.add.text(game.world.centerX, 160, 'Play Again?', { fill: '#FFF', font: '22px Arial' });</td></tr><tr><td class="line-number" value="820"></td><td class="line-content">            infoText2.x= game.world.centerX-infoText2.width/2;</td></tr><tr><td class="line-number" value="821"></td><td class="line-content">            score = 0;  // reset score</td></tr><tr><td class="line-number" value="822"></td><td class="line-content">            level = 0;  // reset level </td></tr><tr><td class="line-number" value="823"></td><td class="line-content">            saved = false;</td></tr><tr><td class="line-number" value="824"></td><td class="line-content">            player_lives=player_lives_reset;</td></tr><tr><td class="line-number" value="825"></td><td class="line-content">            var button = game.add.button(game.world.centerX, game.world.centerY+50, 'button', startNextLevel, this, 1, 2, 2);</td></tr><tr><td class="line-number" value="826"></td><td class="line-content">            button.anchor.setTo(0.5, 0.5);</td></tr><tr><td class="line-number" value="827"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="828"></td><td class="line-content">        else {  // normal state..  you finished the game</td></tr><tr><td class="line-number" value="829"></td><td class="line-content">            game.sound.play('finishedgame');</td></tr><tr><td class="line-number" value="830"></td><td class="line-content">            sky=game.add.tileSprite(0, 0, worldwidth,worldheight, 'clouds');</td></tr><tr><td class="line-number" value="831"></td><td class="line-content">            var infoText3 = game.add.text(game.world.centerX, 70, 'Congratulations!', { fill: '#FFF', font: '40px Arial' });</td></tr><tr><td class="line-number" value="832"></td><td class="line-content">            infoText3.x= game.world.centerX-infoText3.width/2;</td></tr><tr><td class="line-number" value="833"></td><td class="line-content">            var infoText1 = game.add.text(game.world.centerX, 120, 'You Rock!', { fill: '#FFF', font: '22px Arial' });</td></tr><tr><td class="line-number" value="834"></td><td class="line-content">            infoText1.x= game.world.centerX-infoText1.width/2;</td></tr><tr><td class="line-number" value="835"></td><td class="line-content">            var infoText2 = game.add.text(game.world.centerX, 160, 'Play Again?', { fill: '#FFF', font: '22px Arial' });</td></tr><tr><td class="line-number" value="836"></td><td class="line-content">            infoText2.x= game.world.centerX-infoText2.width/2;</td></tr><tr><td class="line-number" value="837"></td><td class="line-content">            </td></tr><tr><td class="line-number" value="838"></td><td class="line-content">            score = 0;  // reset score</td></tr><tr><td class="line-number" value="839"></td><td class="line-content">            level = 0;  // reset level    //or let the user chose now that he has finished the game?</td></tr><tr><td class="line-number" value="840"></td><td class="line-content">            saved = false;</td></tr><tr><td class="line-number" value="841"></td><td class="line-content">            player_lives=player_lives_reset;</td></tr><tr><td class="line-number" value="842"></td><td class="line-content">            var button = game.add.button(game.world.centerX, game.world.centerY+50, 'button', startNextLevel, this, 1, 2, 2);</td></tr><tr><td class="line-number" value="843"></td><td class="line-content">            button.anchor.setTo(0.5, 0.5);</td></tr><tr><td class="line-number" value="844"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="845"></td><td class="line-content">    },</td></tr><tr><td class="line-number" value="846"></td><td class="line-content">    update: function() {</td></tr><tr><td class="line-number" value="847"></td><td class="line-content">        timer += 0.005</td></tr><tr><td class="line-number" value="848"></td><td class="line-content">   //     sky.tileScale.x = 2 + Math.sin(timer);</td></tr><tr><td class="line-number" value="849"></td><td class="line-content">    //    sky.tileScale.y = 2 + Math.cos(timer);</td></tr><tr><td class="line-number" value="850"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="851"></td><td class="line-content">        sky.tilePosition.x += 1;</td></tr><tr><td class="line-number" value="852"></td><td class="line-content">        sky.tilePosition.y += 1;</td></tr><tr><td class="line-number" value="853"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="854"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="855"></td><td class="line-content"></td></tr><tr><td class="line-number" value="856"></td><td class="line-content"></td></tr><tr><td class="line-number" value="857"></td><td class="line-content"></td></tr><tr><td class="line-number" value="858"></td><td class="line-content"></td></tr><tr><td class="line-number" value="859"></td><td class="line-content"></td></tr><tr><td class="line-number" value="860"></td><td class="line-content"></td></tr><tr><td class="line-number" value="861"></td><td class="line-content"></td></tr><tr><td class="line-number" value="862"></td><td class="line-content"></td></tr><tr><td class="line-number" value="863"></td><td class="line-content"></td></tr><tr><td class="line-number" value="864"></td><td class="line-content"></td></tr><tr><td class="line-number" value="865"></td><td class="line-content"></td></tr><tr><td class="line-number" value="866"></td><td class="line-content"></td></tr><tr><td class="line-number" value="867"></td><td class="line-content"></td></tr><tr><td class="line-number" value="868"></td><td class="line-content"></td></tr><tr><td class="line-number" value="869"></td><td class="line-content"></td></tr><tr><td class="line-number" value="870"></td><td class="line-content"></td></tr><tr><td class="line-number" value="871"></td><td class="line-content">// this is for mobile devices</td></tr><tr><td class="line-number" value="872"></td><td class="line-content">function fadeOut(){</td></tr><tr><td class="line-number" value="873"></td><td class="line-content">    timer += 0.01;</td></tr><tr><td class="line-number" value="874"></td><td class="line-content">    fadeoutSprite.alpha += timer*0.01;</td></tr><tr><td class="line-number" value="875"></td><td class="line-content">    if (fadeoutSprite.scale.x &gt;1){fadeoutSprite.scale.x = fadeoutSprite.scale.y  = 4 + timer * -1;}</td></tr><tr><td class="line-number" value="876"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="877"></td><td class="line-content">function enterIncorrectOrientation () { game.orientated =false; game.paused = true;}</td></tr><tr><td class="line-number" value="878"></td><td class="line-content">function leaveIncorrectOrientation () { game.orientated =true; game.paused = false;}</td></tr><tr><td class="line-number" value="879"></td><td class="line-content">function gofull() { game.scale.startFullScreen(false);}</td></tr><tr><td class="line-number" value="880"></td><td class="line-content">function setupPlayer(playerX,playerY){</td></tr><tr><td class="line-number" value="881"></td><td class="line-content">    if (player_health == 3 ){ player = game.add.sprite(playerX, playerY, 'mariowhite'); }</td></tr><tr><td class="line-number" value="882"></td><td class="line-content">    else { player = game.add.sprite(playerX, playerY, 'mario');}</td></tr><tr><td class="line-number" value="883"></td><td class="line-content">    game.physics.p2.enable(player,false); </td></tr><tr><td class="line-number" value="884"></td><td class="line-content">    player.health=player_health;</td></tr><tr><td class="line-number" value="885"></td><td class="line-content">    player.name='mario';</td></tr><tr><td class="line-number" value="886"></td><td class="line-content">    player.chain = player_chain;</td></tr><tr><td class="line-number" value="887"></td><td class="line-content">    player.body.fixedRotation=true; </td></tr><tr><td class="line-number" value="888"></td><td class="line-content">    if (player_health == 1){  //need to set it AFTER fixedRotation otherwise materials wont work (BUG)</td></tr><tr><td class="line-number" value="889"></td><td class="line-content">        player.scale.setTo(0.8,0.8);</td></tr><tr><td class="line-number" value="890"></td><td class="line-content">        playershape = player.body.setCircle(15,0,4);</td></tr><tr><td class="line-number" value="891"></td><td class="line-content">    }else {</td></tr><tr><td class="line-number" value="892"></td><td class="line-content">        playershape = player.body.setCircle(20,0,4);</td></tr><tr><td class="line-number" value="893"></td><td class="line-content">    }    </td></tr><tr><td class="line-number" value="894"></td><td class="line-content">    player.body.data.gravityScale=1;</td></tr><tr><td class="line-number" value="895"></td><td class="line-content">    player.body.allowSleep=true; </td></tr><tr><td class="line-number" value="896"></td><td class="line-content">    player.body.setCollisionGroup(playerCG);</td></tr><tr><td class="line-number" value="897"></td><td class="line-content">    player.body.setMaterial(playerMaterial);</td></tr><tr><td class="line-number" value="898"></td><td class="line-content">    player.body.collides([groundCG,platformCG, finishlineCG,enemyAirCG,enemyGroundCG,enemyStaticCG,questionmarkCG,powerupsCG]);</td></tr><tr><td class="line-number" value="899"></td><td class="line-content">    player.body.createGroupCallback(questionmarkCG, hitQuestionmark, this);        //set some collision callbacks</td></tr><tr><td class="line-number" value="900"></td><td class="line-content">    player.body.createGroupCallback(enemyAirCG, playerHit, this);</td></tr><tr><td class="line-number" value="901"></td><td class="line-content">    player.body.createGroupCallback(enemyGroundCG, playerHit, this);</td></tr><tr><td class="line-number" value="902"></td><td class="line-content">    player.body.createGroupCallback(enemyStaticCG, playerHit, this);</td></tr><tr><td class="line-number" value="903"></td><td class="line-content">    player.body.createGroupCallback(powerupsCG, collectPowerup, this);</td></tr><tr><td class="line-number" value="904"></td><td class="line-content">    player.body.createGroupCallback(finishlineCG, finishWorld);</td></tr><tr><td class="line-number" value="905"></td><td class="line-content"></td></tr><tr><td class="line-number" value="906"></td><td class="line-content">    setupPlayerLooks(player);</td></tr><tr><td class="line-number" value="907"></td><td class="line-content">    </td></tr><tr><td class="line-number" value="908"></td><td class="line-content">    game.camera.follow(player);  // self explanatory</td></tr><tr><td class="line-number" value="909"></td><td class="line-content">    //add group for fireballs</td></tr><tr><td class="line-number" value="910"></td><td class="line-content">    fireballs = game.add.group();</td></tr><tr><td class="line-number" value="911"></td><td class="line-content">    fireballs.createMultiple(20, 'fireball', 0, false);  //prepopulate group</td></tr><tr><td class="line-number" value="912"></td><td class="line-content">    //mario smokes on jump ^^</td></tr><tr><td class="line-number" value="913"></td><td class="line-content">    emitter = game.add.emitter(0, 0, 200);</td></tr><tr><td class="line-number" value="914"></td><td class="line-content">    emitter.makeParticles('smoke',0,200,true,true);</td></tr><tr><td class="line-number" value="915"></td><td class="line-content">    emitter.enableBody = true;</td></tr><tr><td class="line-number" value="916"></td><td class="line-content">    emitter.physicsBodyType = Phaser.Physics.P2JS;</td></tr><tr><td class="line-number" value="917"></td><td class="line-content">    emitter.setYSpeed(-250, 0);</td></tr><tr><td class="line-number" value="918"></td><td class="line-content">    </td></tr><tr><td class="line-number" value="919"></td><td class="line-content">    emitter1 = game.add.emitter(0, 0, 200);</td></tr><tr><td class="line-number" value="920"></td><td class="line-content">    emitter1.makeParticles('blitz',0,20,true,true);</td></tr><tr><td class="line-number" value="921"></td><td class="line-content"></td></tr><tr><td class="line-number" value="922"></td><td class="line-content">	createWeapon(weapon_selected);</td></tr><tr><td class="line-number" value="923"></td><td class="line-content">    </td></tr><tr><td class="line-number" value="924"></td><td class="line-content">    anchorgroup = game.add.group();</td></tr><tr><td class="line-number" value="925"></td><td class="line-content"></td></tr><tr><td class="line-number" value="926"></td><td class="line-content">    gameobjects.add(player);</td></tr><tr><td class="line-number" value="927"></td><td class="line-content">    gameobjects.add(fireballs);</td></tr><tr><td class="line-number" value="928"></td><td class="line-content">    gameobjects.add(emitter);</td></tr><tr><td class="line-number" value="929"></td><td class="line-content">    gameobjects.add(emitter1);</td></tr><tr><td class="line-number" value="930"></td><td class="line-content">//  gameobjects.add(anchorgroup);</td></tr><tr><td class="line-number" value="931"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="932"></td><td class="line-content"></td></tr><tr><td class="line-number" value="933"></td><td class="line-content"></td></tr><tr><td class="line-number" value="934"></td><td class="line-content"></td></tr><tr><td class="line-number" value="935"></td><td class="line-content"></td></tr><tr><td class="line-number" value="936"></td><td class="line-content"></td></tr><tr><td class="line-number" value="937"></td><td class="line-content"></td></tr><tr><td class="line-number" value="938"></td><td class="line-content">function createWeapon(weapon){</td></tr><tr><td class="line-number" value="939"></td><td class="line-content">	if (weapon == 'sword'){</td></tr><tr><td class="line-number" value="940"></td><td class="line-content">		sword = game.add.sprite(player.x, player.y, 'sword');</td></tr><tr><td class="line-number" value="941"></td><td class="line-content">		game.physics.p2.enable(sword,false);</td></tr><tr><td class="line-number" value="942"></td><td class="line-content">		sword.body.setRectangle(6,45,0,-45);</td></tr><tr><td class="line-number" value="943"></td><td class="line-content">		sword.body.data.gravityScale=0;</td></tr><tr><td class="line-number" value="944"></td><td class="line-content">		sword.body.setCollisionGroup(fireballCG);</td></tr><tr><td class="line-number" value="945"></td><td class="line-content">		sword.body.collides([enemyAirCG,enemyGroundCG,powerupsCG]);</td></tr><tr><td class="line-number" value="946"></td><td class="line-content">		sword.body.createGroupCallback(enemyAirCG, swordCollision, this);</td></tr><tr><td class="line-number" value="947"></td><td class="line-content">		sword.body.createGroupCallback(enemyGroundCG, swordCollision, this);</td></tr><tr><td class="line-number" value="948"></td><td class="line-content">		sword.body.dynamic=true;</td></tr><tr><td class="line-number" value="949"></td><td class="line-content">		sword.body.fixedRotation=true;</td></tr><tr><td class="line-number" value="950"></td><td class="line-content">		sword.pivot.y =30;</td></tr><tr><td class="line-number" value="951"></td><td class="line-content">		sword.body.angle= 0;</td></tr><tr><td class="line-number" value="952"></td><td class="line-content">		sword.body.mass = 0.1;</td></tr><tr><td class="line-number" value="953"></td><td class="line-content">		swordRC = game.physics.p2.createRevoluteConstraint(sword , [0,0],player, [0,8], 10000)</td></tr><tr><td class="line-number" value="954"></td><td class="line-content">		gameobjects.add(sword);</td></tr><tr><td class="line-number" value="955"></td><td class="line-content">		player.bringToTop();</td></tr><tr><td class="line-number" value="956"></td><td class="line-content">	}</td></tr><tr><td class="line-number" value="957"></td><td class="line-content">	else if (weapon == 'fireflower'){</td></tr><tr><td class="line-number" value="958"></td><td class="line-content">		gun1 = game.add.sprite(player.x, player.y, 'gun1');</td></tr><tr><td class="line-number" value="959"></td><td class="line-content">		game.physics.p2.enable(gun1,true);</td></tr><tr><td class="line-number" value="960"></td><td class="line-content">		gun1.body.data.gravityScale=0;</td></tr><tr><td class="line-number" value="961"></td><td class="line-content">		gun1.body.mass = 0.1;</td></tr><tr><td class="line-number" value="962"></td><td class="line-content">		gun1.body.dynamic=true;</td></tr><tr><td class="line-number" value="963"></td><td class="line-content">		gun1.body.angle= 0;</td></tr><tr><td class="line-number" value="964"></td><td class="line-content">		gun1.body.data.shapes[0].sensor=true;</td></tr><tr><td class="line-number" value="965"></td><td class="line-content">		gun1.body.setRectangle(1,1,0,0);</td></tr><tr><td class="line-number" value="966"></td><td class="line-content">		gun1.anchor.setTo(0,0.5);</td></tr><tr><td class="line-number" value="967"></td><td class="line-content">		gun1.angle= 0;</td></tr><tr><td class="line-number" value="968"></td><td class="line-content">		gun1RC = game.physics.p2.createRevoluteConstraint(gun1 , [0,0],player, [0,8], 10000)</td></tr><tr><td class="line-number" value="969"></td><td class="line-content">		gameobjects.add(gun1);</td></tr><tr><td class="line-number" value="970"></td><td class="line-content">		player.bringToTop();</td></tr><tr><td class="line-number" value="971"></td><td class="line-content">	}</td></tr><tr><td class="line-number" value="972"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="973"></td><td class="line-content">function destroyWeapon(weapon){</td></tr><tr><td class="line-number" value="974"></td><td class="line-content">	if (weapon == 'sword'){</td></tr><tr><td class="line-number" value="975"></td><td class="line-content">		sword.destroy();</td></tr><tr><td class="line-number" value="976"></td><td class="line-content">		game.physics.p2.removeConstraint(swordRC);</td></tr><tr><td class="line-number" value="977"></td><td class="line-content">	}</td></tr><tr><td class="line-number" value="978"></td><td class="line-content">	else if (weapon == 'fireflower'){</td></tr><tr><td class="line-number" value="979"></td><td class="line-content">		gun1.destroy();</td></tr><tr><td class="line-number" value="980"></td><td class="line-content">		game.physics.p2.removeConstraint(gun1RC);</td></tr><tr><td class="line-number" value="981"></td><td class="line-content">	}</td></tr><tr><td class="line-number" value="982"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="983"></td><td class="line-content"></td></tr><tr><td class="line-number" value="984"></td><td class="line-content"></td></tr><tr><td class="line-number" value="985"></td><td class="line-content"></td></tr><tr><td class="line-number" value="986"></td><td class="line-content"></td></tr><tr><td class="line-number" value="987"></td><td class="line-content"></td></tr><tr><td class="line-number" value="988"></td><td class="line-content">function swordCollision(sword,object1){</td></tr><tr><td class="line-number" value="989"></td><td class="line-content">    if (object1.sprite &amp;&amp; object1.sprite.parent == enemies) {   //if the hit body is a sprite and belongs to enemies</td></tr><tr><td class="line-number" value="990"></td><td class="line-content">        blitz(object1.sprite,1);</td></tr><tr><td class="line-number" value="991"></td><td class="line-content">        killEnemy(object1);</td></tr><tr><td class="line-number" value="992"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="993"></td><td class="line-content">} </td></tr><tr><td class="line-number" value="994"></td><td class="line-content">function blitz(source,count) {</td></tr><tr><td class="line-number" value="995"></td><td class="line-content">    emitter1.x = source.body.x;</td></tr><tr><td class="line-number" value="996"></td><td class="line-content">    emitter1.y = source.body.y;</td></tr><tr><td class="line-number" value="997"></td><td class="line-content">    emitter1.start(true, 100, null, count);   //explode, lifespan, .. , count</td></tr><tr><td class="line-number" value="998"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="999"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1000"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1001"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1002"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1003"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1004"></td><td class="line-content">function setupPlayerLooks(player, color){</td></tr><tr><td class="line-number" value="1005"></td><td class="line-content">    if (color) {player.loadTexture(color,5);}</td></tr><tr><td class="line-number" value="1006"></td><td class="line-content">    player.animations.add('walk', [1,2,3,4,3,2], 10, true);</td></tr><tr><td class="line-number" value="1007"></td><td class="line-content">    player.animations.add('duckwalk', [10,11,12], 3, true);</td></tr><tr><td class="line-number" value="1008"></td><td class="line-content">    player.animations.add('climb',[13,14,15,16],5,true);</td></tr><tr><td class="line-number" value="1009"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="1010"></td><td class="line-content">function playerAnimations(player) {</td></tr><tr><td class="line-number" value="1011"></td><td class="line-content">    if (playerstate === 'jump') { player.animations.stop(); player.frame = 5;}</td></tr><tr><td class="line-number" value="1012"></td><td class="line-content">    else if (playerstate === 'die')  { player.animations.stop(); player.frame = 6;}</td></tr><tr><td class="line-number" value="1013"></td><td class="line-content">    else if (playerstate === 'win')  { player.animations.stop(); player.frame = 7;}</td></tr><tr><td class="line-number" value="1014"></td><td class="line-content">    else if (playerstate === 'fire') { player.animations.stop(); }</td></tr><tr><td class="line-number" value="1015"></td><td class="line-content">    else if (playerstate === 'fall') { player.animations.stop(); player.frame = 9;}</td></tr><tr><td class="line-number" value="1016"></td><td class="line-content">    else if (playerstate === 'duck') { player.animations.stop(); player.frame = 11;}</td></tr><tr><td class="line-number" value="1017"></td><td class="line-content">    else if (playerstate === 'hang') { player.animations.stop(); player.frame = 14;}</td></tr><tr><td class="line-number" value="1018"></td><td class="line-content">    else if (playerstate === 'walk') { player.animations.play('walk');}</td></tr><tr><td class="line-number" value="1019"></td><td class="line-content">    else if (playerstate === 'duckwalk') { player.animations.play('duckwalk');}</td></tr><tr><td class="line-number" value="1020"></td><td class="line-content">    else if (playerstate === 'climb') { player.animations.play('climb');}</td></tr><tr><td class="line-number" value="1021"></td><td class="line-content">    else { player.animations.stop(); player.frame = 0; }</td></tr><tr><td class="line-number" value="1022"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="1023"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1024"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1025"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1026"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1027"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1028"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1029"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1030"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1031"></td><td class="line-content">function setupPhysics(){</td></tr><tr><td class="line-number" value="1032"></td><td class="line-content">    //start physics system and enable "expensive" collision events</td></tr><tr><td class="line-number" value="1033"></td><td class="line-content">    game.physics.startSystem(Phaser.Physics.P2JS);</td></tr><tr><td class="line-number" value="1034"></td><td class="line-content">    game.physics.p2.setImpactEvents(true);</td></tr><tr><td class="line-number" value="1035"></td><td class="line-content">    //  game.world.setBounds(0, 0, 3200, 1024); //(x, y, width, height, left, right, top, bottom, setCollisionGroup)</td></tr><tr><td class="line-number" value="1036"></td><td class="line-content">    game.physics.defaultRestitution = 0 ;</td></tr><tr><td class="line-number" value="1037"></td><td class="line-content">    game.physics.p2.gravity.y = 1400;</td></tr><tr><td class="line-number" value="1038"></td><td class="line-content">    game.world.enableBodySleeping=true;  //allow bodies to not get calculated when there is nothing to do</td></tr><tr><td class="line-number" value="1039"></td><td class="line-content">    game.stage.smoothed = false;  // no antialiasing</td></tr><tr><td class="line-number" value="1040"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1041"></td><td class="line-content">    //define materials</td></tr><tr><td class="line-number" value="1042"></td><td class="line-content">    groundMaterial = game.physics.p2.createMaterial('ground');</td></tr><tr><td class="line-number" value="1043"></td><td class="line-content">    playerMaterial = game.physics.p2.createMaterial('player');</td></tr><tr><td class="line-number" value="1044"></td><td class="line-content">    iceMaterial = game.physics.p2.createMaterial('ice');</td></tr><tr><td class="line-number" value="1045"></td><td class="line-content">    slantMaterial = game.physics.p2.createMaterial('slide');</td></tr><tr><td class="line-number" value="1046"></td><td class="line-content">    fireballMaterial = game.physics.p2.createMaterial('fireball');</td></tr><tr><td class="line-number" value="1047"></td><td class="line-content">    slantMaterial = game.physics.p2.createMaterial();</td></tr><tr><td class="line-number" value="1048"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1049"></td><td class="line-content">    // define what happens when one material contacts the other</td></tr><tr><td class="line-number" value="1050"></td><td class="line-content">    game.physics.p2.createContactMaterial(fireballMaterial, groundMaterial, { friction: 0.3 , restitution: 0.6 });</td></tr><tr><td class="line-number" value="1051"></td><td class="line-content">    game.physics.p2.createContactMaterial(playerMaterial, groundMaterial, { friction: 2, restitution: 0  }); </td></tr><tr><td class="line-number" value="1052"></td><td class="line-content">    game.physics.p2.createContactMaterial(playerMaterial, iceMaterial, { friction: 0.1, restitution: 0 }); </td></tr><tr><td class="line-number" value="1053"></td><td class="line-content">    game.physics.p2.createContactMaterial(playerMaterial, slantMaterial, { friction: 0.6, restitution: 0 });   //mostly polygon objects</td></tr><tr><td class="line-number" value="1054"></td><td class="line-content">    game.physics.p2.createContactMaterial(iceMaterial, groundMaterial, { friction: 0, restitution: 0 })   //powerups are ice material too</td></tr><tr><td class="line-number" value="1055"></td><td class="line-content">    game.physics.p2.createContactMaterial(iceMaterial, iceMaterial, { friction: 0, restitution: 0 })</td></tr><tr><td class="line-number" value="1056"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1057"></td><td class="line-content">    //define collisiongroups</td></tr><tr><td class="line-number" value="1058"></td><td class="line-content">    playerCG = game.physics.p2.createCollisionGroup();</td></tr><tr><td class="line-number" value="1059"></td><td class="line-content">    enemyAirCG = game.physics.p2.createCollisionGroup();</td></tr><tr><td class="line-number" value="1060"></td><td class="line-content">    enemyGroundCG = game.physics.p2.createCollisionGroup();</td></tr><tr><td class="line-number" value="1061"></td><td class="line-content">    enemyStaticCG = game.physics.p2.createCollisionGroup();</td></tr><tr><td class="line-number" value="1062"></td><td class="line-content">    enemyboundsCG = game.physics.p2.createCollisionGroup();</td></tr><tr><td class="line-number" value="1063"></td><td class="line-content">    groundCG = game.physics.p2.createCollisionGroup();</td></tr><tr><td class="line-number" value="1064"></td><td class="line-content">    platformCG = game.physics.p2.createCollisionGroup();</td></tr><tr><td class="line-number" value="1065"></td><td class="line-content">    fireballCG = game.physics.p2.createCollisionGroup();</td></tr><tr><td class="line-number" value="1066"></td><td class="line-content">    questionmarkCG = game.physics.p2.createCollisionGroup();</td></tr><tr><td class="line-number" value="1067"></td><td class="line-content">    powerupsCG = game.physics.p2.createCollisionGroup();</td></tr><tr><td class="line-number" value="1068"></td><td class="line-content">    finishlineCG = game.physics.p2.createCollisionGroup();</td></tr><tr><td class="line-number" value="1069"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1070"></td><td class="line-content">    game.physics.p2.world.on("preSolve", onPresolve)</td></tr><tr><td class="line-number" value="1071"></td><td class="line-content">    //prevent rightclick contextmenu</td></tr><tr><td class="line-number" value="1072"></td><td class="line-content">	game.canvas.oncontextmenu = function (e) {	e.preventDefault();	};</td></tr><tr><td class="line-number" value="1073"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="1074"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1075"></td><td class="line-content">// check in the on presolve function if the player will collide with a jumpthrough platform and let him through if coming from below</td></tr><tr><td class="line-number" value="1076"></td><td class="line-content">function onPresolve(presolve){</td></tr><tr><td class="line-number" value="1077"></td><td class="line-content">    isPlayer = false;</td></tr><tr><td class="line-number" value="1078"></td><td class="line-content">    for (var i = 0; i &lt; presolve.contactEquations.length; i++) {  //cycle through all contact equations</td></tr><tr><td class="line-number" value="1079"></td><td class="line-content">        c = presolve.contactEquations[i]</td></tr><tr><td class="line-number" value="1080"></td><td class="line-content">        f = presolve.frictionEquations[i];</td></tr><tr><td class="line-number" value="1081"></td><td class="line-content">        yAxis = p2.vec2.fromValues(0, 1);</td></tr><tr><td class="line-number" value="1082"></td><td class="line-content">        y = p2.vec2.dot(c.normalA, yAxis);</td></tr><tr><td class="line-number" value="1083"></td><td class="line-content">        if (c.bodyA.parent &amp;&amp; c.bodyA.parent.sprite &amp;&amp; c.bodyA.parent.sprite.name === 'mario'){  // check for player</td></tr><tr><td class="line-number" value="1084"></td><td class="line-content">            isPlayer = true;</td></tr><tr><td class="line-number" value="1085"></td><td class="line-content">            if (c.bodyB.parent.sprite &amp;&amp; c.bodyB.parent.sprite.key == 'movingplatforms' &amp;&amp; y &gt;= 0){  //check for platform and if player is moving upwards</td></tr><tr><td class="line-number" value="1086"></td><td class="line-content">                c.enabled = false   //disable contactEquation</td></tr><tr><td class="line-number" value="1087"></td><td class="line-content">                if (f) f.enabled = false   //disable frictionEquation (solves the stuckInPlatform problem) if there is friction</td></tr><tr><td class="line-number" value="1088"></td><td class="line-content">                if (c.bodyA.parent.velocity.destination[1] &lt; 15 ){ // velocity &lt; 15 - still inside the platform</td></tr><tr><td class="line-number" value="1089"></td><td class="line-content">                    c.bodyA.parent.velocity.destination[1]-= 0.5;     // course correction!</td></tr><tr><td class="line-number" value="1090"></td><td class="line-content">                } </td></tr><tr><td class="line-number" value="1091"></td><td class="line-content">            }</td></tr><tr><td class="line-number" value="1092"></td><td class="line-content">            if (y &lt;= -0.4){onAir = false;} else {onAir = true;}</td></tr><tr><td class="line-number" value="1093"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1094"></td><td class="line-content">        else if (c.bodyB.parent &amp;&amp; c.bodyB.parent.sprite &amp;&amp; c.bodyB.parent.sprite.name === 'mario'){  // check for player</td></tr><tr><td class="line-number" value="1095"></td><td class="line-content">            isPlayer = true;</td></tr><tr><td class="line-number" value="1096"></td><td class="line-content">            if (c.bodyA.parent.sprite &amp;&amp; c.bodyA.parent.sprite.key == 'movingplatforms' &amp;&amp; y &gt;= 0){  //check for platform and if player is moving upwards</td></tr><tr><td class="line-number" value="1097"></td><td class="line-content">                c.enabled = false   //disable contactEquation</td></tr><tr><td class="line-number" value="1098"></td><td class="line-content">                if (f) f.enabled = false   //disable frictionEquation (solves the stuckInPlatform problem) if there is friction</td></tr><tr><td class="line-number" value="1099"></td><td class="line-content">                if (c.bodyB.parent.velocity.destination[1] &lt; 15 ){ // velocity &lt; 15 - still inside the platform</td></tr><tr><td class="line-number" value="1100"></td><td class="line-content">                    c.bodyB.parent.velocity.destination[1]-= 0.5;     // course correction!</td></tr><tr><td class="line-number" value="1101"></td><td class="line-content">                } </td></tr><tr><td class="line-number" value="1102"></td><td class="line-content">            }</td></tr><tr><td class="line-number" value="1103"></td><td class="line-content">            if (y &lt;= -0.4){onAir = false;} else {onAir = true;}</td></tr><tr><td class="line-number" value="1104"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1105"></td><td class="line-content">        if (isPlayer == false){ onAir = true; }  // only set anAir to true if mario definitely was not in any of the equations</td></tr><tr><td class="line-number" value="1106"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1107"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="1108"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1109"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1110"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1111"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1112"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1113"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1114"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1115"></td><td class="line-content">function setupControls(){</td></tr><tr><td class="line-number" value="1116"></td><td class="line-content">    //input elements</td></tr><tr><td class="line-number" value="1117"></td><td class="line-content">    cursors= {</td></tr><tr><td class="line-number" value="1118"></td><td class="line-content">        up: game.input.keyboard.addKey(Phaser.Keyboard.W),</td></tr><tr><td class="line-number" value="1119"></td><td class="line-content">        left: game.input.keyboard.addKey(Phaser.Keyboard.A),</td></tr><tr><td class="line-number" value="1120"></td><td class="line-content">        down: game.input.keyboard.addKey(Phaser.Keyboard.S),</td></tr><tr><td class="line-number" value="1121"></td><td class="line-content">        right: game.input.keyboard.addKey(Phaser.Keyboard.D),</td></tr><tr><td class="line-number" value="1122"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1123"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1124"></td><td class="line-content">// 	cursors= {</td></tr><tr><td class="line-number" value="1125"></td><td class="line-content">//         up: game.input.keyboard.addKey(Phaser.Keyboard.P),</td></tr><tr><td class="line-number" value="1126"></td><td class="line-content">//         left: game.input.keyboard.addKey(Phaser.Keyboard.E),</td></tr><tr><td class="line-number" value="1127"></td><td class="line-content">//         down: game.input.keyboard.addKey(Phaser.Keyboard.I),</td></tr><tr><td class="line-number" value="1128"></td><td class="line-content">//         right: game.input.keyboard.addKey(Phaser.Keyboard.U),</td></tr><tr><td class="line-number" value="1129"></td><td class="line-content">//     }</td></tr><tr><td class="line-number" value="1130"></td><td class="line-content">// 	</td></tr><tr><td class="line-number" value="1131"></td><td class="line-content">    jumpKey = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);</td></tr><tr><td class="line-number" value="1132"></td><td class="line-content">    jumpKey.onDown.add(jump_now, this);  //doing this here so the event gets only fired once when the key is just pressed down so you have to press it again to jump again</td></tr><tr><td class="line-number" value="1133"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1134"></td><td class="line-content">    //this is for mobile only (display fullscreen and virtual gamecontroller)</td></tr><tr><td class="line-number" value="1135"></td><td class="line-content">    if (!game.device.desktop){</td></tr><tr><td class="line-number" value="1136"></td><td class="line-content">// 		game.input.onDown.add(gofull, this);</td></tr><tr><td class="line-number" value="1137"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="1138"></td><td class="line-content">        if (level == levels){  // the last level (flappy style with different controller)</td></tr><tr><td class="line-number" value="1139"></td><td class="line-content">            // create our virtual game controller buttons </td></tr><tr><td class="line-number" value="1140"></td><td class="line-content">            buttonjump = game.add.button(5, game.camera.height-112, 'buttonjump', null, this, 0, 1, 0, 1);  //game, x, y, key, callback, callbackContext, overFrame, outFrame, downFrame, upFrame</td></tr><tr><td class="line-number" value="1141"></td><td class="line-content">            buttonjump.fixedToCamera = true;  //our buttons should stay on the same place  </td></tr><tr><td class="line-number" value="1142"></td><td class="line-content">            buttonjump.events.onInputOver.add(function(){jump=true;jump_now()});</td></tr><tr><td class="line-number" value="1143"></td><td class="line-content">            buttonjump.events.onInputOut.add(function(){jump=false;});</td></tr><tr><td class="line-number" value="1144"></td><td class="line-content">            buttonjump.events.onInputDown.add(function(){jump=true;jump_now()});</td></tr><tr><td class="line-number" value="1145"></td><td class="line-content">            buttonjump.events.onInputUp.add(function(){jump=false;});</td></tr><tr><td class="line-number" value="1146"></td><td class="line-content">            controls.add(buttonjump);</td></tr><tr><td class="line-number" value="1147"></td><td class="line-content">            </td></tr><tr><td class="line-number" value="1148"></td><td class="line-content">            buttonfire = game.add.button(game.camera.width-100, game.camera.height-112, 'buttonfire', null, this, 0, 1, 0, 1);</td></tr><tr><td class="line-number" value="1149"></td><td class="line-content">            buttonfire.fixedToCamera = true;</td></tr><tr><td class="line-number" value="1150"></td><td class="line-content">            buttonfire.events.onInputOver.add(function(){fire=true;fire_now(buttonfire)});</td></tr><tr><td class="line-number" value="1151"></td><td class="line-content">            buttonfire.events.onInputOut.add(function(){fire=false;});</td></tr><tr><td class="line-number" value="1152"></td><td class="line-content">            buttonfire.events.onInputDown.add(function(){fire=true;fire_now(buttonfire)});</td></tr><tr><td class="line-number" value="1153"></td><td class="line-content">            buttonfire.events.onInputUp.add(function(){fire=false;});</td></tr><tr><td class="line-number" value="1154"></td><td class="line-content">            controls.add(buttonfire);</td></tr><tr><td class="line-number" value="1155"></td><td class="line-content">        }else {</td></tr><tr><td class="line-number" value="1156"></td><td class="line-content">            buttonanchor = game.add.button(game.camera.width-60, game.camera.height-180, 'buttonanchor', null, this, 0, 1, 0, 1);</td></tr><tr><td class="line-number" value="1157"></td><td class="line-content">            buttonanchor.fixedToCamera = true;</td></tr><tr><td class="line-number" value="1158"></td><td class="line-content">            buttonanchor.anchor.setTo(0.5,0.5);</td></tr><tr><td class="line-number" value="1159"></td><td class="line-content">            buttonanchor.events.onInputOver.add(function(){anchorfire=true;shootSensor(buttonanchor)});</td></tr><tr><td class="line-number" value="1160"></td><td class="line-content">            buttonanchor.events.onInputOut.add(function(){anchorfire=false;});</td></tr><tr><td class="line-number" value="1161"></td><td class="line-content">            buttonanchor.events.onInputDown.add(function(){anchorfire=true;shootSensor(buttonanchor)});</td></tr><tr><td class="line-number" value="1162"></td><td class="line-content">            buttonanchor.events.onInputUp.add(function(){anchorfire=false;});</td></tr><tr><td class="line-number" value="1163"></td><td class="line-content">            controls.add(buttonanchor);</td></tr><tr><td class="line-number" value="1164"></td><td class="line-content">             </td></tr><tr><td class="line-number" value="1165"></td><td class="line-content">            buttonfire = game.add.button(game.camera.width-180, game.camera.height-60, 'buttonfire', null, this, 0, 1, 0, 1);</td></tr><tr><td class="line-number" value="1166"></td><td class="line-content">            buttonfire.fixedToCamera = true;</td></tr><tr><td class="line-number" value="1167"></td><td class="line-content">            buttonfire.anchor.setTo(0.5,0.5);</td></tr><tr><td class="line-number" value="1168"></td><td class="line-content">            buttonfire.events.onInputOver.add(function(){fire=true;fire_now(buttonfire)});</td></tr><tr><td class="line-number" value="1169"></td><td class="line-content">            buttonfire.events.onInputOut.add(function(){fire=false;});</td></tr><tr><td class="line-number" value="1170"></td><td class="line-content">            buttonfire.events.onInputDown.add(function(){fire=true;fire_now(buttonfire)});</td></tr><tr><td class="line-number" value="1171"></td><td class="line-content">            buttonfire.events.onInputUp.add(function(){fire=false;});</td></tr><tr><td class="line-number" value="1172"></td><td class="line-content">            controls.add(buttonfire);</td></tr><tr><td class="line-number" value="1173"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1174"></td><td class="line-content">            buttonjump = game.add.button(game.camera.width-60, game.camera.height-60, 'buttonjump', null, this, 0, 1, 0, 1);  //game, x, y, key, callback, callbackContext, overFrame, outFrame, downFrame, upFrame</td></tr><tr><td class="line-number" value="1175"></td><td class="line-content">            buttonjump.fixedToCamera = true;  //our buttons should stay on the same place  </td></tr><tr><td class="line-number" value="1176"></td><td class="line-content">            buttonjump.anchor.setTo(0.5,0.5);</td></tr><tr><td class="line-number" value="1177"></td><td class="line-content">            buttonjump.events.onInputOver.add(function(){jump=true;jump_now()});</td></tr><tr><td class="line-number" value="1178"></td><td class="line-content">            buttonjump.events.onInputOut.add(function(){jump=false;});</td></tr><tr><td class="line-number" value="1179"></td><td class="line-content">            buttonjump.events.onInputDown.add(function(){jump=true;jump_now()});</td></tr><tr><td class="line-number" value="1180"></td><td class="line-content">            buttonjump.events.onInputUp.add(function(){jump=false;});</td></tr><tr><td class="line-number" value="1181"></td><td class="line-content">            controls.add(buttonjump);</td></tr><tr><td class="line-number" value="1182"></td><td class="line-content">		</td></tr><tr><td class="line-number" value="1183"></td><td class="line-content">            buttonleft = game.add.button(96, game.camera.height-128, 'buttonhorizontal', null, this, 0, 1, 0, 1);</td></tr><tr><td class="line-number" value="1184"></td><td class="line-content">            buttonleft.fixedToCamera = true;</td></tr><tr><td class="line-number" value="1185"></td><td class="line-content">            buttonleft.scale.x = -1;</td></tr><tr><td class="line-number" value="1186"></td><td class="line-content">            buttonleft.events.onInputOver.add(function(){left=true;});</td></tr><tr><td class="line-number" value="1187"></td><td class="line-content">            buttonleft.events.onInputOut.add(function(){left=false;});</td></tr><tr><td class="line-number" value="1188"></td><td class="line-content">            buttonleft.events.onInputDown.add(function(){left=true;});</td></tr><tr><td class="line-number" value="1189"></td><td class="line-content">            buttonleft.events.onInputUp.add(function(){left=false;});</td></tr><tr><td class="line-number" value="1190"></td><td class="line-content">            controls.add(buttonleft);</td></tr><tr><td class="line-number" value="1191"></td><td class="line-content">            </td></tr><tr><td class="line-number" value="1192"></td><td class="line-content">            buttonbottomleft = game.add.button(0, game.camera.height-64, 'buttondiagonal', null, this, 6, 4, 6, 4);</td></tr><tr><td class="line-number" value="1193"></td><td class="line-content">            buttonbottomleft.fixedToCamera = true;</td></tr><tr><td class="line-number" value="1194"></td><td class="line-content">            buttonbottomleft.events.onInputOver.add(function(){left=true;duck=true;});</td></tr><tr><td class="line-number" value="1195"></td><td class="line-content">            buttonbottomleft.events.onInputOut.add(function(){left=false;duck=false;});</td></tr><tr><td class="line-number" value="1196"></td><td class="line-content">            buttonbottomleft.events.onInputDown.add(function(){left=true;duck=true;});</td></tr><tr><td class="line-number" value="1197"></td><td class="line-content">            buttonbottomleft.events.onInputUp.add(function(){left=false;duck=false;});</td></tr><tr><td class="line-number" value="1198"></td><td class="line-content">            controls.add(buttonbottomleft);</td></tr><tr><td class="line-number" value="1199"></td><td class="line-content"> </td></tr><tr><td class="line-number" value="1200"></td><td class="line-content">            buttonright = game.add.button(96,game.camera.height-128, 'buttonhorizontal', null, this, 0, 1, 0, 1);</td></tr><tr><td class="line-number" value="1201"></td><td class="line-content">            buttonright.fixedToCamera = true;</td></tr><tr><td class="line-number" value="1202"></td><td class="line-content">            buttonright.events.onInputOver.add(function(){right=true;});</td></tr><tr><td class="line-number" value="1203"></td><td class="line-content">            buttonright.events.onInputOut.add(function(){right=false;});</td></tr><tr><td class="line-number" value="1204"></td><td class="line-content">            buttonright.events.onInputDown.add(function(){right=true;});</td></tr><tr><td class="line-number" value="1205"></td><td class="line-content">            buttonright.events.onInputUp.add(function(){right=false;});</td></tr><tr><td class="line-number" value="1206"></td><td class="line-content">            controls.add(buttonright);</td></tr><tr><td class="line-number" value="1207"></td><td class="line-content"> </td></tr><tr><td class="line-number" value="1208"></td><td class="line-content">            buttonbottomright = game.add.button(128, game.camera.height-64, 'buttondiagonal', null, this, 7, 5, 7, 5);</td></tr><tr><td class="line-number" value="1209"></td><td class="line-content">            buttonbottomright.fixedToCamera = true;</td></tr><tr><td class="line-number" value="1210"></td><td class="line-content">            buttonbottomright.events.onInputOver.add(function(){right=true;duck=true;});</td></tr><tr><td class="line-number" value="1211"></td><td class="line-content">            buttonbottomright.events.onInputOut.add(function(){right=false;duck=false;});</td></tr><tr><td class="line-number" value="1212"></td><td class="line-content">            buttonbottomright.events.onInputDown.add(function(){right=true;duck=true;});</td></tr><tr><td class="line-number" value="1213"></td><td class="line-content">            buttonbottomright.events.onInputUp.add(function(){right=false;duck=false;});</td></tr><tr><td class="line-number" value="1214"></td><td class="line-content">            controls.add(buttonbottomright);</td></tr><tr><td class="line-number" value="1215"></td><td class="line-content">            </td></tr><tr><td class="line-number" value="1216"></td><td class="line-content">            buttondown = game.add.button(64, game.camera.height, 'buttonvertical', null, this, 0, 1, 0, 1);</td></tr><tr><td class="line-number" value="1217"></td><td class="line-content">            buttondown.fixedToCamera = true;</td></tr><tr><td class="line-number" value="1218"></td><td class="line-content">            buttondown.scale.y = -1;</td></tr><tr><td class="line-number" value="1219"></td><td class="line-content">            buttondown.events.onInputOver.add(function(){duck=true;});</td></tr><tr><td class="line-number" value="1220"></td><td class="line-content">            buttondown.events.onInputOut.add(function(){duck=false;});</td></tr><tr><td class="line-number" value="1221"></td><td class="line-content">            buttondown.events.onInputDown.add(function(){duck=true;});</td></tr><tr><td class="line-number" value="1222"></td><td class="line-content">            buttondown.events.onInputUp.add(function(){duck=false;});</td></tr><tr><td class="line-number" value="1223"></td><td class="line-content">            controls.add(buttondown);</td></tr><tr><td class="line-number" value="1224"></td><td class="line-content">            </td></tr><tr><td class="line-number" value="1225"></td><td class="line-content">            buttonup = game.add.button(64, game.camera.height-192, 'buttonvertical', null, this, 0, 1, 0, 1);</td></tr><tr><td class="line-number" value="1226"></td><td class="line-content">            buttonup.fixedToCamera = true;</td></tr><tr><td class="line-number" value="1227"></td><td class="line-content">            buttonup.events.onInputOver.add(function(){climb=true;});</td></tr><tr><td class="line-number" value="1228"></td><td class="line-content">            buttonup.events.onInputOut.add(function(){climb=false;});</td></tr><tr><td class="line-number" value="1229"></td><td class="line-content">            buttonup.events.onInputDown.add(function(){climb=true;});</td></tr><tr><td class="line-number" value="1230"></td><td class="line-content">            buttonup.events.onInputUp.add(function(){climb=false;});</td></tr><tr><td class="line-number" value="1231"></td><td class="line-content">            controls.add(buttonup);</td></tr><tr><td class="line-number" value="1232"></td><td class="line-content">            </td></tr><tr><td class="line-number" value="1233"></td><td class="line-content">            buttontopleft = game.add.button(0, game.camera.height-64-64-64, 'buttondiagonal', null, this, 2, 0, 2, 0);</td></tr><tr><td class="line-number" value="1234"></td><td class="line-content">            buttontopleft.fixedToCamera = true;</td></tr><tr><td class="line-number" value="1235"></td><td class="line-content">            controls.add(buttontopleft);</td></tr><tr><td class="line-number" value="1236"></td><td class="line-content">            </td></tr><tr><td class="line-number" value="1237"></td><td class="line-content">            buttontopright = game.add.button(128, game.camera.height-64-64-64, 'buttondiagonal', null, this, 3, 1, 3, 1);</td></tr><tr><td class="line-number" value="1238"></td><td class="line-content">            buttontopright.fixedToCamera = true; </td></tr><tr><td class="line-number" value="1239"></td><td class="line-content">            controls.add(buttontopright);</td></tr><tr><td class="line-number" value="1240"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1241"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1242"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="1243"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1244"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1245"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1246"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1247"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1248"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1249"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1250"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1251"></td><td class="line-content">function setupLayers(layerobjectsmaterial, mainlayermaterial){</td></tr><tr><td class="line-number" value="1252"></td><td class="line-content">     if (!layerobjectsmaterial){layerobjectsmaterial = slantMaterial;}</td></tr><tr><td class="line-number" value="1253"></td><td class="line-content">     //create layers</td></tr><tr><td class="line-number" value="1254"></td><td class="line-content">    layerropes= map.createLayer('ropes');</td></tr><tr><td class="line-number" value="1255"></td><td class="line-content">    layerropes.visible=false;</td></tr><tr><td class="line-number" value="1256"></td><td class="line-content">    layerenemybounds = map.createLayer('enemybounds');</td></tr><tr><td class="line-number" value="1257"></td><td class="line-content">    layerenemybounds.visible=false;  //only enemies need to "see" (collide) with this one so they don't drop in holes..</td></tr><tr><td class="line-number" value="1258"></td><td class="line-content">   </td></tr><tr><td class="line-number" value="1259"></td><td class="line-content">    layerbackground = map.createLayer('background');</td></tr><tr><td class="line-number" value="1260"></td><td class="line-content">    layerforeground = map.createLayer('foreground');</td></tr><tr><td class="line-number" value="1261"></td><td class="line-content">    layerforeground.resizeWorld();  // this stretches the world to the size of the layer</td></tr><tr><td class="line-number" value="1262"></td><td class="line-content">    </td></tr><tr><td class="line-number" value="1263"></td><td class="line-content">    gameobjects.add(layerbackground);</td></tr><tr><td class="line-number" value="1264"></td><td class="line-content">    gameobjects.add(layerforeground);</td></tr><tr><td class="line-number" value="1265"></td><td class="line-content">    </td></tr><tr><td class="line-number" value="1266"></td><td class="line-content">    // setup which tiles from the tileset should be considered for collision</td></tr><tr><td class="line-number" value="1267"></td><td class="line-content">    map.setCollisionByExclusion([0],true, layerenemybounds);</td></tr><tr><td class="line-number" value="1268"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1269"></td><td class="line-content">    //make physic bodies for each and every tile on the layer</td></tr><tr><td class="line-number" value="1270"></td><td class="line-content">    layerenemybounds_tiles = game.physics.p2.convertTilemap(map, layerenemybounds);</td></tr><tr><td class="line-number" value="1271"></td><td class="line-content">    </td></tr><tr><td class="line-number" value="1272"></td><td class="line-content">    layerobjects_tiles = game.physics.p2.convertCollisionObjects(map,"objects");  //polygon objects</td></tr><tr><td class="line-number" value="1273"></td><td class="line-content">    layermain_tiles = game.physics.p2.convertCollisionObjects(map,"mainlayer");</td></tr><tr><td class="line-number" value="1274"></td><td class="line-content">    layerice_tiles =   game.physics.p2.convertCollisionObjects(map,"icelayer");</td></tr><tr><td class="line-number" value="1275"></td><td class="line-content">    layerenemy_tiles = game.physics.p2.convertCollisionObjects(map,"enemylayer");</td></tr><tr><td class="line-number" value="1276"></td><td class="line-content"> </td></tr><tr><td class="line-number" value="1277"></td><td class="line-content">    </td></tr><tr><td class="line-number" value="1278"></td><td class="line-content">    </td></tr><tr><td class="line-number" value="1279"></td><td class="line-content">    //setup all tiles with collisiongroups or materials</td></tr><tr><td class="line-number" value="1280"></td><td class="line-content">    for (i=0; i&lt;layermain_tiles.length; i++){</td></tr><tr><td class="line-number" value="1281"></td><td class="line-content">        layermain_tiles[i].setCollisionGroup(groundCG);</td></tr><tr><td class="line-number" value="1282"></td><td class="line-content">        layermain_tiles[i].collides([playerCG,fireballCG,powerupsCG,enemyGroundCG]);</td></tr><tr><td class="line-number" value="1283"></td><td class="line-content">        layermain_tiles[i].setMaterial(groundMaterial);</td></tr><tr><td class="line-number" value="1284"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1285"></td><td class="line-content">    for (i=0; i&lt;layerobjects_tiles.length; i++){</td></tr><tr><td class="line-number" value="1286"></td><td class="line-content">        layerobjects_tiles[i].setCollisionGroup(groundCG);</td></tr><tr><td class="line-number" value="1287"></td><td class="line-content">        layerobjects_tiles[i].collides([playerCG,fireballCG,powerupsCG,enemyGroundCG]);</td></tr><tr><td class="line-number" value="1288"></td><td class="line-content">        layerobjects_tiles[i].setMaterial(layerobjectsmaterial);</td></tr><tr><td class="line-number" value="1289"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1290"></td><td class="line-content">    for (i=0; i&lt;layerenemy_tiles.length; i++){</td></tr><tr><td class="line-number" value="1291"></td><td class="line-content">        layerenemy_tiles[i].setCollisionGroup(enemyStaticCG);</td></tr><tr><td class="line-number" value="1292"></td><td class="line-content">        layerenemy_tiles[i].collides([playerCG,fireballCG]);</td></tr><tr><td class="line-number" value="1293"></td><td class="line-content">        layerenemy_tiles[i].setMaterial(groundMaterial);</td></tr><tr><td class="line-number" value="1294"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1295"></td><td class="line-content">    for (i=0; i&lt;layerice_tiles.length; i++){</td></tr><tr><td class="line-number" value="1296"></td><td class="line-content">        layerice_tiles[i].setCollisionGroup(groundCG);</td></tr><tr><td class="line-number" value="1297"></td><td class="line-content">        layerice_tiles[i].collides([playerCG,fireballCG,powerupsCG,enemyGroundCG]);</td></tr><tr><td class="line-number" value="1298"></td><td class="line-content">        layerice_tiles[i].setMaterial(iceMaterial);</td></tr><tr><td class="line-number" value="1299"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1300"></td><td class="line-content">    for (i=0; i&lt;layerenemybounds_tiles.length; i++){</td></tr><tr><td class="line-number" value="1301"></td><td class="line-content">        layerenemybounds_tiles[i].setCollisionGroup(enemyboundsCG);</td></tr><tr><td class="line-number" value="1302"></td><td class="line-content">        layerenemybounds_tiles[i].collides([enemyGroundCG]);</td></tr><tr><td class="line-number" value="1303"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1304"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="1305"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1306"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1307"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1308"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1309"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1310"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1311"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1312"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1313"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1314"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1315"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1316"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1317"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1318"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1319"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1320"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1321"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1322"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1323"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1324"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1325"></td><td class="line-content">function playerInputActions(){</td></tr><tr><td class="line-number" value="1326"></td><td class="line-content">    if (level == levels){  //last level - flappy style has a different layout</td></tr><tr><td class="line-number" value="1327"></td><td class="line-content">        if (hitboxchanged === true){ </td></tr><tr><td class="line-number" value="1328"></td><td class="line-content">            hitboxchanged=false;  </td></tr><tr><td class="line-number" value="1329"></td><td class="line-content">            if (player.health &lt; 2){playershape.radius= game.physics.p2.pxm(15); }</td></tr><tr><td class="line-number" value="1330"></td><td class="line-content">            else {  playershape.radius= game.physics.p2.pxm(20);} </td></tr><tr><td class="line-number" value="1331"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1332"></td><td class="line-content">        player.body.moveRight(150);</td></tr><tr><td class="line-number" value="1333"></td><td class="line-content">        if (player.body.velocity.y &lt; -5){ playerstate='fall';}</td></tr><tr><td class="line-number" value="1334"></td><td class="line-content">        else if (touchingDown(player.body)){ playerstate='walk'; }</td></tr><tr><td class="line-number" value="1335"></td><td class="line-content">        else { playerstate='jump'; }</td></tr><tr><td class="line-number" value="1336"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1337"></td><td class="line-content">        if ( (fire ) &amp;&amp; player_health == 3){ playerstate='fire';}</td></tr><tr><td class="line-number" value="1338"></td><td class="line-content">        if (player.body.y &gt;= game.world.height+100 ||player.body.x &gt;= 6400 || player.body.y &lt; -300) {playerDie(player.body);}  //if you fall down - die</td></tr><tr><td class="line-number" value="1339"></td><td class="line-content">        if (game.input.currentPointers == 0 &amp;&amp; !game.input.activePointer.isMouse){ fire=false; left=false; right=false;  duck=false; jump=false;} //this works around a "bug" where a button gets stuck in pressed state</td></tr><tr><td class="line-number" value="1340"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1341"></td><td class="line-content">    </td></tr><tr><td class="line-number" value="1342"></td><td class="line-content">    else if (climbing == true) {</td></tr><tr><td class="line-number" value="1343"></td><td class="line-content">        player.body.setZeroVelocity();</td></tr><tr><td class="line-number" value="1344"></td><td class="line-content">            //go left</td></tr><tr><td class="line-number" value="1345"></td><td class="line-content">        if (cursors.left.isDown &amp;&amp; !cursors.down.isDown  || left &amp;&amp; !duck){   //  Move to the left</td></tr><tr><td class="line-number" value="1346"></td><td class="line-content">            player.scale.x = -1;</td></tr><tr><td class="line-number" value="1347"></td><td class="line-content">            player.body.moveLeft(player_speed);</td></tr><tr><td class="line-number" value="1348"></td><td class="line-content">            playerstate='climb';</td></tr><tr><td class="line-number" value="1349"></td><td class="line-content">            if (!map.getTileWorldXY(player.body.x, player.body.y,32,32, layerropes)){</td></tr><tr><td class="line-number" value="1350"></td><td class="line-content">                player.body.data.gravityScale=1; </td></tr><tr><td class="line-number" value="1351"></td><td class="line-content">                climbing = false;</td></tr><tr><td class="line-number" value="1352"></td><td class="line-content">            }   //check if there is still something to climb</td></tr><tr><td class="line-number" value="1353"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1354"></td><td class="line-content">        //go right</td></tr><tr><td class="line-number" value="1355"></td><td class="line-content">        else if (cursors.right.isDown &amp;&amp; !cursors.down.isDown || right &amp;&amp; !duck) {//  Move to the right</td></tr><tr><td class="line-number" value="1356"></td><td class="line-content">            player.scale.x = 1;</td></tr><tr><td class="line-number" value="1357"></td><td class="line-content">            player.body.moveRight(player_speed);</td></tr><tr><td class="line-number" value="1358"></td><td class="line-content">            playerstate='climb';</td></tr><tr><td class="line-number" value="1359"></td><td class="line-content">            if (!map.getTileWorldXY(player.body.x, player.body.y,32,32, layerropes)){</td></tr><tr><td class="line-number" value="1360"></td><td class="line-content">                player.body.data.gravityScale=1; </td></tr><tr><td class="line-number" value="1361"></td><td class="line-content">                climbing = false;</td></tr><tr><td class="line-number" value="1362"></td><td class="line-content">            }    //check if there is still something to climb</td></tr><tr><td class="line-number" value="1363"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1364"></td><td class="line-content">        //go down !</td></tr><tr><td class="line-number" value="1365"></td><td class="line-content">        else if(cursors.down.isDown &amp;&amp; !cursors.left.isDown &amp;&amp; !cursors.right.isDown || duck &amp;&amp; !left &amp;&amp; !right){</td></tr><tr><td class="line-number" value="1366"></td><td class="line-content">            player.body.moveDown(player_speed);</td></tr><tr><td class="line-number" value="1367"></td><td class="line-content">            playerstate='climb';</td></tr><tr><td class="line-number" value="1368"></td><td class="line-content">            if (!map.getTileWorldXY(player.body.x, player.body.y,32,32, layerropes)){</td></tr><tr><td class="line-number" value="1369"></td><td class="line-content">                player.body.data.gravityScale=1; </td></tr><tr><td class="line-number" value="1370"></td><td class="line-content">                climbing = false;</td></tr><tr><td class="line-number" value="1371"></td><td class="line-content">            }    //check if there is still something to climb</td></tr><tr><td class="line-number" value="1372"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1373"></td><td class="line-content">        //go up !</td></tr><tr><td class="line-number" value="1374"></td><td class="line-content">        else if(cursors.up.isDown &amp;&amp; !cursors.left.isDown &amp;&amp; !cursors.right.isDown || climb &amp;&amp; !left &amp;&amp; !right){</td></tr><tr><td class="line-number" value="1375"></td><td class="line-content">            if (map.getTileWorldXY(player.body.x, player.body.y-16,32,32, layerropes)){  //only climb if there is something to grab 1 tile ahead (never climb higher than the tree)</td></tr><tr><td class="line-number" value="1376"></td><td class="line-content">                player.body.moveUp(150);</td></tr><tr><td class="line-number" value="1377"></td><td class="line-content">                playerstate='climb';</td></tr><tr><td class="line-number" value="1378"></td><td class="line-content">            }else { </td></tr><tr><td class="line-number" value="1379"></td><td class="line-content">                playerstate='hang';     //otherwise hang tight</td></tr><tr><td class="line-number" value="1380"></td><td class="line-content">            }</td></tr><tr><td class="line-number" value="1381"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1382"></td><td class="line-content">        // hold</td></tr><tr><td class="line-number" value="1383"></td><td class="line-content">        else{ playerstate='hang';}</td></tr><tr><td class="line-number" value="1384"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1385"></td><td class="line-content">        if ( (fire &amp;&amp; !duck) &amp;&amp; player_health == 3){ playerstate='fire';}</td></tr><tr><td class="line-number" value="1386"></td><td class="line-content">        if (jumpKey.isDown ||jump){playerstate='jump';}  //release rope</td></tr><tr><td class="line-number" value="1387"></td><td class="line-content">        if (game.input.currentPointers == 0 &amp;&amp; !game.input.activePointer.isMouse){ fire=false; left=false; right=false;  duck=false; jump=false; climb = false;} //this works around a "bug" where a button gets stuck in pressed state</td></tr><tr><td class="line-number" value="1388"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1389"></td><td class="line-content">    </td></tr><tr><td class="line-number" value="1390"></td><td class="line-content">    else if (hanging === true){</td></tr><tr><td class="line-number" value="1391"></td><td class="line-content">        playerstate='hang';</td></tr><tr><td class="line-number" value="1392"></td><td class="line-content">        if ((cursors.right.isDown &amp;&amp; !jumpKey.isDown)|| (right &amp;&amp; !jump) ){</td></tr><tr><td class="line-number" value="1393"></td><td class="line-content">            chainElement.body.data.force[0]=-200; //move the chain - swing</td></tr><tr><td class="line-number" value="1394"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1395"></td><td class="line-content">        else if ((cursors.left.isDown &amp;&amp; !jumpKey.isDown)|| (left &amp;&amp; !jump) ){  </td></tr><tr><td class="line-number" value="1396"></td><td class="line-content">           // chainElement.body.moveLeft(200); //move the chain - swing</td></tr><tr><td class="line-number" value="1397"></td><td class="line-content">             chainElement.body.data.force[0]=200;</td></tr><tr><td class="line-number" value="1398"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1399"></td><td class="line-content">        else if (jumpKey.isDown  ||jump ){  playerstate='jump'; }//release chain //other jump related events are handled in the jump_now function</td></tr><tr><td class="line-number" value="1400"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1401"></td><td class="line-content">    else if (docked === true){</td></tr><tr><td class="line-number" value="1402"></td><td class="line-content">        playerstate='hang';</td></tr><tr><td class="line-number" value="1403"></td><td class="line-content">        if ((cursors.right.isDown &amp;&amp; !jumpKey.isDown)|| (right &amp;&amp; !jump) ){</td></tr><tr><td class="line-number" value="1404"></td><td class="line-content">            player.body.data.force[0]=-200; //move the chain - swing</td></tr><tr><td class="line-number" value="1405"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1406"></td><td class="line-content">        else if ((cursors.left.isDown &amp;&amp; !jumpKey.isDown)|| (left &amp;&amp; !jump) ){  </td></tr><tr><td class="line-number" value="1407"></td><td class="line-content">             player.body.data.force[0]=200;</td></tr><tr><td class="line-number" value="1408"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1409"></td><td class="line-content">        else if (jumpKey.isDown  ||jump ){  playerstate='jump'; }//release chain //other jump related events are handled in the jump_now function</td></tr><tr><td class="line-number" value="1410"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1411"></td><td class="line-content">    // NORMAL GAMEPLAY</td></tr><tr><td class="line-number" value="1412"></td><td class="line-content">    else {  </td></tr><tr><td class="line-number" value="1413"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="1414"></td><td class="line-content">        if (hitboxchanged === true){ // control player shape and speed according to it's health status</td></tr><tr><td class="line-number" value="1415"></td><td class="line-content">            hitboxchanged=false; </td></tr><tr><td class="line-number" value="1416"></td><td class="line-content">            if (player.health &gt;= 2 &amp;&amp; (cursors.down.isDown || duck)){ </td></tr><tr><td class="line-number" value="1417"></td><td class="line-content">                playershape.radius= game.physics.p2.pxm(15);</td></tr><tr><td class="line-number" value="1418"></td><td class="line-content">                player_speed=150;</td></tr><tr><td class="line-number" value="1419"></td><td class="line-content">            }</td></tr><tr><td class="line-number" value="1420"></td><td class="line-content">            else if (player.health &gt;= 2 &amp;&amp; !(jumpKey.isDown ||jump) &amp;&amp; checkAbove() &amp;&amp; !(cursors.down.isDown || duck)){</td></tr><tr><td class="line-number" value="1421"></td><td class="line-content">                playershape.radius= game.physics.p2.pxm(15);</td></tr><tr><td class="line-number" value="1422"></td><td class="line-content">                player_speed=150;</td></tr><tr><td class="line-number" value="1423"></td><td class="line-content">            }</td></tr><tr><td class="line-number" value="1424"></td><td class="line-content">            else if (player.health &gt;= 2 &amp;&amp; !(cursors.down.isDown || duck)) { </td></tr><tr><td class="line-number" value="1425"></td><td class="line-content">                playershape.radius= game.physics.p2.pxm(20);</td></tr><tr><td class="line-number" value="1426"></td><td class="line-content">                player_speed=300;</td></tr><tr><td class="line-number" value="1427"></td><td class="line-content">                air_friction=400;</td></tr><tr><td class="line-number" value="1428"></td><td class="line-content">            } </td></tr><tr><td class="line-number" value="1429"></td><td class="line-content">            else {  </td></tr><tr><td class="line-number" value="1430"></td><td class="line-content">                playershape.radius= game.physics.p2.pxm(15);</td></tr><tr><td class="line-number" value="1431"></td><td class="line-content">                player_speed=250; </td></tr><tr><td class="line-number" value="1432"></td><td class="line-content">                air_friction=300;</td></tr><tr><td class="line-number" value="1433"></td><td class="line-content">            } </td></tr><tr><td class="line-number" value="1434"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1435"></td><td class="line-content">			</td></tr><tr><td class="line-number" value="1436"></td><td class="line-content">        // force duck under a block</td></tr><tr><td class="line-number" value="1437"></td><td class="line-content">        if (player.health &gt;= 2 &amp;&amp; (checkAbove())  &amp;&amp; !(cursors.down.isDown || duck)){</td></tr><tr><td class="line-number" value="1438"></td><td class="line-content">            hitboxchanged=true; </td></tr><tr><td class="line-number" value="1439"></td><td class="line-content">            playerstate= 'duck';</td></tr><tr><td class="line-number" value="1440"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1441"></td><td class="line-content">        //go left</td></tr><tr><td class="line-number" value="1442"></td><td class="line-content">        else if (cursors.left.isDown &amp;&amp; !cursors.down.isDown  || left &amp;&amp; !duck){   //  Move to the left</td></tr><tr><td class="line-number" value="1443"></td><td class="line-content">            player.scale.x = -1;</td></tr><tr><td class="line-number" value="1444"></td><td class="line-content">            playerstate = 'walk';</td></tr><tr><td class="line-number" value="1445"></td><td class="line-content">            if (onAir==false){player.body.moveLeft(player_speed);}</td></tr><tr><td class="line-number" value="1446"></td><td class="line-content">            else {player.body.moveLeft(jumpspeedx); player.body.data.force[0] = -air_friction;}</td></tr><tr><td class="line-number" value="1447"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1448"></td><td class="line-content">        //go right</td></tr><tr><td class="line-number" value="1449"></td><td class="line-content">        else if (cursors.right.isDown &amp;&amp; !cursors.down.isDown || right &amp;&amp; !duck) {//  Move to the right</td></tr><tr><td class="line-number" value="1450"></td><td class="line-content">            player.scale.x = 1;</td></tr><tr><td class="line-number" value="1451"></td><td class="line-content">            playerstate = 'walk';</td></tr><tr><td class="line-number" value="1452"></td><td class="line-content">            if (onAir==false){player.body.moveRight(player_speed);}</td></tr><tr><td class="line-number" value="1453"></td><td class="line-content">            else {player.body.moveRight(jumpspeedx); player.body.data.force[0] = air_friction;}		</td></tr><tr><td class="line-number" value="1454"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1455"></td><td class="line-content">        //duck and go left</td></tr><tr><td class="line-number" value="1456"></td><td class="line-content">        else if(cursors.down.isDown &amp;&amp; cursors.left.isDown || left &amp;&amp; duck){</td></tr><tr><td class="line-number" value="1457"></td><td class="line-content">            hitboxchanged=true; </td></tr><tr><td class="line-number" value="1458"></td><td class="line-content">            if (player.health &gt;= 2){playerstate='duckwalk';}else {playerstate='walk';} //only play duck animation if player is big and can duck otherwise just walk</td></tr><tr><td class="line-number" value="1459"></td><td class="line-content">            player.scale.x = -1;</td></tr><tr><td class="line-number" value="1460"></td><td class="line-content">            player.body.moveLeft(player_speed);</td></tr><tr><td class="line-number" value="1461"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1462"></td><td class="line-content">        //duck and go right</td></tr><tr><td class="line-number" value="1463"></td><td class="line-content">        else if(cursors.down.isDown &amp;&amp; cursors.right.isDown || right &amp;&amp;  duck){</td></tr><tr><td class="line-number" value="1464"></td><td class="line-content">            hitboxchanged=true; </td></tr><tr><td class="line-number" value="1465"></td><td class="line-content">            if (player.health &gt;= 2){playerstate='duckwalk';}else {playerstate='walk';} //only play duck animation if player is big and can duck</td></tr><tr><td class="line-number" value="1466"></td><td class="line-content">            player.scale.x = 1;</td></tr><tr><td class="line-number" value="1467"></td><td class="line-content">            player.body.moveRight(player_speed);</td></tr><tr><td class="line-number" value="1468"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1469"></td><td class="line-content">        //just duck !</td></tr><tr><td class="line-number" value="1470"></td><td class="line-content">        else if(cursors.down.isDown &amp;&amp; !cursors.left.isDown &amp;&amp; !cursors.right.isDown || duck &amp;&amp; !left &amp;&amp; !right){ hitboxchanged=true;  if (player.health &gt;= 2){playerstate='duck';}else {playerstate='idle';} }</td></tr><tr><td class="line-number" value="1471"></td><td class="line-content">        //  Climb</td></tr><tr><td class="line-number" value="1472"></td><td class="line-content">        else if ( (cursors.up.isDown &amp;&amp; !cursors.down.isDown ||  climb &amp;&amp; !duck) &amp;&amp; map.getTileWorldXY(player.body.x, player.body.y,32,32, layerropes) ) {</td></tr><tr><td class="line-number" value="1473"></td><td class="line-content">            climbing = true;</td></tr><tr><td class="line-number" value="1474"></td><td class="line-content">            player.body.data.gravityScale = 0;</td></tr><tr><td class="line-number" value="1475"></td><td class="line-content">            player.body.moveUp(150);</td></tr><tr><td class="line-number" value="1476"></td><td class="line-content">            player.body.velocity.x=0;</td></tr><tr><td class="line-number" value="1477"></td><td class="line-content">            playerstate='climb';</td></tr><tr><td class="line-number" value="1478"></td><td class="line-content">            destroyAnchor();</td></tr><tr><td class="line-number" value="1479"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1480"></td><td class="line-content">       // stand</td></tr><tr><td class="line-number" value="1481"></td><td class="line-content">        else{</td></tr><tr><td class="line-number" value="1482"></td><td class="line-content">            playerstate='idle';</td></tr><tr><td class="line-number" value="1483"></td><td class="line-content">            if ((onAir==true)&amp;&amp;(player.body.velocity.x &gt; 5)){ player.body.data.force[0] = -40;}  //moarr air friction when doing nothing in air</td></tr><tr><td class="line-number" value="1484"></td><td class="line-content">            if ((onAir==true)&amp;&amp;(player.body.velocity.x &lt; -5)){ player.body.data.force[0] = 40;}</td></tr><tr><td class="line-number" value="1485"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1486"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1487"></td><td class="line-content">        if ( (fire &amp;&amp; !duck) &amp;&amp; player_health == 3){ playerstate='fire'; }  // this is just for the animation / the actual fire is a ondown event in the create function/setupControls</td></tr><tr><td class="line-number" value="1488"></td><td class="line-content">        if (jumpKey.isDown ||jump){ playerstate='jump';if (docked){destroyAnchor(); } }  // you can jump out of the anchor constraint</td></tr><tr><td class="line-number" value="1489"></td><td class="line-content">        if (player.body.y &gt;= game.world.height + 100) {playerDie(player.body);}  //if you fall down - die</td></tr><tr><td class="line-number" value="1490"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="1491"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1492"></td><td class="line-content">    // normal gameplay controls END</td></tr><tr><td class="line-number" value="1493"></td><td class="line-content">    if (game.input.currentPointers == 0 &amp;&amp; !game.input.activePointer.isMouse){ fire=false; left=false; right=false;  duck=false; jump=false; climb =false;} //this works around a "bug" where a button gets stuck in pressed state</td></tr><tr><td class="line-number" value="1494"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="1495"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="1496"></td><td class="line-content">	//check controls visibility and other stuff for desktop/mobile</td></tr><tr><td class="line-number" value="1497"></td><td class="line-content">    if (!game.device.desktop){</td></tr><tr><td class="line-number" value="1498"></td><td class="line-content">        if (player_chain){ buttonanchor.alpha = 1; } else { buttonanchor.alpha = 0; }</td></tr><tr><td class="line-number" value="1499"></td><td class="line-content">    }else{</td></tr><tr><td class="line-number" value="1500"></td><td class="line-content">		// player always looks to mouse</td></tr><tr><td class="line-number" value="1501"></td><td class="line-content">        if ( game.input.activePointer.x + game.camera.x &gt;=  player.x){ player.scale.x = 1;}else{ player.scale.x = -1;}</td></tr><tr><td class="line-number" value="1502"></td><td class="line-content">		// mouse controls</td></tr><tr><td class="line-number" value="1503"></td><td class="line-content">		if (game.input.mouse.button != -1 || formerMouse &gt; -1) {</td></tr><tr><td class="line-number" value="1504"></td><td class="line-content">			fire=false;</td></tr><tr><td class="line-number" value="1505"></td><td class="line-content">			if(game.input.mouse.button &lt; 0 &amp;&amp; formerMouse == 2) {</td></tr><tr><td class="line-number" value="1506"></td><td class="line-content">				if (player_chain){ destroyAnchor();}</td></tr><tr><td class="line-number" value="1507"></td><td class="line-content">			} else {</td></tr><tr><td class="line-number" value="1508"></td><td class="line-content">				if (game.input.mouse.button == 2 &amp;&amp; formerMouse != game.input.mouse.button &amp;&amp; anchorfire==false &amp;&amp; fire==false  &amp;&amp; jump==false) {</td></tr><tr><td class="line-number" value="1509"></td><td class="line-content">					if (player_chain){ shootSensor();}</td></tr><tr><td class="line-number" value="1510"></td><td class="line-content">				} else if (game.input.mouse.button == 0 &amp;&amp; formerMouse != game.input.mouse.button &amp;&amp; fire == false &amp;&amp; anchorfire==false &amp;&amp; jump==false) {</td></tr><tr><td class="line-number" value="1511"></td><td class="line-content">					fire=true;</td></tr><tr><td class="line-number" value="1512"></td><td class="line-content">					fire_now();   // fire_now decides which weapon to use</td></tr><tr><td class="line-number" value="1513"></td><td class="line-content">				} </td></tr><tr><td class="line-number" value="1514"></td><td class="line-content">			}</td></tr><tr><td class="line-number" value="1515"></td><td class="line-content">			formerMouse = game.input.mouse.button;</td></tr><tr><td class="line-number" value="1516"></td><td class="line-content">		}</td></tr><tr><td class="line-number" value="1517"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1518"></td><td class="line-content">	//on air material should change to ice.. do not stick to anything!</td></tr><tr><td class="line-number" value="1519"></td><td class="line-content">    if (onAir===true){player.body.setMaterial(iceMaterial);}else if (onAir===false){player.body.setMaterial(playerMaterial);jumpspeedx = player_speed;}</td></tr><tr><td class="line-number" value="1520"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1521"></td><td class="line-content">    </td></tr><tr><td class="line-number" value="1522"></td><td class="line-content">    </td></tr><tr><td class="line-number" value="1523"></td><td class="line-content">    </td></tr><tr><td class="line-number" value="1524"></td><td class="line-content">    </td></tr><tr><td class="line-number" value="1525"></td><td class="line-content">	// could be in separate function since it has nothing to do with player controls</td></tr><tr><td class="line-number" value="1526"></td><td class="line-content">    </td></tr><tr><td class="line-number" value="1527"></td><td class="line-content">    //anchor movement and logic only when chain is available </td></tr><tr><td class="line-number" value="1528"></td><td class="line-content">    if (player_chain){</td></tr><tr><td class="line-number" value="1529"></td><td class="line-content">        if (accelerate) { moveToPoint(chainAnchor,[sensorX,sensorY],4500); }</td></tr><tr><td class="line-number" value="1530"></td><td class="line-content">        if (sensor){</td></tr><tr><td class="line-number" value="1531"></td><td class="line-content">            flightDistance = distanceBetween(player,sensor);</td></tr><tr><td class="line-number" value="1532"></td><td class="line-content">            if ( flightDistance &gt; chainMaxLength){ destroyAnchor();}  // no sensors that didn't hit something in time flying around</td></tr><tr><td class="line-number" value="1533"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1534"></td><td class="line-content">        if (!docked &amp;&amp; chainAnchor){</td></tr><tr><td class="line-number" value="1535"></td><td class="line-content">            if (chainSectionCount &gt;= chainMaxSections){ destroyAnchor();}  // no loooooong anchors</td></tr><tr><td class="line-number" value="1536"></td><td class="line-content">            else { createChainElement(chainSectionCount, chainLength);createChainElement(chainSectionCount, chainLength);} // slow down chainelement creation..  every second frame create a new element </td></tr><tr><td class="line-number" value="1537"></td><td class="line-content">        }   </td></tr><tr><td class="line-number" value="1538"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1539"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1540"></td><td class="line-content">	if (score &gt;= 100 ) {</td></tr><tr><td class="line-number" value="1541"></td><td class="line-content">        score -= 100;</td></tr><tr><td class="line-number" value="1542"></td><td class="line-content">        // create a powerup every 100 points</td></tr><tr><td class="line-number" value="1543"></td><td class="line-content">        powerup = game.add.sprite(player.body.x, game.camera.y, 'powerups',3);</td></tr><tr><td class="line-number" value="1544"></td><td class="line-content">        powerup.name="shroomoflife";</td></tr><tr><td class="line-number" value="1545"></td><td class="line-content">        game.physics.p2.enable(powerup);</td></tr><tr><td class="line-number" value="1546"></td><td class="line-content">        powerup.body.data.gravityScale=0.1;</td></tr><tr><td class="line-number" value="1547"></td><td class="line-content">        powerup.body.setCircle(30);</td></tr><tr><td class="line-number" value="1548"></td><td class="line-content">        powerup.body.allowSleep=true;</td></tr><tr><td class="line-number" value="1549"></td><td class="line-content">        powerup.body.fixedRotation=true; </td></tr><tr><td class="line-number" value="1550"></td><td class="line-content">        powerup.body.setMaterial(iceMaterial);</td></tr><tr><td class="line-number" value="1551"></td><td class="line-content">        powerup.body.setCollisionGroup(powerupsCG);</td></tr><tr><td class="line-number" value="1552"></td><td class="line-content">        powerup.body.collides([playerCG]);</td></tr><tr><td class="line-number" value="1553"></td><td class="line-content">        powerup.body.collideWorldBounds=false;</td></tr><tr><td class="line-number" value="1554"></td><td class="line-content">        scoreText.text = ' x ' + score;</td></tr><tr><td class="line-number" value="1555"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1556"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1557"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1558"></td><td class="line-content">    // define weapons handling in different situations</td></tr><tr><td class="line-number" value="1559"></td><td class="line-content">    if (weapon_selected == 'sword'){</td></tr><tr><td class="line-number" value="1560"></td><td class="line-content">        if (climbing || hanging){</td></tr><tr><td class="line-number" value="1561"></td><td class="line-content">			sword.bringToTop();</td></tr><tr><td class="line-number" value="1562"></td><td class="line-content">			sword.body.x=player.body.x;</td></tr><tr><td class="line-number" value="1563"></td><td class="line-content">			sword.body.y=player.body.y+5;</td></tr><tr><td class="line-number" value="1564"></td><td class="line-content">            sword.body.data.shapes[0].sensor=true;</td></tr><tr><td class="line-number" value="1565"></td><td class="line-content">		}else {</td></tr><tr><td class="line-number" value="1566"></td><td class="line-content">			//reset sword</td></tr><tr><td class="line-number" value="1567"></td><td class="line-content">			player.bringToTop();</td></tr><tr><td class="line-number" value="1568"></td><td class="line-content">			sword.body.data.shapes[0].sensor=false;</td></tr><tr><td class="line-number" value="1569"></td><td class="line-content">			sword.scale.x = player.scale.x;</td></tr><tr><td class="line-number" value="1570"></td><td class="line-content">			if (game.device.desktop){</td></tr><tr><td class="line-number" value="1571"></td><td class="line-content">				//something</td></tr><tr><td class="line-number" value="1572"></td><td class="line-content">			}	</td></tr><tr><td class="line-number" value="1573"></td><td class="line-content">		}</td></tr><tr><td class="line-number" value="1574"></td><td class="line-content">    }else if (weapon_selected == 'fireflower'){</td></tr><tr><td class="line-number" value="1575"></td><td class="line-content">		if (climbing || hanging){</td></tr><tr><td class="line-number" value="1576"></td><td class="line-content">			gun1.body.x=player.body.x;</td></tr><tr><td class="line-number" value="1577"></td><td class="line-content">			gun1.body.y=player.body.y+5;</td></tr><tr><td class="line-number" value="1578"></td><td class="line-content">			gun1.bringToTop();</td></tr><tr><td class="line-number" value="1579"></td><td class="line-content">		}else {</td></tr><tr><td class="line-number" value="1580"></td><td class="line-content">			if (game.device.desktop){</td></tr><tr><td class="line-number" value="1581"></td><td class="line-content">				weaponangle = Math.degrees(angleBetween(player,game.input));</td></tr><tr><td class="line-number" value="1582"></td><td class="line-content">				if (player.scale.x &lt; 0){  gun1.body.angle = weaponangle -180;}</td></tr><tr><td class="line-number" value="1583"></td><td class="line-content">				else{ gun1.body.angle = weaponangle;  }</td></tr><tr><td class="line-number" value="1584"></td><td class="line-content">				gun1.scale.x = player.scale.x;</td></tr><tr><td class="line-number" value="1585"></td><td class="line-content">			}</td></tr><tr><td class="line-number" value="1586"></td><td class="line-content">			player.bringToTop();</td></tr><tr><td class="line-number" value="1587"></td><td class="line-content">			</td></tr><tr><td class="line-number" value="1588"></td><td class="line-content">		}</td></tr><tr><td class="line-number" value="1589"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1590"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1591"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="1592"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1593"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1594"></td><td class="line-content">// checks if there is something else above the player except his own sword</td></tr><tr><td class="line-number" value="1595"></td><td class="line-content">function checkAbove(){</td></tr><tr><td class="line-number" value="1596"></td><td class="line-content">    if (game.physics.p2.hitTest({x: player.body.x, y: player.body.y-26}).length != 0){ //check if there is something above</td></tr><tr><td class="line-number" value="1597"></td><td class="line-content">        var hitObjects = game.physics.p2.hitTest({x: player.body.x, y: player.body.y-26});</td></tr><tr><td class="line-number" value="1598"></td><td class="line-content">        if (hitObjects.length &gt; 1 &amp;&amp; !hitObjects[1].parent.sprite){return  true;} // there is more than only my sword</td></tr><tr><td class="line-number" value="1599"></td><td class="line-content">        else {</td></tr><tr><td class="line-number" value="1600"></td><td class="line-content">                if (hitObjects[0] &amp;&amp; !hitObjects[0].parent.sprite  ) {return  true;}  // check if it is the sword or something else that is no wall and has a sprite</td></tr><tr><td class="line-number" value="1601"></td><td class="line-content">                else {return false;}</td></tr><tr><td class="line-number" value="1602"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1603"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1604"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="1605"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1606"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1607"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1608"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1609"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1610"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1611"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1612"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1613"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1614"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1615"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1616"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1617"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1618"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1619"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1620"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1621"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1622"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1623"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1624"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1625"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1626"></td><td class="line-content">function createObjects(currentstate){</td></tr><tr><td class="line-number" value="1627"></td><td class="line-content">   //create questionmarks, callsigns and other groups of objects</td></tr><tr><td class="line-number" value="1628"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1629"></td><td class="line-content">    coins = game.add.group();</td></tr><tr><td class="line-number" value="1630"></td><td class="line-content">    map.createFromObjects('objects', 99, 'questionmark', 1, true, false, coins); //fragezeichen  (99 eckunten rechts)</td></tr><tr><td class="line-number" value="1631"></td><td class="line-content">    coins.forEach(QuestionmarkIt,this);</td></tr><tr><td class="line-number" value="1632"></td><td class="line-content">    gameobjects.add(coins);</td></tr><tr><td class="line-number" value="1633"></td><td class="line-content">    </td></tr><tr><td class="line-number" value="1634"></td><td class="line-content">    powerups = game.add.group(); </td></tr><tr><td class="line-number" value="1635"></td><td class="line-content">    map.createFromObjects('objects', 359, 'questionmark', 2, true, false, powerups);  //rufzeichen (359 eck unten rechts)</td></tr><tr><td class="line-number" value="1636"></td><td class="line-content">    powerups.forEach(CallsignIt,this);</td></tr><tr><td class="line-number" value="1637"></td><td class="line-content">    gameobjects.add(powerups);</td></tr><tr><td class="line-number" value="1638"></td><td class="line-content">    </td></tr><tr><td class="line-number" value="1639"></td><td class="line-content">    assets = game.add.group(); </td></tr><tr><td class="line-number" value="1640"></td><td class="line-content">    map.createFromObjects('objects', 29, 'questionmark', 4, true, false, assets);  //rufzeichen (359 eck unten rechts)</td></tr><tr><td class="line-number" value="1641"></td><td class="line-content">    assets.forEach(AssetIt,this);</td></tr><tr><td class="line-number" value="1642"></td><td class="line-content">    gameobjects.add(assets);</td></tr><tr><td class="line-number" value="1643"></td><td class="line-content">    </td></tr><tr><td class="line-number" value="1644"></td><td class="line-content">    movingplatforms = game.add.group(); </td></tr><tr><td class="line-number" value="1645"></td><td class="line-content">    map.createFromObjects('objects', 153, 'movingplatforms', 0, true, false, movingplatforms);  //movingpaddle (153 linkerrand)</td></tr><tr><td class="line-number" value="1646"></td><td class="line-content">    map.createFromObjects('objects', 178, 'movingplatforms', 1, true, false, movingplatforms);  // karoplattform (178 linkerrand (4 blcke lang))</td></tr><tr><td class="line-number" value="1647"></td><td class="line-content">    movingplatforms.forEach(setupMovingPlatforms,this);</td></tr><tr><td class="line-number" value="1648"></td><td class="line-content">    gameobjects.add(movingplatforms);</td></tr><tr><td class="line-number" value="1649"></td><td class="line-content">    </td></tr><tr><td class="line-number" value="1650"></td><td class="line-content">    </td></tr><tr><td class="line-number" value="1651"></td><td class="line-content">    finishlines = game.add.group();</td></tr><tr><td class="line-number" value="1652"></td><td class="line-content">    map.createFromObjects('objects', 114, 'coin', 0, true, false,finishlines); </td></tr><tr><td class="line-number" value="1653"></td><td class="line-content">    finishlines.forEach(setupFinshline,this);</td></tr><tr><td class="line-number" value="1654"></td><td class="line-content">    gameobjects.add(finishlines);</td></tr><tr><td class="line-number" value="1655"></td><td class="line-content">    </td></tr><tr><td class="line-number" value="1656"></td><td class="line-content">    savepoints = game.add.group();</td></tr><tr><td class="line-number" value="1657"></td><td class="line-content">    map.createFromObjects('objects', 360, 'questionmark', 3, true, false,savepoints); </td></tr><tr><td class="line-number" value="1658"></td><td class="line-content">    savepoints.forEach(setupSavepoint,this);</td></tr><tr><td class="line-number" value="1659"></td><td class="line-content">    gameobjects.add(savepoints);</td></tr><tr><td class="line-number" value="1660"></td><td class="line-content">    </td></tr><tr><td class="line-number" value="1661"></td><td class="line-content">    chains = game.add.group();</td></tr><tr><td class="line-number" value="1662"></td><td class="line-content">    map.createFromObjects('objects', 295, 'chain', 0, false, false,chains);   //this first chain element is set to exists=false because its just there to get the position and the length out ouf tiled editor</td></tr><tr><td class="line-number" value="1663"></td><td class="line-content">    chains.forEach(setupChains,this);</td></tr><tr><td class="line-number" value="1664"></td><td class="line-content">    gameobjects.add(chains);</td></tr><tr><td class="line-number" value="1665"></td><td class="line-content">    </td></tr><tr><td class="line-number" value="1666"></td><td class="line-content">    enemies = game.add.group();</td></tr><tr><td class="line-number" value="1667"></td><td class="line-content">    enemies.name='enemies';</td></tr><tr><td class="line-number" value="1668"></td><td class="line-content">    enemies.enableBody = true;</td></tr><tr><td class="line-number" value="1669"></td><td class="line-content">    enemies.physicsBodyType = Phaser.Physics.P2JS;</td></tr><tr><td class="line-number" value="1670"></td><td class="line-content">    map.createFromObjects('objects', 57, 'enemysheet', 0, true, false, enemies );  //rote schildi</td></tr><tr><td class="line-number" value="1671"></td><td class="line-content">    map.createFromObjects('objects', 76, 'enemysheet', 1, true, false, enemies );  //grne schildi</td></tr><tr><td class="line-number" value="1672"></td><td class="line-content">    map.createFromObjects('objects', 95, 'gomba', 0, true, false, enemies);  //gomba</td></tr><tr><td class="line-number" value="1673"></td><td class="line-content">    enemies.forEach(setupEnemies,this);</td></tr><tr><td class="line-number" value="1674"></td><td class="line-content">    gameobjects.add(enemies);</td></tr><tr><td class="line-number" value="1675"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1676"></td><td class="line-content">    if (currentstate!='menu'){</td></tr><tr><td class="line-number" value="1677"></td><td class="line-content">        coin = game.add.sprite(game.camera.width/2,32,'ui',0)</td></tr><tr><td class="line-number" value="1678"></td><td class="line-content">        coin.fixedToCamera=true;</td></tr><tr><td class="line-number" value="1679"></td><td class="line-content">        coin.anchor.setTo(0.5,0.5);</td></tr><tr><td class="line-number" value="1680"></td><td class="line-content">        textobjects.add(coin);</td></tr><tr><td class="line-number" value="1681"></td><td class="line-content">    </td></tr><tr><td class="line-number" value="1682"></td><td class="line-content">        scoreText = game.add.text(game.camera.width/2+20, 26, ' x '+score, { fill: '#ececec', font: '16px Arial' });</td></tr><tr><td class="line-number" value="1683"></td><td class="line-content">        scoreText.fixedToCamera = true; </td></tr><tr><td class="line-number" value="1684"></td><td class="line-content">        scoreText.x = game.camera.width - scoreText.width/2</td></tr><tr><td class="line-number" value="1685"></td><td class="line-content">        textobjects.add(scoreText);</td></tr><tr><td class="line-number" value="1686"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="1687"></td><td class="line-content">        for (i=1; i&lt;=player_lives;i++){</td></tr><tr><td class="line-number" value="1688"></td><td class="line-content">                heart = game.add.sprite(34*i,32,'ui',1)</td></tr><tr><td class="line-number" value="1689"></td><td class="line-content">                heart.anchor.setTo(0.5,0.5);</td></tr><tr><td class="line-number" value="1690"></td><td class="line-content">                heart.fixedToCamera=true;</td></tr><tr><td class="line-number" value="1691"></td><td class="line-content">                textobjects.add(heart);</td></tr><tr><td class="line-number" value="1692"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1693"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="1694"></td><td class="line-content">        button = game.add.button(game.camera.width-64,0, 'menucorner', function(){game.state.start('menu',true,false);}, this, 0, 1, 1);</td></tr><tr><td class="line-number" value="1695"></td><td class="line-content">        button.fixedToCamera=true;</td></tr><tr><td class="line-number" value="1696"></td><td class="line-content">        textobjects.add(button);</td></tr><tr><td class="line-number" value="1697"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1698"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="1699"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1700"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1701"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1702"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1703"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1704"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1705"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1706"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1707"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1708"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1709"></td><td class="line-content">function shootSensor(buttonanchor){</td></tr><tr><td class="line-number" value="1710"></td><td class="line-content">	if (docked){destroyAnchor();}</td></tr><tr><td class="line-number" value="1711"></td><td class="line-content">	if (sensorexists || chainAnchor || !player_chain ){return}  //don't fire twice</td></tr><tr><td class="line-number" value="1712"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1713"></td><td class="line-content">    sensor = anchorgroup.create(player.x, player.y, 'anchor',3);</td></tr><tr><td class="line-number" value="1714"></td><td class="line-content">    game.physics.p2.enable(sensor,false);</td></tr><tr><td class="line-number" value="1715"></td><td class="line-content">    sensor.body.data.gravityScale=0;</td></tr><tr><td class="line-number" value="1716"></td><td class="line-content">	sensor.body.setCollisionGroup(fireballCG);</td></tr><tr><td class="line-number" value="1717"></td><td class="line-content">	sensor.body.collides([groundCG,questionmarkCG,enemyAirCG,enemyGroundCG]);</td></tr><tr><td class="line-number" value="1718"></td><td class="line-content">    sensor.body.createGroupCallback(groundCG, sensorCollision, this);</td></tr><tr><td class="line-number" value="1719"></td><td class="line-content">    sensor.body.createGroupCallback(questionmarkCG, sensorCollision, this);</td></tr><tr><td class="line-number" value="1720"></td><td class="line-content">	sensor.alpha=0.5;</td></tr><tr><td class="line-number" value="1721"></td><td class="line-content">	if(buttonanchor){</td></tr><tr><td class="line-number" value="1722"></td><td class="line-content">		circlebuttonAngle = angleBetween(buttonanchor, game.input);</td></tr><tr><td class="line-number" value="1723"></td><td class="line-content">		sensorAngle=Math.degrees(circlebuttonAngle);</td></tr><tr><td class="line-number" value="1724"></td><td class="line-content">		sensor.body.angle=sensorAngle;</td></tr><tr><td class="line-number" value="1725"></td><td class="line-content">		sensor.body.velocity.x = Math.cos(circlebuttonAngle) * 2000;</td></tr><tr><td class="line-number" value="1726"></td><td class="line-content">		sensor.body.velocity.y = Math.sin(circlebuttonAngle) * 2000;</td></tr><tr><td class="line-number" value="1727"></td><td class="line-content">	}</td></tr><tr><td class="line-number" value="1728"></td><td class="line-content">	else {</td></tr><tr><td class="line-number" value="1729"></td><td class="line-content">		sensorAngle = Math.atan2(game.camera.y+game.input.y - player.y, game.camera.x+game.input.x - player.x);</td></tr><tr><td class="line-number" value="1730"></td><td class="line-content">		sensorAngle=Math.degrees(sensorAngle);</td></tr><tr><td class="line-number" value="1731"></td><td class="line-content">		sensor.body.angle=sensorAngle;</td></tr><tr><td class="line-number" value="1732"></td><td class="line-content">		moveToPointer(sensor,2000);  //object, speed</td></tr><tr><td class="line-number" value="1733"></td><td class="line-content">	}</td></tr><tr><td class="line-number" value="1734"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="1735"></td><td class="line-content">function sensorCollision(thissensor,ground){</td></tr><tr><td class="line-number" value="1736"></td><td class="line-content">    if (sensorexists == true) {return} else {  sensorexists=true;}  //this is important because otherwise the collision callback would be fired more than once</td></tr><tr><td class="line-number" value="1737"></td><td class="line-content">    sensorX = thissensor.x;</td></tr><tr><td class="line-number" value="1738"></td><td class="line-content">    sensorY = thissensor.y;</td></tr><tr><td class="line-number" value="1739"></td><td class="line-content">    if (thissensor) { thissensor.sprite.kill();}</td></tr><tr><td class="line-number" value="1740"></td><td class="line-content">	if (sensor) {sensor.kill();}</td></tr><tr><td class="line-number" value="1741"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1742"></td><td class="line-content">    wallAnchor = anchorgroup.create(sensorX, sensorY, 'anchor',3);   //duplicate the sensor and use this one for the constraint.. this is neccesary because the rotated and fast-shot "sensor" is not good for precise constraints - it's physics body properties seem to be way off</td></tr><tr><td class="line-number" value="1743"></td><td class="line-content">    game.physics.p2.enable(wallAnchor,false);</td></tr><tr><td class="line-number" value="1744"></td><td class="line-content">    wallAnchor.body.setCollisionGroup(groundCG);</td></tr><tr><td class="line-number" value="1745"></td><td class="line-content">    wallAnchor.body.collides([fireballCG]);</td></tr><tr><td class="line-number" value="1746"></td><td class="line-content">    wallAnchor.body.static=true;</td></tr><tr><td class="line-number" value="1747"></td><td class="line-content">    wallAnchor.alpha=0;</td></tr><tr><td class="line-number" value="1748"></td><td class="line-content">    sensorDistance = distanceBetweenPoints([player.body.x,player.body.y],[sensorX,sensorY])  //point [x,y], point [x,y]</td></tr><tr><td class="line-number" value="1749"></td><td class="line-content">    chainLength = Math.round(sensorDistance / 19);</td></tr><tr><td class="line-number" value="1750"></td><td class="line-content">	if (chainLength != 0){  createChainElement(0, chainLength); } // create first chainelement the chainAnchor</td></tr><tr><td class="line-number" value="1751"></td><td class="line-content">	else {destroyAnchor();}</td></tr><tr><td class="line-number" value="1752"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="1753"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1754"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1755"></td><td class="line-content">function destroyAnchor(){</td></tr><tr><td class="line-number" value="1756"></td><td class="line-content">    chainSectionCount = 0;</td></tr><tr><td class="line-number" value="1757"></td><td class="line-content">    accelerate = false;  </td></tr><tr><td class="line-number" value="1758"></td><td class="line-content">    docked = false;</td></tr><tr><td class="line-number" value="1759"></td><td class="line-content">    sensorexists = false;</td></tr><tr><td class="line-number" value="1760"></td><td class="line-content">    chainAnchor = false;</td></tr><tr><td class="line-number" value="1761"></td><td class="line-content">    lastElement = false;</td></tr><tr><td class="line-number" value="1762"></td><td class="line-content">    clearConstraints();</td></tr><tr><td class="line-number" value="1763"></td><td class="line-content">    anchorgroup.destroy(true,true);  // destroy children, dont destroy group</td></tr><tr><td class="line-number" value="1764"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="1765"></td><td class="line-content">function createChainElement(chainSection, chainLength){</td></tr><tr><td class="line-number" value="1766"></td><td class="line-content">	if(docked == true ){return}</td></tr><tr><td class="line-number" value="1767"></td><td class="line-content">    var x=player.body.x;</td></tr><tr><td class="line-number" value="1768"></td><td class="line-content">    var y=player.body.y;</td></tr><tr><td class="line-number" value="1769"></td><td class="line-content">    var height = 20;  //height for the physics body - your image height is 8px</td></tr><tr><td class="line-number" value="1770"></td><td class="line-content">    var width = 16;   //this is the width for the physics body.. if to small the rectangles will get scrambled together</td></tr><tr><td class="line-number" value="1771"></td><td class="line-content">    var maxForce =100000;  //the force that holds the rectangles together</td></tr><tr><td class="line-number" value="1772"></td><td class="line-content">	if (chainSection == 0) { // first chainSection</td></tr><tr><td class="line-number" value="1773"></td><td class="line-content">        newElement = anchorgroup.create(x, y, 'chain',3);</td></tr><tr><td class="line-number" value="1774"></td><td class="line-content">        game.physics.p2.enable(newElement,false);</td></tr><tr><td class="line-number" value="1775"></td><td class="line-content">        newElement.body.setRectangle(width,height);</td></tr><tr><td class="line-number" value="1776"></td><td class="line-content">        newElement.body.angle=sensorAngle+90;  //+90</td></tr><tr><td class="line-number" value="1777"></td><td class="line-content">        newElement.body.mass =  chainLength;</td></tr><tr><td class="line-number" value="1778"></td><td class="line-content">        newElement.body.angularDamping=1;</td></tr><tr><td class="line-number" value="1779"></td><td class="line-content">        newElement.body.data.gravityScale=0;</td></tr><tr><td class="line-number" value="1780"></td><td class="line-content">        newElement.body.data.shapes[0].sensor = false;</td></tr><tr><td class="line-number" value="1781"></td><td class="line-content">        newElement.body.setCollisionGroup(fireballCG);</td></tr><tr><td class="line-number" value="1782"></td><td class="line-content">        newElement.body.collides([groundCG,questionmarkCG]);</td></tr><tr><td class="line-number" value="1783"></td><td class="line-content">		newElement.body.createGroupCallback(groundCG, anchorCollision, this);</td></tr><tr><td class="line-number" value="1784"></td><td class="line-content">		newElement.body.createGroupCallback(questionmarkCG, anchorCollision, this);</td></tr><tr><td class="line-number" value="1785"></td><td class="line-content">        chainAnchor = newElement;</td></tr><tr><td class="line-number" value="1786"></td><td class="line-content">        accelerate = true; </td></tr><tr><td class="line-number" value="1787"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1788"></td><td class="line-content">    else{</td></tr><tr><td class="line-number" value="1789"></td><td class="line-content">        newElement = anchorgroup.create(x, y, 'chain',1); </td></tr><tr><td class="line-number" value="1790"></td><td class="line-content">        newElement.scale.setTo(0.6,1);</td></tr><tr><td class="line-number" value="1791"></td><td class="line-content">        game.physics.p2.enable(newElement,false);</td></tr><tr><td class="line-number" value="1792"></td><td class="line-content">        newElement.body.setRectangle(width,height);</td></tr><tr><td class="line-number" value="1793"></td><td class="line-content">        newElement.body.angle=sensorAngle+90;</td></tr><tr><td class="line-number" value="1794"></td><td class="line-content">        newElement.body.mass =  chainLength/chainSectionCount;  // this reduces the mass of every new ropeelement (it stops the rope from beeing pulled apart but it introduces other obstacles) </td></tr><tr><td class="line-number" value="1795"></td><td class="line-content">        newElement.body.data.gravityScale=0;</td></tr><tr><td class="line-number" value="1796"></td><td class="line-content">        newElement.body.data.shapes[0].sensor = true;</td></tr><tr><td class="line-number" value="1797"></td><td class="line-content">        chainAnchor = newElement;</td></tr><tr><td class="line-number" value="1798"></td><td class="line-content">        	</td></tr><tr><td class="line-number" value="1799"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1800"></td><td class="line-content">	if (chainSectionCount % 2 == 1)  {lastElement.bringToTop();}</td></tr><tr><td class="line-number" value="1801"></td><td class="line-content">    if (lastElement) {  constraints.push(game.physics.p2.createRevoluteConstraint(newElement, [0,-8], lastElement, [0,8], maxForce) ); }  </td></tr><tr><td class="line-number" value="1802"></td><td class="line-content">    if (chainSection == chainLength) { // if lastRopeSection &gt; anchor Player</td></tr><tr><td class="line-number" value="1803"></td><td class="line-content"> 		constraints.push(game.physics.p2.createRevoluteConstraint( newElement, [0,8],player, [0,8], maxForce) ); </td></tr><tr><td class="line-number" value="1804"></td><td class="line-content">		docked = true;</td></tr><tr><td class="line-number" value="1805"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1806"></td><td class="line-content">    lastElement = newElement;</td></tr><tr><td class="line-number" value="1807"></td><td class="line-content">    player.bringToTop();</td></tr><tr><td class="line-number" value="1808"></td><td class="line-content">    layerforeground.bringToTop(); </td></tr><tr><td class="line-number" value="1809"></td><td class="line-content">    chainSectionCount++;</td></tr><tr><td class="line-number" value="1810"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="1811"></td><td class="line-content">function anchorCollision(thisAnchor){</td></tr><tr><td class="line-number" value="1812"></td><td class="line-content">    if (accelerate == false) {return} else { accelerate = false;}</td></tr><tr><td class="line-number" value="1813"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1814"></td><td class="line-content">    constraints.push(game.physics.p2.createRevoluteConstraint(thisAnchor, [0,-8], wallAnchor, [0,0], 100000) );</td></tr><tr><td class="line-number" value="1815"></td><td class="line-content">    anchorgroup.forEach(function(element){ element.body.data.gravityScale=1;element.body.velocity.x=0; element.body.velocity.y=0; element.body.data.shapes[0].sensor = true;});  // activate gravity and stopp all element so the player doesn't get pulled away</td></tr><tr><td class="line-number" value="1816"></td><td class="line-content">    player.body.velocity.x=0; </td></tr><tr><td class="line-number" value="1817"></td><td class="line-content">    player.body.velocity.y=0;</td></tr><tr><td class="line-number" value="1818"></td><td class="line-content">    climbing = false;  //shooting while climbing kicks you out of climbmode </td></tr><tr><td class="line-number" value="1819"></td><td class="line-content">    hanging = false;   //shooting while hanging kicks you out of hangmode </td></tr><tr><td class="line-number" value="1820"></td><td class="line-content">    if (playerChainRC){game.physics.p2.removeConstraint(playerChainRC);} // release player if constrained</td></tr><tr><td class="line-number" value="1821"></td><td class="line-content">    player.body.data.gravityScale=1;  // hang/climbmode has no gravity - restore it</td></tr><tr><td class="line-number" value="1822"></td><td class="line-content">}    </td></tr><tr><td class="line-number" value="1823"></td><td class="line-content">function clearConstraints(){</td></tr><tr><td class="line-number" value="1824"></td><td class="line-content">    for (i=0; i&lt;=constraints.length; i++){ game.physics.p2.removeConstraint(constraints[i]); }</td></tr><tr><td class="line-number" value="1825"></td><td class="line-content">	constraints = []; </td></tr><tr><td class="line-number" value="1826"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="1827"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1828"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1829"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1830"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1831"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1832"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1833"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1834"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1835"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1836"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1837"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1838"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1839"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1840"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1841"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1842"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1843"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1844"></td><td class="line-content">var jumpspeedx = 0;</td></tr><tr><td class="line-number" value="1845"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1846"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1847"></td><td class="line-content">function jump_now(){</td></tr><tr><td class="line-number" value="1848"></td><td class="line-content">    if (gamestate=='win'||gamestate=='lost'){return;} </td></tr><tr><td class="line-number" value="1849"></td><td class="line-content">    destroyAnchor();</td></tr><tr><td class="line-number" value="1850"></td><td class="line-content">    if (level === levels &amp;&amp; jumptimer &lt; game.time.now){  //flappy level is the last level -- hence levels </td></tr><tr><td class="line-number" value="1851"></td><td class="line-content">        game.sound.play('jump');</td></tr><tr><td class="line-number" value="1852"></td><td class="line-content">        player.body.moveUp(650);</td></tr><tr><td class="line-number" value="1853"></td><td class="line-content">        jumptimer = game.time.now + 200;</td></tr><tr><td class="line-number" value="1854"></td><td class="line-content">        particleBurst(player,10);</td></tr><tr><td class="line-number" value="1855"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1856"></td><td class="line-content">    else if (climbing === true ){  // get out of climb mode</td></tr><tr><td class="line-number" value="1857"></td><td class="line-content">        game.sound.play('jump');</td></tr><tr><td class="line-number" value="1858"></td><td class="line-content">        player.body.moveUp(500);</td></tr><tr><td class="line-number" value="1859"></td><td class="line-content">        player.body.data.gravityScale=1; </td></tr><tr><td class="line-number" value="1860"></td><td class="line-content">        climbing = false;</td></tr><tr><td class="line-number" value="1861"></td><td class="line-content">        jumpHeightCounter = 0;</td></tr><tr><td class="line-number" value="1862"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1863"></td><td class="line-content">    else if (hanging === true){  // get out of hanging</td></tr><tr><td class="line-number" value="1864"></td><td class="line-content">        jumpHeightCounter = 0;</td></tr><tr><td class="line-number" value="1865"></td><td class="line-content">		jumpspeedx = Math.abs(chainElement.body.velocity.x*30)+200;</td></tr><tr><td class="line-number" value="1866"></td><td class="line-content">		hanging = false;</td></tr><tr><td class="line-number" value="1867"></td><td class="line-content">		if (playerChainRC){game.physics.p2.removeConstraint(playerChainRC);} // the player is constrained to one chain element.. delete this constraint and release player</td></tr><tr><td class="line-number" value="1868"></td><td class="line-content">		player.body.data.gravityScale=1;</td></tr><tr><td class="line-number" value="1869"></td><td class="line-content">		hangTimer = game.time.now + 500;</td></tr><tr><td class="line-number" value="1870"></td><td class="line-content">		player.body.velocity.x=chainElement.body.velocity.x*-30;  // must be negative to get the right direction dont know why</td></tr><tr><td class="line-number" value="1871"></td><td class="line-content">		player.body.velocity.y=-300;</td></tr><tr><td class="line-number" value="1872"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1873"></td><td class="line-content">    else {</td></tr><tr><td class="line-number" value="1874"></td><td class="line-content">        if ( touchingDown(player.body)){</td></tr><tr><td class="line-number" value="1875"></td><td class="line-content">            game.sound.play('jump');</td></tr><tr><td class="line-number" value="1876"></td><td class="line-content">            player.body.moveUp(700);</td></tr><tr><td class="line-number" value="1877"></td><td class="line-content">            jumpHeightCounter = 1;</td></tr><tr><td class="line-number" value="1878"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1879"></td><td class="line-content">        else if (jumpHeightCounter == 1){</td></tr><tr><td class="line-number" value="1880"></td><td class="line-content">                game.sound.play('jump');</td></tr><tr><td class="line-number" value="1881"></td><td class="line-content">                player.body.moveUp(700);</td></tr><tr><td class="line-number" value="1882"></td><td class="line-content">                jumpHeightCounter = 0;</td></tr><tr><td class="line-number" value="1883"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1884"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1885"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="1886"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1887"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1888"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1889"></td><td class="line-content">function particleBurst(source,count) {</td></tr><tr><td class="line-number" value="1890"></td><td class="line-content">    emitter.x = source.body.x;</td></tr><tr><td class="line-number" value="1891"></td><td class="line-content">    emitter.y = source.body.y;</td></tr><tr><td class="line-number" value="1892"></td><td class="line-content">    emitter.start(true, 2500, null, count);   //explode, lifespan, .. , count</td></tr><tr><td class="line-number" value="1893"></td><td class="line-content">    emitter.forEach(setUp, this);</td></tr><tr><td class="line-number" value="1894"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="1895"></td><td class="line-content">function setUp(particle){</td></tr><tr><td class="line-number" value="1896"></td><td class="line-content">    if (!particle.exists) {particle.alpha=1;}</td></tr><tr><td class="line-number" value="1897"></td><td class="line-content">    game.add.tween(particle).to({ alpha: 0 }, 1000, Phaser.Easing.Cubic.Out, true);</td></tr><tr><td class="line-number" value="1898"></td><td class="line-content">    game.add.tween(particle.scale).to({ x: 2,y:2 }, 1000, Phaser.Easing.Cubic.Out, true);</td></tr><tr><td class="line-number" value="1899"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="1900"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1901"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1902"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1903"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1904"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1905"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1906"></td><td class="line-content">function fire_now(buttonfire) {</td></tr><tr><td class="line-number" value="1907"></td><td class="line-content">    if (gamestate=='win'||gamestate=='lost'){return;} </td></tr><tr><td class="line-number" value="1908"></td><td class="line-content">	if (buttonfire){weaponangle = Math.degrees(angleBetween(buttonfire,game.input));}</td></tr><tr><td class="line-number" value="1909"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1910"></td><td class="line-content">    if (game.time.now &gt; nextFire &amp;&amp; player_health == 3 &amp;&amp; !hanging &amp;&amp; !climbing){</td></tr><tr><td class="line-number" value="1911"></td><td class="line-content">        game.sound.play('fire');</td></tr><tr><td class="line-number" value="1912"></td><td class="line-content">        nextFire = game.time.now + fireRate;</td></tr><tr><td class="line-number" value="1913"></td><td class="line-content">        var fireball = fireballs.getFirstExists(false);</td></tr><tr><td class="line-number" value="1914"></td><td class="line-content">        if (fireball){</td></tr><tr><td class="line-number" value="1915"></td><td class="line-content">            fireball.exists = true;</td></tr><tr><td class="line-number" value="1916"></td><td class="line-content">            fireball.lifespan=2500;  //kill after 2500 ms</td></tr><tr><td class="line-number" value="1917"></td><td class="line-content">            game.physics.p2.enable(fireball);</td></tr><tr><td class="line-number" value="1918"></td><td class="line-content">            		</td></tr><tr><td class="line-number" value="1919"></td><td class="line-content">            fireball.body.setCircle(6);</td></tr><tr><td class="line-number" value="1920"></td><td class="line-content">            fireball.body.setMaterial(fireballMaterial);</td></tr><tr><td class="line-number" value="1921"></td><td class="line-content">            fireball.body.setCollisionGroup(fireballCG);</td></tr><tr><td class="line-number" value="1922"></td><td class="line-content">            fireball.body.collides([groundCG, enemyAirCG,enemyGroundCG, questionmarkCG]);</td></tr><tr><td class="line-number" value="1923"></td><td class="line-content">            fireball.body.onBeginContact.add(fireballCollision, fireball);</td></tr><tr><td class="line-number" value="1924"></td><td class="line-content">            //generate smoke when lifespan is over - bound to the specific fireball to be able to destroy the timer when the fireball is destroyed because of an enemy impact</td></tr><tr><td class="line-number" value="1925"></td><td class="line-content">            fireball.timer = game.time.create(false);</td></tr><tr><td class="line-number" value="1926"></td><td class="line-content">            fireball.timer.add(2500, particleBurst, this, fireball,1);</td></tr><tr><td class="line-number" value="1927"></td><td class="line-content">            fireball.timer.start();</td></tr><tr><td class="line-number" value="1928"></td><td class="line-content">            </td></tr><tr><td class="line-number" value="1929"></td><td class="line-content">            if(buttonfire){</td></tr><tr><td class="line-number" value="1930"></td><td class="line-content">                fireball.reset(player.x, player.y);</td></tr><tr><td class="line-number" value="1931"></td><td class="line-content">                circlebuttonAngle = angleBetween(buttonfire, game.input);</td></tr><tr><td class="line-number" value="1932"></td><td class="line-content">                fireballAngle=Math.degrees(circlebuttonAngle);</td></tr><tr><td class="line-number" value="1933"></td><td class="line-content">                fireball.body.angle=fireballAngle;</td></tr><tr><td class="line-number" value="1934"></td><td class="line-content">                fireball.body.x += Math.cos(circlebuttonAngle) * 30;</td></tr><tr><td class="line-number" value="1935"></td><td class="line-content">                fireball.body.y += Math.sin(circlebuttonAngle) * 30;</td></tr><tr><td class="line-number" value="1936"></td><td class="line-content">                fireball.body.velocity.x = Math.cos(circlebuttonAngle) * 1000;</td></tr><tr><td class="line-number" value="1937"></td><td class="line-content">                fireball.body.velocity.y = Math.sin(circlebuttonAngle) * 1000;</td></tr><tr><td class="line-number" value="1938"></td><td class="line-content">				if ( weaponangle &gt;  -90 &amp;&amp; weaponangle &lt; 90){ gun1.scale.x = 1;}else{ gun1.scale.x = -1;}</td></tr><tr><td class="line-number" value="1939"></td><td class="line-content">				if (gun1.scale.x &lt; 0){  gun1.body.angle = weaponangle -180;}</td></tr><tr><td class="line-number" value="1940"></td><td class="line-content">				else{ gun1.body.angle = weaponangle;  }</td></tr><tr><td class="line-number" value="1941"></td><td class="line-content">				gun1.body.velocity.x = Math.cos(circlebuttonAngle) * -2000;</td></tr><tr><td class="line-number" value="1942"></td><td class="line-content">                gun1.body.velocity.y = Math.sin(circlebuttonAngle) * -2000;</td></tr><tr><td class="line-number" value="1943"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1944"></td><td class="line-content">            }</td></tr><tr><td class="line-number" value="1945"></td><td class="line-content">            else {</td></tr><tr><td class="line-number" value="1946"></td><td class="line-content">                fireball.reset(player.x, player.y);</td></tr><tr><td class="line-number" value="1947"></td><td class="line-content">                fireballAngleRad = Math.atan2(game.camera.y+game.input.y - player.y, game.camera.x+game.input.x - player.x);</td></tr><tr><td class="line-number" value="1948"></td><td class="line-content">                fireballAngle=Math.degrees(fireballAngleRad);</td></tr><tr><td class="line-number" value="1949"></td><td class="line-content">                fireball.body.angle=fireballAngle;</td></tr><tr><td class="line-number" value="1950"></td><td class="line-content">                fireball.body.x += Math.cos(fireballAngleRad) * 30;</td></tr><tr><td class="line-number" value="1951"></td><td class="line-content">                fireball.body.y += Math.sin(fireballAngleRad) * 30;</td></tr><tr><td class="line-number" value="1952"></td><td class="line-content">                moveToPointer(fireball,1000);  //object, speed</td></tr><tr><td class="line-number" value="1953"></td><td class="line-content">				gun1.body.velocity.x = Math.cos(fireballAngleRad) * -2000;</td></tr><tr><td class="line-number" value="1954"></td><td class="line-content">                gun1.body.velocity.y = Math.sin(fireballAngleRad) * -2000;</td></tr><tr><td class="line-number" value="1955"></td><td class="line-content">            }</td></tr><tr><td class="line-number" value="1956"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="1957"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1958"></td><td class="line-content">    else if (weapon_selected == 'sword' &amp;&amp; climbing == false &amp;&amp; hanging == false) {</td></tr><tr><td class="line-number" value="1959"></td><td class="line-content">		if (!game.device.desktop){   // on mobile change swordscale according to firebutton pressposition</td></tr><tr><td class="line-number" value="1960"></td><td class="line-content">			if ( weaponangle &gt;  -90 &amp;&amp; weaponangle &lt; 90){ sword.scale.x = 1;}else{ sword.scale.x = -1;}</td></tr><tr><td class="line-number" value="1961"></td><td class="line-content">		}</td></tr><tr><td class="line-number" value="1962"></td><td class="line-content">        if (sword.scale.x &lt; 0 ){angle2=-100; angle1=-0;}else {angle2=100;angle1=0;}</td></tr><tr><td class="line-number" value="1963"></td><td class="line-content">        game.add.tween(sword.body).to({ angle: angle2 }, 200, Phaser.Easing.Cubic.Out, true).to({ angle: angle1 }, 400, Phaser.Easing.Cubic.Out, true);</td></tr><tr><td class="line-number" value="1964"></td><td class="line-content">		game.add.tween(sword).to({ angle: angle2 }, 200, Phaser.Easing.Cubic.Out, true).to({ angle: angle1 }, 400, Phaser.Easing.Cubic.Out, true);</td></tr><tr><td class="line-number" value="1965"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1966"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="1967"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1968"></td><td class="line-content">function fireballCollision(object1){</td></tr><tr><td class="line-number" value="1969"></td><td class="line-content">    fireball=this;   // we send fireball instead of this in the onBeginContact function and here fireball is accessable as this</td></tr><tr><td class="line-number" value="1970"></td><td class="line-content">    if (object1.sprite &amp;&amp; object1.sprite.parent == enemies) {   //if the hit body is a sprite and belongs to enemies</td></tr><tr><td class="line-number" value="1971"></td><td class="line-content">        killEnemy(object1,fireball.body);</td></tr><tr><td class="line-number" value="1972"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="1973"></td><td class="line-content">} </td></tr><tr><td class="line-number" value="1974"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1975"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1976"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1977"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1978"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1979"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1980"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1981"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1982"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1983"></td><td class="line-content"></td></tr><tr><td class="line-number" value="1984"></td><td class="line-content">// since this function is not avalable in p2 - do it yourself</td></tr><tr><td class="line-number" value="1985"></td><td class="line-content">function angleBetween(obj1, obj2) {</td></tr><tr><td class="line-number" value="1986"></td><td class="line-content">    var angle = Math.atan2(game.camera.y+obj2.y - obj1.y, game.camera.x+ obj2.x - obj1.x);</td></tr><tr><td class="line-number" value="1987"></td><td class="line-content">	return angle;</td></tr><tr><td class="line-number" value="1988"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="1989"></td><td class="line-content">// since this function is not avalable in p2 - do it yourself</td></tr><tr><td class="line-number" value="1990"></td><td class="line-content">function distanceBetweenPoints(pointA,pointB){</td></tr><tr><td class="line-number" value="1991"></td><td class="line-content">    var dx = pointA[0] - pointB[0];  //distance ship X to enemy X</td></tr><tr><td class="line-number" value="1992"></td><td class="line-content">    var dy = pointA[1] - pointB[1];  //distance ship Y to enemy Y</td></tr><tr><td class="line-number" value="1993"></td><td class="line-content">    var dist = Math.sqrt(dx*dx + dy*dy);     //pythagoras ^^  (get the distance to each other)</td></tr><tr><td class="line-number" value="1994"></td><td class="line-content">    return dist;</td></tr><tr><td class="line-number" value="1995"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="1996"></td><td class="line-content">// since this function is not avalable in p2 - do it yourself</td></tr><tr><td class="line-number" value="1997"></td><td class="line-content">function distanceBetween(spriteA,spriteB){</td></tr><tr><td class="line-number" value="1998"></td><td class="line-content">    var dx = spriteA.body.x - spriteB.body.x;  //distance ship X to enemy X</td></tr><tr><td class="line-number" value="1999"></td><td class="line-content">    var dy = spriteA.body.y - spriteB.body.y;  //distance ship Y to enemy Y</td></tr><tr><td class="line-number" value="2000"></td><td class="line-content">    var dist = Math.sqrt(dx*dx + dy*dy);     //pythagoras ^^  (get the distance to each other)</td></tr><tr><td class="line-number" value="2001"></td><td class="line-content">    return dist;</td></tr><tr><td class="line-number" value="2002"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="2003"></td><td class="line-content">// since this function is not avalable in p2 - do it yourself</td></tr><tr><td class="line-number" value="2004"></td><td class="line-content">function moveToPointer(obj1, speed) {</td></tr><tr><td class="line-number" value="2005"></td><td class="line-content">    var angle = Math.atan2(game.camera.y+game.input.y - obj1.y,game.camera.x+ game.input.x - obj1.x);</td></tr><tr><td class="line-number" value="2006"></td><td class="line-content">    obj1.body.velocity.x = Math.cos(angle) * speed;</td></tr><tr><td class="line-number" value="2007"></td><td class="line-content">    obj1.body.velocity.y = Math.sin(angle) * speed;</td></tr><tr><td class="line-number" value="2008"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="2009"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2010"></td><td class="line-content">// since this function is not avalable in p2 - do it yourself</td></tr><tr><td class="line-number" value="2011"></td><td class="line-content">function moveToPoint(obj1,point,speed) {</td></tr><tr><td class="line-number" value="2012"></td><td class="line-content">    var angle = Math.atan2(point[1] - obj1.y, point[0] - obj1.x);</td></tr><tr><td class="line-number" value="2013"></td><td class="line-content">    obj1.body.velocity.x = Math.cos(angle) * speed;</td></tr><tr><td class="line-number" value="2014"></td><td class="line-content">    obj1.body.velocity.y = Math.sin(angle) * speed;</td></tr><tr><td class="line-number" value="2015"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="2016"></td><td class="line-content">// since this function is not avalable in p2 - do it yourself</td></tr><tr><td class="line-number" value="2017"></td><td class="line-content">function touchingUp(someone) {</td></tr><tr><td class="line-number" value="2018"></td><td class="line-content">    var yAxis = p2.vec2.fromValues(0, 1);</td></tr><tr><td class="line-number" value="2019"></td><td class="line-content">    var result = false;</td></tr><tr><td class="line-number" value="2020"></td><td class="line-content">    for (var i = 0; i &lt; game.physics.p2.world.narrowphase.contactEquations.length; i++) {</td></tr><tr><td class="line-number" value="2021"></td><td class="line-content">        var c = game.physics.p2.world.narrowphase.contactEquations[i];</td></tr><tr><td class="line-number" value="2022"></td><td class="line-content">        if (c.bodyA === someone.data || c.bodyB === someone.data)        {</td></tr><tr><td class="line-number" value="2023"></td><td class="line-content">            var d = p2.vec2.dot(c.normalA, yAxis); // Normal dot Y-axis</td></tr><tr><td class="line-number" value="2024"></td><td class="line-content">            if (c.bodyA === someone.data) d *= -1;</td></tr><tr><td class="line-number" value="2025"></td><td class="line-content">            if (d &lt; -0.5) result = true;</td></tr><tr><td class="line-number" value="2026"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="2027"></td><td class="line-content">    } return result;</td></tr><tr><td class="line-number" value="2028"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="2029"></td><td class="line-content">function touchingDown(someone) {</td></tr><tr><td class="line-number" value="2030"></td><td class="line-content">    var yAxis = p2.vec2.fromValues(0, 1);</td></tr><tr><td class="line-number" value="2031"></td><td class="line-content">    var result = false;</td></tr><tr><td class="line-number" value="2032"></td><td class="line-content">    for (var i = 0; i &lt; game.physics.p2.world.narrowphase.contactEquations.length; i++) {</td></tr><tr><td class="line-number" value="2033"></td><td class="line-content">        var c = game.physics.p2.world.narrowphase.contactEquations[i];</td></tr><tr><td class="line-number" value="2034"></td><td class="line-content">        if (c.bodyA === someone.data || c.bodyB === someone.data)        {</td></tr><tr><td class="line-number" value="2035"></td><td class="line-content">            var d = p2.vec2.dot(c.normalA, yAxis); // Normal dot Y-axis</td></tr><tr><td class="line-number" value="2036"></td><td class="line-content">            if (c.bodyA === someone.data) d *= -1;</td></tr><tr><td class="line-number" value="2037"></td><td class="line-content">            if (d &gt; 0.5) result = true;</td></tr><tr><td class="line-number" value="2038"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="2039"></td><td class="line-content">    } return result;</td></tr><tr><td class="line-number" value="2040"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="2041"></td><td class="line-content">function touchingLeft(someone) {</td></tr><tr><td class="line-number" value="2042"></td><td class="line-content">    var xAxis = p2.vec2.fromValues(1,0);</td></tr><tr><td class="line-number" value="2043"></td><td class="line-content">    var result = false;</td></tr><tr><td class="line-number" value="2044"></td><td class="line-content">    for (var i = 0; i &lt; game.physics.p2.world.narrowphase.contactEquations.length; i++) {</td></tr><tr><td class="line-number" value="2045"></td><td class="line-content">        var c = game.physics.p2.world.narrowphase.contactEquations[i];</td></tr><tr><td class="line-number" value="2046"></td><td class="line-content">        if (c.bodyA === someone.data || c.bodyB === someone.data)        {</td></tr><tr><td class="line-number" value="2047"></td><td class="line-content">            var d = p2.vec2.dot(c.normalA, xAxis); // Normal dot Y-axis</td></tr><tr><td class="line-number" value="2048"></td><td class="line-content">            if (c.bodyA === someone.data) d *= -1;</td></tr><tr><td class="line-number" value="2049"></td><td class="line-content">            if (d &lt; -0.5) result = true;</td></tr><tr><td class="line-number" value="2050"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="2051"></td><td class="line-content">    } return result;</td></tr><tr><td class="line-number" value="2052"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="2053"></td><td class="line-content">function touchingRight(someone) {</td></tr><tr><td class="line-number" value="2054"></td><td class="line-content">    var xAxis = p2.vec2.fromValues(1,0);</td></tr><tr><td class="line-number" value="2055"></td><td class="line-content">    var result = false;</td></tr><tr><td class="line-number" value="2056"></td><td class="line-content">    for (var i = 0; i &lt; game.physics.p2.world.narrowphase.contactEquations.length; i++) {</td></tr><tr><td class="line-number" value="2057"></td><td class="line-content">        var c = game.physics.p2.world.narrowphase.contactEquations[i];</td></tr><tr><td class="line-number" value="2058"></td><td class="line-content">        if (c.bodyA === someone.data || c.bodyB === someone.data)        {</td></tr><tr><td class="line-number" value="2059"></td><td class="line-content">            var d = p2.vec2.dot(c.normalA, xAxis); // Normal dot Y-axis</td></tr><tr><td class="line-number" value="2060"></td><td class="line-content">            if (c.bodyA === someone.data) d *= -1;</td></tr><tr><td class="line-number" value="2061"></td><td class="line-content">            if (d &gt; 0.5) result = true;</td></tr><tr><td class="line-number" value="2062"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="2063"></td><td class="line-content">    } return result;</td></tr><tr><td class="line-number" value="2064"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="2065"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2066"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2067"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2068"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2069"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2070"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2071"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2072"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2073"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2074"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2075"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2076"></td><td class="line-content">function playerHit(player,enemy) {</td></tr><tr><td class="line-number" value="2077"></td><td class="line-content">    climbing = false;  // immediately end special player movement modes and reset gravityScale</td></tr><tr><td class="line-number" value="2078"></td><td class="line-content">    hanging = false;</td></tr><tr><td class="line-number" value="2079"></td><td class="line-content">    if (playerChainRC){game.physics.p2.removeConstraint(playerChainRC);}</td></tr><tr><td class="line-number" value="2080"></td><td class="line-content">    destroyAnchor();</td></tr><tr><td class="line-number" value="2081"></td><td class="line-content">    player.data.gravityScale=1;  //we already got the player.body on player so no further .body needed</td></tr><tr><td class="line-number" value="2082"></td><td class="line-content">    if (gamestate=='win' || gamestate=='lost' ||invincibleTimer &gt; game.time.now ){return;} //check if invincible or already finished</td></tr><tr><td class="line-number" value="2083"></td><td class="line-content">    if (touchingUp(enemy)&amp;&amp; enemy.sprite &amp;&amp; enemy.sprite.name != 'ghost'){ killEnemy(enemy);  }   //checks if enemy is not an enemyTILE but a sprite</td></tr><tr><td class="line-number" value="2084"></td><td class="line-content">    else if (player.sprite.health &gt;= 2) { </td></tr><tr><td class="line-number" value="2085"></td><td class="line-content">        hitboxchanged=true; </td></tr><tr><td class="line-number" value="2086"></td><td class="line-content">        destroyWeapon(weapon_selected);</td></tr><tr><td class="line-number" value="2087"></td><td class="line-content">        weapon_selected = 'sword';  //automatically select sword when losing fireflower</td></tr><tr><td class="line-number" value="2088"></td><td class="line-content">        createWeapon(weapon_selected);</td></tr><tr><td class="line-number" value="2089"></td><td class="line-content">        game.sound.play('shrink');</td></tr><tr><td class="line-number" value="2090"></td><td class="line-content">        player.sprite.damage(1);  //do it now</td></tr><tr><td class="line-number" value="2091"></td><td class="line-content">        player_health -= 1;        // store it for next level</td></tr><tr><td class="line-number" value="2092"></td><td class="line-content">        if (player.sprite.health == 1){ </td></tr><tr><td class="line-number" value="2093"></td><td class="line-content">            if (player.sprite.scale.x &lt; 0){x1=-0.8;x2=-1}else{x1=0.8;x2=1;}  //scale according to current direction</td></tr><tr><td class="line-number" value="2094"></td><td class="line-content">            invincibleTimer=game.time.now+1000;  //be invinicble for 1 second</td></tr><tr><td class="line-number" value="2095"></td><td class="line-content">            game.add.tween(player.sprite).to({alpha:0.4}, 200).to({alpha:1}, 200).to({alpha:0.4}, 200).to({alpha:1}, 200).start().onComplete.add(function (){player.sprite.scale.setTo(x1,0.8)}); //flash</td></tr><tr><td class="line-number" value="2096"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="2097"></td><td class="line-content">        else{</td></tr><tr><td class="line-number" value="2098"></td><td class="line-content">            invincibleTimer=game.time.now+1000;  //be invinicble for 1 second</td></tr><tr><td class="line-number" value="2099"></td><td class="line-content">            game.add.tween(player.sprite).to({alpha:0.4}, 200).to({alpha:1}, 200).to({alpha:0.4}, 200).to({alpha:1}, 200).start().onComplete.add(function (){ setupPlayerLooks(player.sprite,'mario');}, this); //flash</td></tr><tr><td class="line-number" value="2100"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="2101"></td><td class="line-content">    } //damage sprite (health belongs to the sprite not the body) and make invincible for 1 second</td></tr><tr><td class="line-number" value="2102"></td><td class="line-content">    else {   </td></tr><tr><td class="line-number" value="2103"></td><td class="line-content">		playerDie(player,enemy);</td></tr><tr><td class="line-number" value="2104"></td><td class="line-content">	}</td></tr><tr><td class="line-number" value="2105"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="2106"></td><td class="line-content">function playerDie(player,enemy) {  //this gets a phaser.physics.body  so no further .body needed.. to acces sprite write .sprite</td></tr><tr><td class="line-number" value="2107"></td><td class="line-content">	gamestate='lost';</td></tr><tr><td class="line-number" value="2108"></td><td class="line-content">    player_lives -= 1;</td></tr><tr><td class="line-number" value="2109"></td><td class="line-content">    player_health=1;</td></tr><tr><td class="line-number" value="2110"></td><td class="line-content">    player_chain = false;</td></tr><tr><td class="line-number" value="2111"></td><td class="line-content">    </td></tr><tr><td class="line-number" value="2112"></td><td class="line-content">	if (weapon_selected=='sword'){</td></tr><tr><td class="line-number" value="2113"></td><td class="line-content">		game.physics.p2.removeConstraint(swordRC);</td></tr><tr><td class="line-number" value="2114"></td><td class="line-content">		sword.body.moveDown(300);  // cannot enable physics normally for sword.  jumps to camera0,0 - therefore workaround</td></tr><tr><td class="line-number" value="2115"></td><td class="line-content">		sword.body.fixedRotation=false;  // if you lose your sword flies away</td></tr><tr><td class="line-number" value="2116"></td><td class="line-content">		sword.body.angularVelocity=5;</td></tr><tr><td class="line-number" value="2117"></td><td class="line-content">	}</td></tr><tr><td class="line-number" value="2118"></td><td class="line-content">	else if (weapon_selected=='fireflower'){</td></tr><tr><td class="line-number" value="2119"></td><td class="line-content">		game.physics.p2.removeConstraint(gun1RC);</td></tr><tr><td class="line-number" value="2120"></td><td class="line-content">	}</td></tr><tr><td class="line-number" value="2121"></td><td class="line-content">    player.clearCollision(true,true);  //no collision with anything anymore</td></tr><tr><td class="line-number" value="2122"></td><td class="line-content">    music.pause();</td></tr><tr><td class="line-number" value="2123"></td><td class="line-content">    player.sprite.bringToTop(); </td></tr><tr><td class="line-number" value="2124"></td><td class="line-content">    game.sound.play('lose',0.3);  // key, volume</td></tr><tr><td class="line-number" value="2125"></td><td class="line-content">    player.moveUp(300);</td></tr><tr><td class="line-number" value="2126"></td><td class="line-content">    player.collideWorldBounds=false; // can fall out of game world</td></tr><tr><td class="line-number" value="2127"></td><td class="line-content">    timerEvents[1]=game.time.events.add(Phaser.Timer.SECOND * 4, startNextLevel, this);</td></tr><tr><td class="line-number" value="2128"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="2129"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2130"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2131"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2132"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2133"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2134"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2135"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2136"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2137"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2138"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2139"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2140"></td><td class="line-content">function setupChains(chain){</td></tr><tr><td class="line-number" value="2141"></td><td class="line-content">    createChain(chain.length,chain.x+16,chain.y);</td></tr><tr><td class="line-number" value="2142"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="2143"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2144"></td><td class="line-content">function setupFinshline(finishline){</td></tr><tr><td class="line-number" value="2145"></td><td class="line-content">    game.physics.p2.enable(finishline); </td></tr><tr><td class="line-number" value="2146"></td><td class="line-content">    finishline.body.y += 32;  // we are replacing one tile with 4 so we need to adjust the position here</td></tr><tr><td class="line-number" value="2147"></td><td class="line-content">    finishline.body.x += 16;</td></tr><tr><td class="line-number" value="2148"></td><td class="line-content">    finishline.body.setCircle(50);</td></tr><tr><td class="line-number" value="2149"></td><td class="line-content">    finishline.body.data.gravityScale=0;</td></tr><tr><td class="line-number" value="2150"></td><td class="line-content">    finishline.body.static=true;</td></tr><tr><td class="line-number" value="2151"></td><td class="line-content">    finishline.body.fixedRotation=true;</td></tr><tr><td class="line-number" value="2152"></td><td class="line-content">    finishline.body.setCollisionGroup(finishlineCG);</td></tr><tr><td class="line-number" value="2153"></td><td class="line-content">    finishline.body.collides([playerCG,groundCG]);</td></tr><tr><td class="line-number" value="2154"></td><td class="line-content">    finishline.animations.add('bling', [0,1,2,3,4,5,6,7,8,9,8,7,6,5,4,3,2,1], 10, true);</td></tr><tr><td class="line-number" value="2155"></td><td class="line-content">    finishline.animations.play('bling');</td></tr><tr><td class="line-number" value="2156"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="2157"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2158"></td><td class="line-content">function setupEnemies(enemy){</td></tr><tr><td class="line-number" value="2159"></td><td class="line-content">    if (enemy.name == 'gomba'){</td></tr><tr><td class="line-number" value="2160"></td><td class="line-content">        enemy.scale.setTo(0.6,0.6);</td></tr><tr><td class="line-number" value="2161"></td><td class="line-content">        enemy.animations.add('walk', [0,1,2,3,4,3,2,1], 10, true);</td></tr><tr><td class="line-number" value="2162"></td><td class="line-content">        enemy.animations.play('walk');</td></tr><tr><td class="line-number" value="2163"></td><td class="line-content">        enemy.body.setCircle(16);</td></tr><tr><td class="line-number" value="2164"></td><td class="line-content">        enemy.body.y += 26</td></tr><tr><td class="line-number" value="2165"></td><td class="line-content">       // enemy.velo=100;</td></tr><tr><td class="line-number" value="2166"></td><td class="line-content">    }else {</td></tr><tr><td class="line-number" value="2167"></td><td class="line-content">        enemy.body.setCircle(12);</td></tr><tr><td class="line-number" value="2168"></td><td class="line-content">        enemy.body.y += 16 // just a little positioning correction</td></tr><tr><td class="line-number" value="2169"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="2170"></td><td class="line-content">    enemy.health=10; </td></tr><tr><td class="line-number" value="2171"></td><td class="line-content">    enemy.body.fixedRotation=true;</td></tr><tr><td class="line-number" value="2172"></td><td class="line-content">    enemy.body.allowSleep=true;</td></tr><tr><td class="line-number" value="2173"></td><td class="line-content">    enemy.body.setCollisionGroup(enemyGroundCG);</td></tr><tr><td class="line-number" value="2174"></td><td class="line-content">    enemy.body.collides([playerCG,platformCG,fireballCG,groundCG,enemyboundsCG]);</td></tr><tr><td class="line-number" value="2175"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="2176"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2177"></td><td class="line-content">function resetBullets() {</td></tr><tr><td class="line-number" value="2178"></td><td class="line-content">    if (gamestate=='win'||gamestate=='lost'){return;} </td></tr><tr><td class="line-number" value="2179"></td><td class="line-content">    if (!bullet || !bullet.parent || bullet.health &lt; 10){</td></tr><tr><td class="line-number" value="2180"></td><td class="line-content">        bullet = enemies.create(game.camera.x+game.camera.width, Math.random()*game.world.height-40, 'bullet'); //create bullet at the right side of the camera view</td></tr><tr><td class="line-number" value="2181"></td><td class="line-content">        bullet.health=10;  // health points..  bullets get only moved by moveAliveEnemy() when with full health</td></tr><tr><td class="line-number" value="2182"></td><td class="line-content">        bullet.name = "bullet";</td></tr><tr><td class="line-number" value="2183"></td><td class="line-content">        game.sound.play('cannon');</td></tr><tr><td class="line-number" value="2184"></td><td class="line-content">        bullet.body.collideWorldBounds=false;</td></tr><tr><td class="line-number" value="2185"></td><td class="line-content">        bullet.body.allowSleep=true;</td></tr><tr><td class="line-number" value="2186"></td><td class="line-content">        bullet.body.setCollisionGroup(enemyAirCG);</td></tr><tr><td class="line-number" value="2187"></td><td class="line-content">        bullet.body.collides([fireballCG,playerCG]);</td></tr><tr><td class="line-number" value="2188"></td><td class="line-content">        bullet.body.data.gravityScale=0;</td></tr><tr><td class="line-number" value="2189"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="2190"></td><td class="line-content">    else if (bullet.body.x &lt; game.camera.x){</td></tr><tr><td class="line-number" value="2191"></td><td class="line-content">        game.sound.play('cannon');</td></tr><tr><td class="line-number" value="2192"></td><td class="line-content">        bullet.body.reset(game.camera.x+game.camera.width,Math.random()*game.world.height-40);</td></tr><tr><td class="line-number" value="2193"></td><td class="line-content">        bullet.body.angle=0;</td></tr><tr><td class="line-number" value="2194"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="2195"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="2196"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2197"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2198"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2199"></td><td class="line-content">function killEnemy(enemy,fireball) {</td></tr><tr><td class="line-number" value="2200"></td><td class="line-content">    score += 1;</td></tr><tr><td class="line-number" value="2201"></td><td class="line-content">    scoreText.text = ' x '+score;  //update scoreText</td></tr><tr><td class="line-number" value="2202"></td><td class="line-content">    enemy.sprite.damage(5);  // takes 5 of 10 health points / 0 would call sprite.kill()</td></tr><tr><td class="line-number" value="2203"></td><td class="line-content">    game.sound.play('kick');</td></tr><tr><td class="line-number" value="2204"></td><td class="line-content">    enemy.moveUp(20);</td></tr><tr><td class="line-number" value="2205"></td><td class="line-content">    enemy.angularVelocity=10;</td></tr><tr><td class="line-number" value="2206"></td><td class="line-content">    enemy.clearCollision(true,true);</td></tr><tr><td class="line-number" value="2207"></td><td class="line-content">    enemy.data.gravityScale=1;</td></tr><tr><td class="line-number" value="2208"></td><td class="line-content">    if (fireball){particleBurst(fireball.sprite,10);fireball.sprite.timer.destroy();fireball.sprite.kill(); }  //if killed by fireball generate smoke, kill the fireball.timer that would generate a little bit of smoke, kill the fireball</td></tr><tr><td class="line-number" value="2209"></td><td class="line-content">    if (enemy.sprite.name == "gomba"){enemy.sprite.animations.stop();enemy.sprite.loadTexture('gomba', 5);}</td></tr><tr><td class="line-number" value="2210"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="2211"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2212"></td><td class="line-content">function moveAliveEnemy (enemy) { </td></tr><tr><td class="line-number" value="2213"></td><td class="line-content">    if (gamestate=='win'||gamestate=='lost'){return;} </td></tr><tr><td class="line-number" value="2214"></td><td class="line-content">    if (enemy.health==10){</td></tr><tr><td class="line-number" value="2215"></td><td class="line-content">        if (enemy.name == "redtoad" || enemy.name == "greentoad"||enemy.name == "gomba"){</td></tr><tr><td class="line-number" value="2216"></td><td class="line-content">            if (touchingLeft(enemy.body)||touchingRight(enemy.body)){enemy.body.x -= enemy.velo/50; enemy.velo *= -1;enemy.scale.x *=-1; } //set "back" schildi a few pixels to not fire touchingLeft/Right again and turn speed around</td></tr><tr><td class="line-number" value="2217"></td><td class="line-content">            enemy.body.velocity.x=enemy.velo;</td></tr><tr><td class="line-number" value="2218"></td><td class="line-content">         }</td></tr><tr><td class="line-number" value="2219"></td><td class="line-content">        else if (enemy.name == "bullet"){ enemy.body.moveLeft(200);   }</td></tr><tr><td class="line-number" value="2220"></td><td class="line-content">        else if (enemy.name == "ghost"){</td></tr><tr><td class="line-number" value="2221"></td><td class="line-content">            var speed =20;</td></tr><tr><td class="line-number" value="2222"></td><td class="line-content">            var angle = Math.atan2(player.y - enemy.y, player.x - enemy.x);</td></tr><tr><td class="line-number" value="2223"></td><td class="line-content">            enemy.body.rotation = angle + game.math.degToRad(180);  // correct angle of angry bullets (depends on the sprite used)</td></tr><tr><td class="line-number" value="2224"></td><td class="line-content">            enemy.body.force.x = Math.cos(angle) * speed;    // accelerateToObject </td></tr><tr><td class="line-number" value="2225"></td><td class="line-content">            enemy.body.force.y = Math.sin(angle) * speed;</td></tr><tr><td class="line-number" value="2226"></td><td class="line-content">            if (enemy.body.force.x &gt; 0){enemy.scale.x = -1}</td></tr><tr><td class="line-number" value="2227"></td><td class="line-content">            if (enemy.body.force.x &lt; 0){enemy.scale.x =  1}</td></tr><tr><td class="line-number" value="2228"></td><td class="line-content">            if (player.scale.x != enemy.scale.x){enemy.body.velocity.x = 0; enemy.body.velocity.y = 0; }  // otherwise stop immediately</td></tr><tr><td class="line-number" value="2229"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="2230"></td><td class="line-content">        else {</td></tr><tr><td class="line-number" value="2231"></td><td class="line-content">            // there are no other enemies atm</td></tr><tr><td class="line-number" value="2232"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="2233"></td><td class="line-content">    } </td></tr><tr><td class="line-number" value="2234"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="2235"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2236"></td><td class="line-content">function accelerateToObject(obj1, obj2, speed) {</td></tr><tr><td class="line-number" value="2237"></td><td class="line-content">    if (typeof speed === 'undefined') { speed = 20; }</td></tr><tr><td class="line-number" value="2238"></td><td class="line-content">    var angle = Math.atan2(obj2.y - obj1.y, obj2.x - obj1.x);</td></tr><tr><td class="line-number" value="2239"></td><td class="line-content">    obj1.body.rotation = angle + game.math.degToRad(180);  // correct angle of angry bullets (depends on the sprite used)</td></tr><tr><td class="line-number" value="2240"></td><td class="line-content">    obj1.body.force.x = Math.cos(angle) * speed;    // accelerateToObject </td></tr><tr><td class="line-number" value="2241"></td><td class="line-content">    obj1.body.force.y = Math.sin(angle) * speed;</td></tr><tr><td class="line-number" value="2242"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="2243"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2244"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2245"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2246"></td><td class="line-content">function setupSavepoint(questionmark){</td></tr><tr><td class="line-number" value="2247"></td><td class="line-content">    game.physics.p2.enable(questionmark);</td></tr><tr><td class="line-number" value="2248"></td><td class="line-content">    questionmark.body.y += 32;  //since we are replacing a 32x32 tile with a 64x64 object we need to adjust</td></tr><tr><td class="line-number" value="2249"></td><td class="line-content">    questionmark.body.static=true;</td></tr><tr><td class="line-number" value="2250"></td><td class="line-content">    questionmark.body.sprite.name='savepoint';</td></tr><tr><td class="line-number" value="2251"></td><td class="line-content">    questionmark.body.setCollisionGroup(questionmarkCG);</td></tr><tr><td class="line-number" value="2252"></td><td class="line-content">    questionmark.body.collides([playerCG,fireballCG,powerupsCG]);</td></tr><tr><td class="line-number" value="2253"></td><td class="line-content">    questionmark.body.setMaterial(groundMaterial);</td></tr><tr><td class="line-number" value="2254"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="2255"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2256"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2257"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2258"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2259"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2260"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2261"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2262"></td><td class="line-content">function setupMovingPlatforms(platform){</td></tr><tr><td class="line-number" value="2263"></td><td class="line-content">    game.physics.p2.enable(platform);</td></tr><tr><td class="line-number" value="2264"></td><td class="line-content">    platform.body.y += 16;  // we are replacing one tile with 4 so we need to adjust the position here</td></tr><tr><td class="line-number" value="2265"></td><td class="line-content">    platform.body.x += 64;</td></tr><tr><td class="line-number" value="2266"></td><td class="line-content">   // platform.body.setRectangle(platform.width,8,0,-12);</td></tr><tr><td class="line-number" value="2267"></td><td class="line-content">    platform.body.kinematic=true;</td></tr><tr><td class="line-number" value="2268"></td><td class="line-content">    platform.body.setCollisionGroup(platformCG);</td></tr><tr><td class="line-number" value="2269"></td><td class="line-content">    platform.body.collides([playerCG,fireballCG,enemyGroundCG]);</td></tr><tr><td class="line-number" value="2270"></td><td class="line-content">    platform.body.setMaterial(groundMaterial);</td></tr><tr><td class="line-number" value="2271"></td><td class="line-content">    platform.body.sprite.leftbounds = platform.body.x;</td></tr><tr><td class="line-number" value="2272"></td><td class="line-content">    platform.body.sprite.rightbounds = platform.body.x + parseInt(platform.body.sprite.distance);</td></tr><tr><td class="line-number" value="2273"></td><td class="line-content">    platform.body.sprite.topbounds = platform.body.y;</td></tr><tr><td class="line-number" value="2274"></td><td class="line-content">    platform.body.sprite.bottombounds = platform.body.y + parseInt(platform.body.sprite.distance);</td></tr><tr><td class="line-number" value="2275"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="2276"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2277"></td><td class="line-content">function  movePlatforms(platform){</td></tr><tr><td class="line-number" value="2278"></td><td class="line-content">    if (platform.body.sprite.name == 'horizontal'){</td></tr><tr><td class="line-number" value="2279"></td><td class="line-content">        if (platform.body.x &gt; platform.body.sprite.rightbounds){  platform.body.sprite.velo *= -1;}</td></tr><tr><td class="line-number" value="2280"></td><td class="line-content">        if (platform.body.x &lt; platform.body.sprite.leftbounds) { platform.body.sprite.velo *= -1;}</td></tr><tr><td class="line-number" value="2281"></td><td class="line-content">        platform.body.velocity.x = platform.body.sprite.velo;</td></tr><tr><td class="line-number" value="2282"></td><td class="line-content">    } else if (platform.body.sprite.name == 'vertical'){</td></tr><tr><td class="line-number" value="2283"></td><td class="line-content">        if (platform.body.y &gt; platform.body.sprite.bottombounds){  platform.body.sprite.velo *= -1;}</td></tr><tr><td class="line-number" value="2284"></td><td class="line-content">        if (platform.body.y &lt; platform.body.sprite.topbounds) { platform.body.sprite.velo *= -1;}</td></tr><tr><td class="line-number" value="2285"></td><td class="line-content">        platform.body.velocity.y = platform.body.sprite.velo;</td></tr><tr><td class="line-number" value="2286"></td><td class="line-content">    } </td></tr><tr><td class="line-number" value="2287"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="2288"></td><td class="line-content">    </td></tr><tr><td class="line-number" value="2289"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2290"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2291"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2292"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2293"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2294"></td><td class="line-content">function QuestionmarkIt(questionmark){</td></tr><tr><td class="line-number" value="2295"></td><td class="line-content">    game.physics.p2.enable(questionmark);</td></tr><tr><td class="line-number" value="2296"></td><td class="line-content">    questionmark.body.y += 32;  //since we are replacing a 32x32 tile with a 64x64 object we need to adjust</td></tr><tr><td class="line-number" value="2297"></td><td class="line-content">    questionmark.body.static=true;</td></tr><tr><td class="line-number" value="2298"></td><td class="line-content">    questionmark.body.sprite.name='coin';</td></tr><tr><td class="line-number" value="2299"></td><td class="line-content">    questionmark.body.setCollisionGroup(questionmarkCG);</td></tr><tr><td class="line-number" value="2300"></td><td class="line-content">    questionmark.body.collides([playerCG,fireballCG,powerupsCG]);</td></tr><tr><td class="line-number" value="2301"></td><td class="line-content">    questionmark.body.setMaterial(groundMaterial);</td></tr><tr><td class="line-number" value="2302"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="2303"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2304"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2305"></td><td class="line-content">function CallsignIt(callsign){</td></tr><tr><td class="line-number" value="2306"></td><td class="line-content">    game.physics.p2.enable(callsign);</td></tr><tr><td class="line-number" value="2307"></td><td class="line-content">    callsign.body.y += 32;   //since we are replacing a 32x32 tile with a 64x64 object we need to adjust</td></tr><tr><td class="line-number" value="2308"></td><td class="line-content">    callsign.body.static=true;</td></tr><tr><td class="line-number" value="2309"></td><td class="line-content">    callsign.body.sprite.name="growshroom";</td></tr><tr><td class="line-number" value="2310"></td><td class="line-content">    callsign.body.setCollisionGroup(questionmarkCG);</td></tr><tr><td class="line-number" value="2311"></td><td class="line-content">    callsign.body.collides([playerCG,fireballCG,powerupsCG]);</td></tr><tr><td class="line-number" value="2312"></td><td class="line-content">    callsign.body.setMaterial(groundMaterial);</td></tr><tr><td class="line-number" value="2313"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="2314"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2315"></td><td class="line-content">function AssetIt(asset){</td></tr><tr><td class="line-number" value="2316"></td><td class="line-content">    game.physics.p2.enable(asset);</td></tr><tr><td class="line-number" value="2317"></td><td class="line-content">    asset.body.y += 32;   //since we are replacing a 32x32 tile with a 64x64 object we need to adjust</td></tr><tr><td class="line-number" value="2318"></td><td class="line-content">    </td></tr><tr><td class="line-number" value="2319"></td><td class="line-content">    asset.body.static=true;</td></tr><tr><td class="line-number" value="2320"></td><td class="line-content">    asset.body.sprite.name="asset";</td></tr><tr><td class="line-number" value="2321"></td><td class="line-content">    asset.body.setCollisionGroup(questionmarkCG);</td></tr><tr><td class="line-number" value="2322"></td><td class="line-content">    asset.body.collides([playerCG,fireballCG,powerupsCG]);</td></tr><tr><td class="line-number" value="2323"></td><td class="line-content">    asset.body.setMaterial(groundMaterial);</td></tr><tr><td class="line-number" value="2324"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="2325"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2326"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2327"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2328"></td><td class="line-content">// what happens when you hit a questionmark, callsign or savepoint</td></tr><tr><td class="line-number" value="2329"></td><td class="line-content">function hitQuestionmark(player,questionmark) {</td></tr><tr><td class="line-number" value="2330"></td><td class="line-content">    if (questionmark.sprite.name == 'coin'){</td></tr><tr><td class="line-number" value="2331"></td><td class="line-content">        score += 10;</td></tr><tr><td class="line-number" value="2332"></td><td class="line-content">        scoreText.text = ' x '+score;  //update scoreText</td></tr><tr><td class="line-number" value="2333"></td><td class="line-content">        game.sound.play('coin');</td></tr><tr><td class="line-number" value="2334"></td><td class="line-content">        tmpcoin = game.add.sprite(questionmark.x, questionmark.y-64, 'coin',0);</td></tr><tr><td class="line-number" value="2335"></td><td class="line-content">        tmpcoin.scale.setTo(0.7,0.7);</td></tr><tr><td class="line-number" value="2336"></td><td class="line-content">        game.physics.p2.enable(tmpcoin);</td></tr><tr><td class="line-number" value="2337"></td><td class="line-content">        tmpcoin.body.velocity.y=-150;</td></tr><tr><td class="line-number" value="2338"></td><td class="line-content">        tmpcoin.body.collideWorldBounds=false;</td></tr><tr><td class="line-number" value="2339"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="2340"></td><td class="line-content">    else if (questionmark.sprite.name == 'growshroom'){</td></tr><tr><td class="line-number" value="2341"></td><td class="line-content">        game.sound.play('showpowerup');</td></tr><tr><td class="line-number" value="2342"></td><td class="line-content">        if (player.sprite.health &gt;= 2){</td></tr><tr><td class="line-number" value="2343"></td><td class="line-content">            powerup = game.add.sprite(questionmark.x, questionmark.y-64, 'powerups',2);</td></tr><tr><td class="line-number" value="2344"></td><td class="line-content">            powerup.name="fireflower";</td></tr><tr><td class="line-number" value="2345"></td><td class="line-content">            game.physics.p2.enable(powerup);</td></tr><tr><td class="line-number" value="2346"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="2347"></td><td class="line-content">        else {</td></tr><tr><td class="line-number" value="2348"></td><td class="line-content">            powerup = game.add.sprite(questionmark.x, questionmark.y-64, 'powerups',0);</td></tr><tr><td class="line-number" value="2349"></td><td class="line-content">            powerup.name="growshroom";</td></tr><tr><td class="line-number" value="2350"></td><td class="line-content">            game.physics.p2.enable(powerup);</td></tr><tr><td class="line-number" value="2351"></td><td class="line-content">            powerup.body.velocity.x=150;</td></tr><tr><td class="line-number" value="2352"></td><td class="line-content">            powerup.body.velocity.y=-150;</td></tr><tr><td class="line-number" value="2353"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="2354"></td><td class="line-content">        powerup.body.setCircle(30);</td></tr><tr><td class="line-number" value="2355"></td><td class="line-content">        powerup.body.allowSleep=true;</td></tr><tr><td class="line-number" value="2356"></td><td class="line-content">        powerup.body.fixedRotation=true; </td></tr><tr><td class="line-number" value="2357"></td><td class="line-content">        powerup.body.setMaterial(iceMaterial);</td></tr><tr><td class="line-number" value="2358"></td><td class="line-content">        powerup.body.setCollisionGroup(powerupsCG);</td></tr><tr><td class="line-number" value="2359"></td><td class="line-content">        powerup.body.collides([playerCG,groundCG,questionmarkCG]);</td></tr><tr><td class="line-number" value="2360"></td><td class="line-content">        powerup.body.collideWorldBounds=false;</td></tr><tr><td class="line-number" value="2361"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="2362"></td><td class="line-content">    else if (questionmark.sprite.name == 'savepoint'){</td></tr><tr><td class="line-number" value="2363"></td><td class="line-content">        savepointX = player.x;</td></tr><tr><td class="line-number" value="2364"></td><td class="line-content">        savepointY = player.y;</td></tr><tr><td class="line-number" value="2365"></td><td class="line-content">        saved = true;</td></tr><tr><td class="line-number" value="2366"></td><td class="line-content">        game.sound.play('savepoint',2);</td></tr><tr><td class="line-number" value="2367"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="2368"></td><td class="line-content">    else if (questionmark.sprite.name == 'asset'){</td></tr><tr><td class="line-number" value="2369"></td><td class="line-content">        game.sound.play('showpowerup');</td></tr><tr><td class="line-number" value="2370"></td><td class="line-content">       // if (player.sprite.chain == false){</td></tr><tr><td class="line-number" value="2371"></td><td class="line-content">            powerup = game.add.sprite(questionmark.x, questionmark.y-64, 'powerups',4);</td></tr><tr><td class="line-number" value="2372"></td><td class="line-content">            powerup.name="chain";</td></tr><tr><td class="line-number" value="2373"></td><td class="line-content">            game.physics.p2.enable(powerup);</td></tr><tr><td class="line-number" value="2374"></td><td class="line-content">       // }</td></tr><tr><td class="line-number" value="2375"></td><td class="line-content">        powerup.body.setCircle(30);</td></tr><tr><td class="line-number" value="2376"></td><td class="line-content">        powerup.body.allowSleep=true;</td></tr><tr><td class="line-number" value="2377"></td><td class="line-content">        powerup.body.fixedRotation=true; </td></tr><tr><td class="line-number" value="2378"></td><td class="line-content">        powerup.body.setMaterial(iceMaterial);</td></tr><tr><td class="line-number" value="2379"></td><td class="line-content">        powerup.body.setCollisionGroup(powerupsCG);</td></tr><tr><td class="line-number" value="2380"></td><td class="line-content">        powerup.body.collides([playerCG,groundCG,questionmarkCG]);</td></tr><tr><td class="line-number" value="2381"></td><td class="line-content">        powerup.body.collideWorldBounds=false;</td></tr><tr><td class="line-number" value="2382"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="2383"></td><td class="line-content">    </td></tr><tr><td class="line-number" value="2384"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2385"></td><td class="line-content">    questionmark.sprite.loadTexture('questionmark',0);  //change texture to block</td></tr><tr><td class="line-number" value="2386"></td><td class="line-content">    questionmark.setCollisionGroup(groundCG);  //behave as block</td></tr><tr><td class="line-number" value="2387"></td><td class="line-content">    questionmark.setMaterial(groundMaterial);</td></tr><tr><td class="line-number" value="2388"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="2389"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2390"></td><td class="line-content">function collectPowerup(player,powerup) {</td></tr><tr><td class="line-number" value="2391"></td><td class="line-content">    if (gamestate=='win' || gamestate=='lost' ){return;} //check if invincible or already finished</td></tr><tr><td class="line-number" value="2392"></td><td class="line-content">    hitboxchanged=true; </td></tr><tr><td class="line-number" value="2393"></td><td class="line-content">    if (powerup.sprite.name == 'growshroom') { </td></tr><tr><td class="line-number" value="2394"></td><td class="line-content">        game.sound.play('grow');</td></tr><tr><td class="line-number" value="2395"></td><td class="line-content">        powerup.sprite.kill();</td></tr><tr><td class="line-number" value="2396"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="2397"></td><td class="line-content">        if (player_health == 2) {</td></tr><tr><td class="line-number" value="2398"></td><td class="line-content">            score += 20;</td></tr><tr><td class="line-number" value="2399"></td><td class="line-content">            scoreText.text = ' x '+score;  //update scoreText</td></tr><tr><td class="line-number" value="2400"></td><td class="line-content">        }else{</td></tr><tr><td class="line-number" value="2401"></td><td class="line-content">            player.sprite.health += 1;  //do it now</td></tr><tr><td class="line-number" value="2402"></td><td class="line-content">            player_health += 1;         //store it for next level</td></tr><tr><td class="line-number" value="2403"></td><td class="line-content">            if (player.sprite.scale.x &lt; 0){x1=-1;x2=-0.8}else{x1=1;x2=0.8;}  //grow</td></tr><tr><td class="line-number" value="2404"></td><td class="line-content">            game.add.tween(player.sprite).to({alpha:0.4}, 200).to({alpha:1}, 200).to({alpha:0.4}, 200).to({alpha:1}, 200).start().onComplete.add(function (){player.sprite.scale.setTo(x1,1)});</td></tr><tr><td class="line-number" value="2405"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="2406"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="2407"></td><td class="line-content">    } </td></tr><tr><td class="line-number" value="2408"></td><td class="line-content">    else if (powerup.sprite.name == 'fireflower') { </td></tr><tr><td class="line-number" value="2409"></td><td class="line-content">		</td></tr><tr><td class="line-number" value="2410"></td><td class="line-content">        powerup.sprite.kill();</td></tr><tr><td class="line-number" value="2411"></td><td class="line-content">        if (player_health == 3) {</td></tr><tr><td class="line-number" value="2412"></td><td class="line-content">			game.sound.play('coin');</td></tr><tr><td class="line-number" value="2413"></td><td class="line-content">            score += 20;</td></tr><tr><td class="line-number" value="2414"></td><td class="line-content">            scoreText.text = ' x '+score;  //update scoreText</td></tr><tr><td class="line-number" value="2415"></td><td class="line-content">        }else{</td></tr><tr><td class="line-number" value="2416"></td><td class="line-content">			game.sound.play('grow');</td></tr><tr><td class="line-number" value="2417"></td><td class="line-content">            if (player_health == 1){  //special case where flower is already visible but then player got hit and shrinked - act as mushroom</td></tr><tr><td class="line-number" value="2418"></td><td class="line-content">                if (player.sprite.scale.x &lt; 0){x1=-1;x2=-0.8}else{x1=1;x2=0.8;}  //grow</td></tr><tr><td class="line-number" value="2419"></td><td class="line-content">                game.add.tween(player.sprite).to({alpha:0.4}, 200).to({alpha:1}, 200).to({alpha:0.4}, 200).to({alpha:1}, 200).start().onComplete.add(function (){player.sprite.scale.setTo(x1,1)});</td></tr><tr><td class="line-number" value="2420"></td><td class="line-content">            }else{</td></tr><tr><td class="line-number" value="2421"></td><td class="line-content">                setupPlayerLooks(player.sprite,'mariowhite');   //change to white mario</td></tr><tr><td class="line-number" value="2422"></td><td class="line-content">                destroyWeapon(weapon_selected);</td></tr><tr><td class="line-number" value="2423"></td><td class="line-content">				weapon_selected = 'fireflower';  </td></tr><tr><td class="line-number" value="2424"></td><td class="line-content">				createWeapon(weapon_selected);</td></tr><tr><td class="line-number" value="2425"></td><td class="line-content">            }</td></tr><tr><td class="line-number" value="2426"></td><td class="line-content">            player.sprite.health += 1;  //do it now</td></tr><tr><td class="line-number" value="2427"></td><td class="line-content">            player_health += 1;         //store it for next level</td></tr><tr><td class="line-number" value="2428"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="2429"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="2430"></td><td class="line-content">	else if (powerup.sprite.name == 'chain') { </td></tr><tr><td class="line-number" value="2431"></td><td class="line-content">        game.sound.play('grow');</td></tr><tr><td class="line-number" value="2432"></td><td class="line-content">        powerup.sprite.kill();</td></tr><tr><td class="line-number" value="2433"></td><td class="line-content">        if (player.chain == true) {</td></tr><tr><td class="line-number" value="2434"></td><td class="line-content">            score += 20;</td></tr><tr><td class="line-number" value="2435"></td><td class="line-content">            scoreText.text = ' x '+score;  //update scoreText</td></tr><tr><td class="line-number" value="2436"></td><td class="line-content">        }else{</td></tr><tr><td class="line-number" value="2437"></td><td class="line-content">			player_chain = true;  //store for later use when player is recreated on state change for example</td></tr><tr><td class="line-number" value="2438"></td><td class="line-content">            player.chain = true;</td></tr><tr><td class="line-number" value="2439"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="2440"></td><td class="line-content">    }		</td></tr><tr><td class="line-number" value="2441"></td><td class="line-content">    else if (powerup.sprite.name == 'shroomoflife') {   // extra life</td></tr><tr><td class="line-number" value="2442"></td><td class="line-content">        game.sound.play('1up');</td></tr><tr><td class="line-number" value="2443"></td><td class="line-content">        powerup.sprite.kill();</td></tr><tr><td class="line-number" value="2444"></td><td class="line-content">        game.sound.play('1up'); </td></tr><tr><td class="line-number" value="2445"></td><td class="line-content">        player_lives +=1; </td></tr><tr><td class="line-number" value="2446"></td><td class="line-content">    //draw new heart</td></tr><tr><td class="line-number" value="2447"></td><td class="line-content">        heart = game.add.sprite(34*player_lives,32,'ui',1)</td></tr><tr><td class="line-number" value="2448"></td><td class="line-content">        heart.anchor.setTo(0.5,0.5);</td></tr><tr><td class="line-number" value="2449"></td><td class="line-content">        heart.fixedToCamera=true;</td></tr><tr><td class="line-number" value="2450"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="2451"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="2452"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2453"></td><td class="line-content">function createGhost(x,y){</td></tr><tr><td class="line-number" value="2454"></td><td class="line-content">    ghost = enemies.create(x, y, 'ghosttransparent'); </td></tr><tr><td class="line-number" value="2455"></td><td class="line-content">    ghost.health=10;  </td></tr><tr><td class="line-number" value="2456"></td><td class="line-content">    ghost.name = "ghost";</td></tr><tr><td class="line-number" value="2457"></td><td class="line-content">    ghost.mass = 0.4</td></tr><tr><td class="line-number" value="2458"></td><td class="line-content">    ghost.body.setCircle(100);</td></tr><tr><td class="line-number" value="2459"></td><td class="line-content">    ghost.body.fixedRotation=true;</td></tr><tr><td class="line-number" value="2460"></td><td class="line-content">    ghost.body.collideWorldBounds=false;</td></tr><tr><td class="line-number" value="2461"></td><td class="line-content">    ghost.body.allowSleep=true;</td></tr><tr><td class="line-number" value="2462"></td><td class="line-content">    ghost.body.setCollisionGroup(enemyAirCG);</td></tr><tr><td class="line-number" value="2463"></td><td class="line-content">    ghost.body.collides([playerCG]);</td></tr><tr><td class="line-number" value="2464"></td><td class="line-content">    ghost.body.data.gravityScale=0;</td></tr><tr><td class="line-number" value="2465"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="2466"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2467"></td><td class="line-content">function createChain(length, xAnchor,yAnchor){</td></tr><tr><td class="line-number" value="2468"></td><td class="line-content">    var lastRect;  //if we created our first rect this will contain it</td></tr><tr><td class="line-number" value="2469"></td><td class="line-content">    var height = 20;  //height for the physics body - your image height is 8px</td></tr><tr><td class="line-number" value="2470"></td><td class="line-content">    var width = 16;   //this is the width for the physics body.. if to small the rectangles will get scrambled together</td></tr><tr><td class="line-number" value="2471"></td><td class="line-content">    var maxForce =15000;  //the force that holds the rectangles together</td></tr><tr><td class="line-number" value="2472"></td><td class="line-content">    for(var i=0; i&lt;=length; i++){</td></tr><tr><td class="line-number" value="2473"></td><td class="line-content">        var x = xAnchor;                 // all rects are on the same x position</td></tr><tr><td class="line-number" value="2474"></td><td class="line-content">        var y = yAnchor+(i*height);   // every new rects is positioned below the last</td></tr><tr><td class="line-number" value="2475"></td><td class="line-content">        if (i%2==0){newRect = chains.create(x, y, 'chain',1);}   //add sprite</td></tr><tr><td class="line-number" value="2476"></td><td class="line-content">        else {newRect = chains.create(x, y, 'chain',0); lastRect.bringToTop();}</td></tr><tr><td class="line-number" value="2477"></td><td class="line-content">        newRect.name = 'chainElement';</td></tr><tr><td class="line-number" value="2478"></td><td class="line-content">        game.physics.p2.enable(newRect,false);      // enable physicsbody</td></tr><tr><td class="line-number" value="2479"></td><td class="line-content">        newRect.body.setRectangle(width,height);    //set custom rectangle</td></tr><tr><td class="line-number" value="2480"></td><td class="line-content">        newRect.body.data.shapes[0].sensor = true  // make the chain elements to sensors (no actual collision but collision events)</td></tr><tr><td class="line-number" value="2481"></td><td class="line-content">        if (i%2==1){  // less collsion bodies to calculate and the first one is fixed</td></tr><tr><td class="line-number" value="2482"></td><td class="line-content">            newRect.body.setCollisionGroup(groundCG);</td></tr><tr><td class="line-number" value="2483"></td><td class="line-content">            newRect.body.collides([playerCG,fireballCG,groundCG]);</td></tr><tr><td class="line-number" value="2484"></td><td class="line-content">            newRect.body.onBeginContact.add(chainCollision,newRect);  // call chaincollision function to start "hangmode"</td></tr><tr><td class="line-number" value="2485"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="2486"></td><td class="line-content">        if (i==0){</td></tr><tr><td class="line-number" value="2487"></td><td class="line-content">            newRect.body.static=true;   //anchor the first one created</td></tr><tr><td class="line-number" value="2488"></td><td class="line-content">//          newRect.body.kinematic=true;</td></tr><tr><td class="line-number" value="2489"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="2490"></td><td class="line-content">        else{</td></tr><tr><td class="line-number" value="2491"></td><td class="line-content">            newRect.body.mass =  length/i;  // reduce mass for evey chain element</td></tr><tr><td class="line-number" value="2492"></td><td class="line-content">        }</td></tr><tr><td class="line-number" value="2493"></td><td class="line-content">        //after the first rectangle is created we can add the constraint</td></tr><tr><td class="line-number" value="2494"></td><td class="line-content">        if(lastRect){game.physics.p2.createRevoluteConstraint(newRect, [0,-10], lastRect, [0,10], maxForce);}</td></tr><tr><td class="line-number" value="2495"></td><td class="line-content">        lastRect = newRect;</td></tr><tr><td class="line-number" value="2496"></td><td class="line-content">    }; </td></tr><tr><td class="line-number" value="2497"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="2498"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2499"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2500"></td><td class="line-content">function chainCollision(body){</td></tr><tr><td class="line-number" value="2501"></td><td class="line-content">    if (body.sprite.name == 'mario' &amp;&amp; hanging== false &amp;&amp; hangTimer &lt; game.time.now &amp;&amp; docked == false) {   //if the hit body is a sprite and belongs to enemies</td></tr><tr><td class="line-number" value="2502"></td><td class="line-content">        chainElement=this;   // we send newRect instead of this in the onBeginContact function and here the chain element is accessable as this</td></tr><tr><td class="line-number" value="2503"></td><td class="line-content">        chainElement.body.velocity.x=body.velocity.x*-50;  //on collision we need an initial drive for more realistic action</td></tr><tr><td class="line-number" value="2504"></td><td class="line-content">        hanging = true;</td></tr><tr><td class="line-number" value="2505"></td><td class="line-content">        playerChainRC = game.physics.p2.createRevoluteConstraint(chainElement, [0,0],player, [0,8], 10000)</td></tr><tr><td class="line-number" value="2506"></td><td class="line-content">        player.body.data.gravityScale=0;</td></tr><tr><td class="line-number" value="2507"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="2508"></td><td class="line-content">} </td></tr><tr><td class="line-number" value="2509"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2510"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2511"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2512"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2513"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2514"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2515"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2516"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2517"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2518"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2519"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2520"></td><td class="line-content">function finishWorld(player,coin) {  // level finished</td></tr><tr><td class="line-number" value="2521"></td><td class="line-content">    if (gamestate != 'win'){</td></tr><tr><td class="line-number" value="2522"></td><td class="line-content">        if (coin){    coin.sprite.kill();}</td></tr><tr><td class="line-number" value="2523"></td><td class="line-content">        music.pause();</td></tr><tr><td class="line-number" value="2524"></td><td class="line-content">        game.sound.play('clear');</td></tr><tr><td class="line-number" value="2525"></td><td class="line-content">        gamestate = "win";</td></tr><tr><td class="line-number" value="2526"></td><td class="line-content">        </td></tr><tr><td class="line-number" value="2527"></td><td class="line-content">        destroyWeapon(weapon_selected);</td></tr><tr><td class="line-number" value="2528"></td><td class="line-content">            </td></tr><tr><td class="line-number" value="2529"></td><td class="line-content">        fadeoutSprite=game.add.image(player.x, player.y, 'circlemask');</td></tr><tr><td class="line-number" value="2530"></td><td class="line-content">        fadeoutSprite.anchor.setTo(0.5,0.5);</td></tr><tr><td class="line-number" value="2531"></td><td class="line-content">        fadeoutSprite.scale.setTo(4,4);</td></tr><tr><td class="line-number" value="2532"></td><td class="line-content">        fadeoutSprite.alpha=0;</td></tr><tr><td class="line-number" value="2533"></td><td class="line-content">        timer = 0;</td></tr><tr><td class="line-number" value="2534"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2535"></td><td class="line-content">        saved = false;  //disable savepoint</td></tr><tr><td class="line-number" value="2536"></td><td class="line-content">        player.data.motionState=2;  //make it static</td></tr><tr><td class="line-number" value="2537"></td><td class="line-content">        player.clearCollision(true,true);</td></tr><tr><td class="line-number" value="2538"></td><td class="line-content">        var first=game.add.tween(player.sprite).to({angle : 360}, 1500).start(); //animate player movements</td></tr><tr><td class="line-number" value="2539"></td><td class="line-content">        var second=game.add.tween(player.sprite).delay(6000).start().onComplete.add(wingame, this);  // this basically does nothing more than a delay and then ends the game</td></tr><tr><td class="line-number" value="2540"></td><td class="line-content">    }</td></tr><tr><td class="line-number" value="2541"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="2542"></td><td class="line-content">function wingame(){</td></tr><tr><td class="line-number" value="2543"></td><td class="line-content">    game.time.events.remove(timerEvents[0]);   //make a for loop !!  clears all game timers otherwise they would run along</td></tr><tr><td class="line-number" value="2544"></td><td class="line-content">    game.time.events.remove(timerEvents[1]);</td></tr><tr><td class="line-number" value="2545"></td><td class="line-content">    game.time.events.remove(timerEvents[2]);</td></tr><tr><td class="line-number" value="2546"></td><td class="line-content">    level +=1;</td></tr><tr><td class="line-number" value="2547"></td><td class="line-content">    if (level == levels+1){ game.state.start('endgame', true, false);  }</td></tr><tr><td class="line-number" value="2548"></td><td class="line-content">    else { game.state.start('win',true,false); }</td></tr><tr><td class="line-number" value="2549"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="2550"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2551"></td><td class="line-content">//funktion fr den startbutton</td></tr><tr><td class="line-number" value="2552"></td><td class="line-content">function startNextLevel () {</td></tr><tr><td class="line-number" value="2553"></td><td class="line-content">    game.time.events.remove(timerEvents[0]);   //make a for loop !!  clears all game timers otherwise they would run along</td></tr><tr><td class="line-number" value="2554"></td><td class="line-content">    game.time.events.remove(timerEvents[1]);</td></tr><tr><td class="line-number" value="2555"></td><td class="line-content">    game.time.events.remove(timerEvents[2]);</td></tr><tr><td class="line-number" value="2556"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2557"></td><td class="line-content">    //unlock current accomplished level here !!</td></tr><tr><td class="line-number" value="2558"></td><td class="line-content">    </td></tr><tr><td class="line-number" value="2559"></td><td class="line-content">    // lost a life</td></tr><tr><td class="line-number" value="2560"></td><td class="line-content">    if (gamestate == 'lost'){</td></tr><tr><td class="line-number" value="2561"></td><td class="line-content">		destroyWeapon(weapon_selected);  // destroy the weapon - otherwise there'll be two of them on restart</td></tr><tr><td class="line-number" value="2562"></td><td class="line-content">		weapon_selected = 'sword';  // you died.. you lost your weapons - back to default</td></tr><tr><td class="line-number" value="2563"></td><td class="line-content">	}</td></tr><tr><td class="line-number" value="2564"></td><td class="line-content">    //game over  - do not unlock just go back to levelmenu</td></tr><tr><td class="line-number" value="2565"></td><td class="line-content">    if ( player_lives == 0){ game.state.start('endgame', true, false);  } </td></tr><tr><td class="line-number" value="2566"></td><td class="line-content">    else { game.state.start(''+level+'', true, false); }</td></tr><tr><td class="line-number" value="2567"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="2568"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2569"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2570"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2571"></td><td class="line-content">Math.radians = function(degrees) {</td></tr><tr><td class="line-number" value="2572"></td><td class="line-content">  return degrees * Math.PI/180;</td></tr><tr><td class="line-number" value="2573"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="2574"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2575"></td><td class="line-content">Math.degrees = function(radians) {</td></tr><tr><td class="line-number" value="2576"></td><td class="line-content">  return radians * 180/Math.PI;</td></tr><tr><td class="line-number" value="2577"></td><td class="line-content">}</td></tr><tr><td class="line-number" value="2578"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2579"></td><td class="line-content">// initialize game</td></tr><tr><td class="line-number" value="2580"></td><td class="line-content">var game = new Phaser.Game(worldwidth, worldheight, Phaser.CANVAS, 'gamediv');</td></tr><tr><td class="line-number" value="2581"></td><td class="line-content">// add gamestates</td></tr><tr><td class="line-number" value="2582"></td><td class="line-content">game.state.add('boot', BootState, true);</td></tr><tr><td class="line-number" value="2583"></td><td class="line-content">game.state.add('preload', PreloadState, false);</td></tr><tr><td class="line-number" value="2584"></td><td class="line-content">game.state.add('0', Level0, false);</td></tr><tr><td class="line-number" value="2585"></td><td class="line-content">game.state.add('1', Level1, false);</td></tr><tr><td class="line-number" value="2586"></td><td class="line-content">game.state.add('2', Level2, false);</td></tr><tr><td class="line-number" value="2587"></td><td class="line-content">game.state.add('3', Level3, false);</td></tr><tr><td class="line-number" value="2588"></td><td class="line-content">game.state.add('4', Level4, false);</td></tr><tr><td class="line-number" value="2589"></td><td class="line-content">game.state.add('5', Level5, false);</td></tr><tr><td class="line-number" value="2590"></td><td class="line-content">game.state.add('6', Level6, false);</td></tr><tr><td class="line-number" value="2591"></td><td class="line-content">game.state.add('7', LastLevel, false);</td></tr><tr><td class="line-number" value="2592"></td><td class="line-content">game.state.add('win', Finish, false);</td></tr><tr><td class="line-number" value="2593"></td><td class="line-content">game.state.add('endgame', EndGame, false);</td></tr><tr><td class="line-number" value="2594"></td><td class="line-content">game.state.add('menu', Menu, false);</td></tr><tr><td class="line-number" value="2595"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2596"></td><td class="line-content"><span class="html-tag">&lt;/script&gt;</span></td></tr><tr><td class="line-number" value="2597"></td><td class="line-content"><span class="html-tag">&lt;/body&gt;</span></td></tr><tr><td class="line-number" value="2598"></td><td class="line-content"><span class="html-tag">&lt;/html&gt;</span></td></tr><tr><td class="line-number" value="2599"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2600"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2601"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2602"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2603"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2604"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2605"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2606"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2607"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2608"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2609"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2610"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2611"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2612"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2613"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2614"></td><td class="line-content"></td></tr><tr><td class="line-number" value="2615"></td><td class="line-content"><span class="html-end-of-file"></span></td></tr></tbody></table></body></html>